{% extends 'core/base.html' %}

{% block title %}Sistema de Cronograma de Mantenimiento{% endblock %}

{% block extra_head %}
<style>
    .calendar-day {
        background: white;
        border: 2px solid var(--border);
        border-radius: 12px;
        min-height: 120px;
        padding: 0.75rem;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        cursor: pointer;
        position: relative;
    }

    .calendar-day:hover {
        border-color: var(--blue);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        transform: translateY(-2px);
    }

    .calendar-day.weekend {
        background: #f8f9fa;
        opacity: 0.6;
    }

    .calendar-day.holiday {
        background: #fef3c7;
        border-color: #f59e0b;
    }

    .calendar-day.other-month {
        opacity: 0.3;
        pointer-events: none;
    }

    .calendar-day.today .day-number {
        background: var(--blue);
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
    }

    /* Shift count badge */
    .shift-count-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 24px;
        height: 24px;
        padding: 0 8px;
        background: var(--blue-pastel);
        color: var(--blue-text);
        border-radius: 12px;
        font-size: 11px;
        font-weight: 800;
        letter-spacing: -0.02em;
    }

    .shift-count-badge.has-completed {
        background: var(--green-pastel);
        color: var(--green-text);
    }

    .shift-count-badge.has-in-progress {
        background: var(--yellow-pastel);
        color: var(--yellow-text);
    }



    /* Drag & Drop states */
    .calendar-day.drag-over {
        border-color: var(--blue);
        background: var(--blue-pastel);
        border-width: 3px;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .calendar-day.drag-source {
        opacity: 0.5;
    }

    /* Shift cards in detail panel */
    .appointment-card {
        background: var(--blue-pastel);
        color: var(--blue-text);
        padding: 0.75rem;
        border-radius: 12px;
        cursor: move;
        font-size: 0.875rem;
        border: 2px solid rgba(30, 64, 175, 0.15);
        transition: all 0.2s ease;
    }

    .appointment-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(30, 64, 175, 0.25);
    }

    .appointment-card.completed {
        background: var(--green-pastel);
        color: var(--green-text);
        border-color: rgba(6, 95, 70, 0.15);
    }

    .appointment-card.in-progress {
        background: var(--yellow-pastel);
        color: var(--yellow-text);
        border-color: rgba(146, 64, 14, 0.15);
    }

    .appointment-card.dragging {
        opacity: 0.5;
        transform: rotate(2deg);
    }

    /* WIZARD STYLES */
    .wizard-step-node {
        display: none !important;
    }

    .wizard-step-node.active-step {
        display: flex !important;
    }
</style>
<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
{% endblock %}

{% block content %}
<!-- TOAST NOTIFICATIONS -->
<div id="toastContainer" class="fixed top-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none"></div>

<!-- MAIN LAYOUT CONTAINER -->
<div class="flex h-screen overflow-hidden bg-gray-50/50">

    <!-- 1. LEFT SIDEBAR (Config & Tools) -->
    <aside id="leftSidebar"
        class="w-80 bg-white border-r border-gray-200 flex flex-col transition-all duration-300 z-30 relative">
        <!-- Sidebar Header -->
        <div class="p-6 border-b border-gray-100 flex justify-between items-start">
            <div>
                <h2 class="text-xl font-black tracking-tight text-indigo-900">SistemaTurnos</h2>
                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mt-1">GESTI√ìN DE CRONOGRAMAS</p>
            </div>
            <button onclick="toggleSidebar()" class="lg:hidden text-gray-400 hover:text-gray-600">
                <i data-lucide="chevrons-left" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- RESET BUTTON -->
        <div class="px-6 py-4 bg-rose-50/30 border-b border-rose-50">
            <button onclick="resetEverything()"
                class="w-full py-2.5 px-4 rounded-xl border border-rose-100 bg-white text-rose-600 text-[10px] font-black uppercase tracking-widest hover:bg-rose-600 hover:text-white transition-all flex items-center justify-center gap-2 group shadow-sm">
                <i data-lucide="refresh-ccw"
                    class="w-3.5 h-3.5 group-hover:rotate-180 transition-transform duration-500"></i>
                Reiniciar Cronograma
            </button>
        </div>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto custom-scrollbar">


            <!-- STEP 1: IMPORTAR DATOS -->
            <div id="step1Container" class="p-6 border-b border-gray-50">
                <div class="flex items-center gap-3 mb-6">
                    <div id="step1Indicator"
                        class="size-8 bg-indigo-600 text-white rounded-full flex items-center justify-center font-black text-sm">
                        1</div>
                    <h3 class="text-xs font-black text-indigo-800 uppercase tracking-widest">Importar Datos</h3>
                </div>

                <form action="{% url 'upload_excel' %}" method="POST" enctype="multipart/form-data" id="uploadForm"
                    class="relative border-2 border-dashed border-gray-100 rounded-2xl p-8 transition-all hover:bg-indigo-50/30 hover:border-indigo-200 group text-center"
                    ondragover="handleUploadDragOver(event)" ondragleave="handleUploadDragLeave(event)"
                    ondrop="handleUploadDrop(event)">
                    {% csrf_token %}
                    <input type="file" name="archivo" id="fileInput" class="hidden" onchange="submitUpload()">
                    <div class="cursor-pointer" onclick="document.getElementById('fileInput').click()">
                        <div class="mb-4 group-hover:scale-110 transition-transform inline-block">
                            <i data-lucide="folder" class="w-10 h-10 text-amber-400 fill-amber-400/20"></i>
                        </div>
                        <p id="uploadText" class="text-xs font-bold text-slate-700">Subir Excel de Mantenimientos</p>
                        <p class="text-[10px] text-slate-400 mt-1">Arrastra tu archivo o haz clic para seleccionar</p>
                        <p id="fileName" class="text-[10px] text-indigo-600 font-black mt-2 truncate hidden"></p>
                    </div>
                </form>

                <!-- BOT√ìN GU√çA DE FORMATO -->
                <button onclick="openExcelFormatModal()"
                    class="w-full mt-4 p-3 bg-indigo-50 border border-indigo-100 rounded-xl text-[10px] font-black uppercase text-indigo-600 hover:bg-indigo-600 hover:text-white transition-all flex items-center justify-center gap-2 group shadow-sm">
                    <i data-lucide="help-circle" class="w-4 h-4 group-hover:rotate-12 transition-transform"></i>
                    Ver Gu√≠a de Formato Excel
                </button>
            </div>

            <!-- STEP 2: CONFIGURAR PAR√ÅMETROS -->
            <div id="step2Container" class="p-6 border-b border-gray-50 bg-slate-50/30 transition-all duration-500">
                <div class="flex items-center gap-3 mb-6">
                    <div id="step2Indicator"
                        class="size-8 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center font-black text-sm">
                        2</div>
                    <h3 class="text-xs font-black text-gray-500 uppercase tracking-widest">Configurar Par√°metros</h3>
                </div>

                <form id="configForm" class="space-y-3">
                    <!-- ACCORDION 1: PERIODO -->
                    <div
                        class="bg-white rounded-xl border border-slate-100 shadow-sm overflow-hidden transition-all duration-300">
                        <button type="button" onclick="toggleAccordion('periodoContent')"
                            class="w-full p-4 flex items-center justify-between group">
                            <div class="flex items-center gap-2.5">
                                <span
                                    class="size-5 bg-indigo-50 text-indigo-500 rounded flex items-center justify-center">
                                    <i data-lucide="calendar" class="w-3.5 h-3.5"></i>
                                </span>
                                <span class="text-[11px] font-bold text-slate-700 uppercase tracking-wide">Per√≠odo del
                                    Cronograma</span>
                            </div>
                            <i data-lucide="chevron-up" class="w-4 h-4 text-slate-400 transition-transform"
                                id="periodoArrow"></i>
                        </button>
                        <div id="periodoContent" class="p-4 pt-0 space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <div class="space-y-1.5">
                                    <label for="fechaInicio"
                                        class="text-[10px] font-bold text-slate-400 uppercase ml-1">Fecha Inicio</label>
                                    <input type="date" name="fecha_inicio" id="fechaInicio"
                                        value="{% if config %}{{ config.fecha_inicio|date:'Y-m-d' }}{% endif %}"
                                        class="w-full text-xs font-bold text-slate-700 bg-slate-50 border-transparent rounded-lg focus:ring-2 focus:ring-indigo-500/20 focus:bg-white transition-all">
                                </div>
                                <div class="space-y-1.5">
                                    <label for="fechaFin"
                                        class="text-[10px] font-bold text-slate-400 uppercase ml-1">Fecha Fin</label>
                                    <input type="date" name="fecha_fin" id="fechaFin"
                                        value="{% if config %}{{ config.fecha_fin|date:'Y-m-d' }}{% endif %}"
                                        class="w-full text-xs font-bold text-slate-700 bg-slate-50 border-transparent rounded-lg focus:ring-2 focus:ring-indigo-500/20 focus:bg-white transition-all">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ACCORDION 2: HORARIOS -->
                    <div
                        class="bg-white rounded-xl border border-slate-100 shadow-sm overflow-hidden transition-all duration-300">
                        <button type="button" onclick="toggleAccordion('horariosContent')"
                            class="w-full p-4 flex items-center justify-between group">
                            <div class="flex items-center gap-2.5">
                                <span
                                    class="size-5 bg-amber-50 text-amber-500 rounded flex items-center justify-center">
                                    <i data-lucide="clock" class="w-3.5 h-3.5"></i>
                                </span>
                                <span class="text-[11px] font-bold text-slate-700 uppercase tracking-wide">Horarios de
                                    Trabajo</span>
                            </div>
                            <i data-lucide="chevron-up" class="w-4 h-4 text-slate-400 transition-transform rotate-0"
                                id="horariosArrow"></i>
                        </button>
                        <div id="horariosContent" class="p-4 pt-0 space-y-4">
                            <div class="grid grid-cols-1 gap-4">
                                <div class="space-y-1.5">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Inicio
                                        Jornada</label>
                                    <input type="time" name="hora_inicio" id="horaInicio"
                                        value="{% if config %}{{ config.hora_inicio|time:'H:i' }}{% else %}08:00{% endif %}"
                                        class="w-full text-xs font-bold text-slate-700 bg-slate-50 border-transparent rounded-lg focus:ring-2 focus:ring-indigo-500/20 focus:bg-white transition-all">
                                </div>
                                <div class="space-y-1.5">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Fin
                                        Jornada</label>
                                    <input type="time" name="hora_fin" id="horaFin"
                                        value="{% if config %}{{ config.hora_fin|time:'H:i' }}{% else %}17:00{% endif %}"
                                        class="w-full text-xs font-bold text-slate-700 bg-slate-50 border-transparent rounded-lg focus:ring-2 focus:ring-indigo-500/20 focus:bg-white transition-all">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="space-y-1.5">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Turno
                                        (min)</label>
                                    <input type="number" name="duracion_turno" id="duracionTurno"
                                        value="{% if config %}{{ config.duracion_turno }}{% else %}30{% endif %}"
                                        class="w-full text-xs font-bold text-slate-700 bg-slate-50 border-transparent rounded-lg focus:ring-2 focus:ring-indigo-500/20 focus:bg-white transition-all">
                                </div>
                                <div class="space-y-1.5">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Almuerzo
                                        (min)</label>
                                    <input type="number" name="duracion_almuerzo" id="duracionAlmuerzo"
                                        value="{% if config %}{{ config.duracion_almuerzo }}{% else %}60{% endif %}"
                                        class="w-full text-xs font-bold text-slate-700 bg-slate-50 border-transparent rounded-lg focus:ring-2 focus:ring-indigo-500/20 focus:bg-white transition-all">
                                </div>
                            </div>
                            <div class="space-y-1.5">
                                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Inicio
                                    Almuerzo</label>
                                <input type="time" name="hora_almuerzo" id="horaAlmuerzo"
                                    value="{% if config %}{{ config.hora_almuerzo|time:'H:i' }}{% else %}12:00{% endif %}"
                                    class="w-full text-xs font-bold text-slate-700 bg-slate-50 border-transparent rounded-lg focus:ring-2 focus:ring-indigo-500/20 focus:bg-white transition-all">
                            </div>
                        </div>
                    </div>

                    <!-- ACCORDION 3: DIAS LABORABLES -->
                    <div
                        class="bg-white rounded-xl border border-slate-100 shadow-sm overflow-hidden transition-all duration-300">
                        <button type="button" onclick="toggleAccordion('diasContent')"
                            class="w-full p-4 flex items-center justify-between group">
                            <div class="flex items-center gap-2.5">
                                <span
                                    class="size-5 bg-indigo-50 text-indigo-500 rounded flex items-center justify-center">
                                    <i data-lucide="calendar-days" class="w-3.5 h-3.5"></i>
                                </span>
                                <span class="text-[11px] font-bold text-slate-700 uppercase tracking-wide">D√≠as Laborables</span>
                            </div>
                            <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 transition-transform" id="diasArrow"></i>
                        </button>
                        <div id="diasContent" class="p-4 pt-0 hidden">
                            <select name="modo_exclusion" id="modoExclusion" class="w-full text-xs font-bold text-slate-700 bg-slate-50 border-transparent rounded-lg focus:ring-2 focus:ring-indigo-500/20">
                                <option value="none" {% if config and config.modo_exclusion == 'none' %}selected{% endif %}>Todos los d√≠as</option>
                                <option value="sundays" {% if config and config.modo_exclusion == 'sundays' %}selected{% endif %}>Lun a S√°b (Excluir Dom)</option>
                                <option value="weekends" {% if not config or config.modo_exclusion == 'weekends' %}selected{% endif %}>Lun a Vie (Excluir Fines)</option>
                            </select>
                        </div>
                    </div>

                    <!-- ACCORDION 4: FERIADOS -->
                    <div class="bg-white rounded-xl border border-slate-100 shadow-sm overflow-hidden transition-all duration-300">
                        <button type="button" onclick="toggleAccordion('feriadosContent')" class="w-full p-4 flex items-center justify-between group">
                            <div class="flex items-center gap-2.5">
                                <span class="size-5 bg-rose-50 text-rose-500 rounded flex items-center justify-center">
                                    <i data-lucide="sparkles" class="w-3.5 h-3.5"></i>
                                </span>
                                <span class="text-[11px] font-bold text-slate-700 uppercase tracking-wide">Feriados</span>
                            </div>
                            <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 transition-transform" id="feriadosArrow"></i>
                        </button>
                        <div id="feriadosContent" class="p-4 pt-0 hidden space-y-3">
                            <div class="flex gap-2">
                                <input type="date" id="newHolidayDate" class="flex-1 text-xs font-bold text-slate-700 bg-slate-50 border-transparent rounded-lg" aria-label="Fecha feriado">
                                <button type="button" onclick="addFeriado()" class="bg-indigo-600 text-white rounded-lg px-3 font-bold hover:bg-indigo-700 transition">+</button>
                            </div>
                            <div class="flex flex-wrap gap-1.5" id="holidaysList">
                                {% for f in feriados %}
                                <span class="bg-slate-50 border border-slate-100 text-slate-600 text-[10px] px-2 py-1.5 rounded-lg font-bold flex items-center gap-1.5">
                                    {{ f.fecha|date:"d/m" }}
                                    <button onclick="removeFeriado('{{ f.fecha|date:'Y-m-d' }}')" class="hover:text-rose-500 transition">√ó</button>
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- STEP 3: GENERAR CRONOGRAMA -->
            <div class="p-6 bg-slate-50/50">
                <div class="flex items-center gap-3 mb-6">
                    <div id="step3Indicator" class="size-8 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center font-black text-sm">3</div>
                    <h3 class="text-xs font-black text-gray-500 uppercase tracking-widest">Generar Cronograma</h3>
                </div>

                <div class="space-y-4 text-center">
                    <button onclick="generarCronograma()"
                        class="w-full py-4 bg-slate-200 text-gray-400 rounded-2xl font-black text-sm uppercase tracking-widest cursor-not-allowed transition-all flex items-center justify-center gap-3 shadow-sm" id="btnGenerarTodo">
                        <i data-lucide="rocket" class="w-5 h-5 opacity-40"></i> Crear Calendario
                    </button>
                    <p class="text-[10px] text-slate-400 font-bold leading-relaxed px-4">
                        Se guardar√° la configuraci√≥n y generar√° el cronograma autom√°ticamente
                    </p>
                </div>
            </div>

        </div>

    </aside>

    <!-- 2. MAIN CALENDAR AREA -->
    <main class="flex-1 flex flex-col min-w-0 bg-gray-50/50 relative">

        <!-- WARNING BANNER -->
        <div id="topWarningBanner" class="px-8 pt-6 pb-2">
            <div
                class="bg-[#FFF8E1] border-l-4 border-[#FFA000] rounded-r-xl p-4 flex items-center justify-between shadow-sm relative overflow-hidden">
                <div class="flex items-center gap-4 z-10">
                    <div class="bg-white/60 p-2 rounded-lg text-[#FFA000]">
                        <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h4 class="text-sm font-black text-[#5D4037]">Tienes 1 turnos esta semana sin notificaci√≥n</h4>
                        <p class="text-xs font-bold text-[#8D6E63] mt-0.5">Se recomienda notificar con al menos 3 d√≠as
                            de anticipaci√≥n</p>
                    </div>
                </div>
                <div class="flex items-center gap-4 z-10">
                    <button onclick="openWizard()"
                        class="px-5 py-2.5 bg-[#2962FF] hover:bg-[#1E88E5] text-white text-[10px] font-black uppercase tracking-widest rounded-xl shadow-lg shadow-blue-200 transition-all active:scale-95">
                        Notificar Ahora
                    </button>
                    <button onclick="document.getElementById('topWarningBanner').remove()"
                        class="p-2 text-[#FFD54F] hover:text-[#FFA000] transition-colors">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Header -->
        <header class="bg-white border-b border-gray-200 px-8 py-4 flex items-center justify-between shadow-sm z-20">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 rounded-lg text-gray-500 transition"
                    title="Toggle Sidebar">
                    <i data-lucide="menu" class="w-5 h-5"></i>
                </button>
                <div>
                    <h1 class="text-2xl font-black text-gray-900 tracking-tight">Calendario de Mantenimiento</h1>
                    <div class="flex items-center gap-2 text-xs text-gray-500 font-medium">
                        <span>Planificaci√≥n Din√°mica</span>
                        <span class="w-1 h-1 bg-gray-300 rounded-full"></span>
                        <span id="currentViewLabel">Vista Mensual</span>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <!-- View Selector -->
                <div class="bg-gray-100 p-1 rounded-xl flex items-center">
                    <button onclick="switchView('month')" id="btnViewMonth"
                        class="px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all bg-white text-gray-900 shadow-sm">
                        Mensual
                    </button>
                    <button onclick="switchView('week')" id="btnViewWeek"
                        class="px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-widest text-gray-500 hover:text-gray-900 transition-all">
                        Semanal
                    </button>
                    <button onclick="switchView('day')" id="btnViewDay"
                        class="px-3 py-2.5 rounded-lg text-[10px] font-black uppercase tracking-widest text-gray-500 hover:text-gray-900 transition-all">
                        Diaria
                    </button>
                </div>

                <!-- Navigation -->
                <div class="flex items-center bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
                    <button onclick="navigateCalendar(-1)"
                        class="p-2.5 hover:bg-gray-50 text-gray-600 border-r border-gray-100 transition">
                        <i data-lucide="chevron-left" class="w-4 h-4"></i>
                    </button>
                    <span id="calendarDateDisplay"
                        class="px-6 py-2 text-xs font-black text-gray-900 min-w-[150px] text-center uppercase tracking-widest">
                        -
                    </span>
                    <button onclick="navigateCalendar(1)"
                        class="p-2.5 hover:bg-gray-50 text-gray-600 border-l border-gray-100 transition">
                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    </button>
                </div>

                <a href="{% url 'notifications_dashboard' %}"
                    class="px-5 py-2.5 bg-white border border-gray-200 text-gray-700 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-sm hover:bg-gray-50 hover:text-blue-600 transition-all flex items-center gap-2 whitespace-nowrap">
                    <i data-lucide="bell" class="w-4 h-4"></i> Gestor Notif.
                </a>
                <a href="{% url 'exportar_excel' %}"
                    class="px-5 py-2.5 bg-blue-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-blue-100 hover:bg-blue-700 hover:shadow-xl transition-all flex items-center gap-2 whitespace-nowrap">
                    <i data-lucide="download" class="w-4 h-4"></i> Exportar
                </a>
            </div>
        </header>

        <!-- Views Container -->
        <div class="flex-1 overflow-auto p-6 relative" id="mainViewsContainer">
            <!-- Compact Legend -->
            <div class="mb-6 flex flex-wrap justify-between items-center bg-white p-4 rounded-2xl border border-gray-100 shadow-sm">
                <!-- Left Section: Notifications -->
                <div class="flex items-center gap-6">
                    <div class="text-[10px] font-black text-gray-400 uppercase tracking-widest border-r border-gray-100 pr-6 mr-2">Notificaci√≥n</div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm">üìß</span>
                        <span class="text-[11px] font-bold text-gray-700">Enviada</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm">‚è≥</span>
                        <span class="text-[11px] font-bold text-gray-700">Pendiente</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm">‚ö†Ô∏è</span>
                        <span class="text-[11px] font-bold text-gray-700">Error de Env√≠o</span>
                    </div>
                </div>

                <!-- Right Section: Turn Status -->
                <div class="flex items-center gap-6">
                    <div class="text-[10px] font-black text-gray-400 uppercase tracking-widest border-r border-gray-100 pr-6 mr-2">Turno</div>
                    <div class="flex gap-4">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500 shadow-sm shadow-green-200"></div>
                            <span class="text-[11px] font-bold text-gray-700 uppercase tracking-wider">Listo</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-amber-500 shadow-sm shadow-amber-200"></div>
                            <span class="text-[11px] font-bold text-gray-700 uppercase tracking-wider">En Proceso</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-blue-500 shadow-sm shadow-blue-200"></div>
                            <span class="text-[11px] font-bold text-gray-700 uppercase tracking-wider">Asignado</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Monthly View -->
            <div id="monthView" class="h-full flex flex-col">
                <div id="calendarContainer" class="flex-1">
                    <!-- JS Rendered Month Grid -->
                </div>
            </div>
            <!-- Weekly View (Hidden by default) -->
            <div id="weekView" class="hidden h-full">
                <div class="flex h-full flex-col">
                    <!-- Week Header -->
                    <div class="grid grid-cols-8 gap-0 border-b border-gray-200 bg-white sticky top-0 z-10" id="weekHeader">
                        <!-- Time Column Header -->
                        <div class="p-3 border-r border-gray-100"></div>
                        <!-- Days Headers JS Rendered -->
                    </div>
                    <!-- Week Grid -->
                    <div class="flex-1 overflow-y-auto relative bg-white" id="weekGrid">
                        <!-- JS Rendered -->
                    </div>
                </div>
            </div>

            <!-- Daily View (Hidden by default) -->
            <div id="dayView" class="hidden h-full max-w-4xl mx-auto">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 flex flex-col h-full overflow-hidden">
                    <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                        <div>
                            <h3 class="text-lg font-black text-gray-900" id="dayViewTitle">-</h3>
                            <p class="text-xs text-gray-500 font-bold">Detalle de turnos</p>
                        </div>
                        <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-black" id="dayViewCount">0 Turnos</span>
                    </div>
                    <div class="flex-1 overflow-y-auto p-6 space-y-3" id="dayListContainer">
                        <!-- JS Rendered -->
                    </div>
                </div>
            </div>
        </div>
    </main>





    <!-- DETAIL MODAL -->
    <div id="detailModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[10000]">
        <div class="bg-white rounded-xl max-w-lg w-full p-8 relative max-h-[80vh] overflow-y-auto">
            <button onclick="document.getElementById('detailModal').classList.add('hidden')"
                class="absolute top-4 right-4 text-2xl text-gray-400">√ó</button>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- DAY DETAIL MODAL -->
    <div id="dayDetailOverlay"
        style="display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 9998; backdrop-filter: blur(2px);"
        onclick="closeDayDetailPanel()"></div>

    <div id="dayDetailPanel"
        style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 800px; max-width: 95vw; max-height: 90vh; background-color: white; z-index: 9999; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border-radius: 16px; flex-direction: column; overflow: hidden;">
        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-blue-600 to-blue-500 text-white p-6 flex justify-between items-center">
            <div>
                <h3 class="text-2xl font-black" id="dayDetailDate">-</h3>
                <p class="text-sm opacity-90 font-medium" id="dayDetailSubtitle">Turnos del d√≠a</p>
            </div>
            <button onclick="event.stopPropagation(); closeDayDetailPanel()" class="hover:bg-white/20 rounded-lg p-2 transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- Modal Content -->
        <div class="flex-1 overflow-y-auto p-6 bg-gray-50" id="dayDetailContent">
            <p class="text-center text-gray-400 italic text-sm py-8">Cargando...</p>
        </div>
    </div>

    <!-- ERROR MODAL (Insufficient Slots) -->
    <div id="errorModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[10020] backdrop-blur-sm">
        <div class="bg-white rounded-2xl max-w-lg w-full p-0 overflow-hidden shadow-2xl transform transition-all scale-95 opacity-0"
            id="errorModalContainer">
            <div class="bg-red-50 p-6 flex items-center gap-4 border-b border-red-100">
                <div
                    class="size-12 bg-red-100 rounded-full flex items-center justify-center text-2xl text-red-600 animate-pulse">
                    ‚ö†Ô∏è
                </div>
                <div>
                    <h3 class="text-xl font-black text-red-900 uppercase tracking-tight">Capacidad Insuficiente</h3>
                    <p class="text-xs text-red-600 font-bold">No hay suficientes espacios para todos los turnos</p>
                </div>
            </div>

            <div class="p-8 space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                        <p class="text-[10px] font-black text-gray-400 uppercase mb-1">Slots Disponibles</p>
                        <p class="text-2xl font-black text-gray-800" id="errorSlotsGen">0</p>
                        <p class="text-[10px] text-gray-500 font-bold" id="errorDaysLab">0 d√≠as laborales</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                        <p class="text-[10px] font-black text-red-400 uppercase mb-1">Slots Faltantes</p>
                        <p class="text-2xl font-black text-red-600" id="errorSlotsMiss">0</p>
                        <p class="text-[10px] text-red-500 font-bold">Acci√≥n requerida</p>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between text-[10px] font-black uppercase mb-2">
                        <span class="text-gray-400">Cobertura del Plan</span>
                        <span class="text-blue-600" id="errorPercentText">0%</span>
                    </div>
                    <div class="w-full bg-gray-100 h-3 rounded-full overflow-hidden">
                        <div id="errorProgressBar"
                            class="h-full bg-gradient-to-r from-red-500 to-orange-500 transition-all duration-1000"
                            style="width: 0%"></div>
                    </div>
                </div>

                <div class="space-y-3">
                    <h4 class="text-[10px] font-black text-gray-500 uppercase tracking-widest">üí° Recomendaciones</h4>
                    <ul id="errorSuggestions" class="space-y-2">
                        <!-- Dynamic suggestions -->
                    </ul>
                </div>
            </div>

            <div class="p-6 bg-gray-50 border-t border-gray-100 flex gap-3">
                <button onclick="closeErrorModal()"
                    class="flex-1 py-3 bg-gray-800 text-white rounded-xl font-black text-xs uppercase tracking-widest hover:bg-black transition-all active:scale-95">
                    Entendido
                </button>
                <button onclick="closeErrorModal(); toggleConfig();"
                    class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-black text-xs uppercase tracking-widest hover:bg-blue-700 transition-all active:scale-95 shadow-lg shadow-blue-500/30">
                    ‚öôÔ∏è Ajustar Configuraci√≥n
                </button>
            </div>
        </div>
    </div>

    <!-- MANUAL TURN MODAL -->
    <div id="manualTurnModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[10000] backdrop-blur-sm transition-all duration-300">
        <div class="bg-white rounded-2xl max-w-lg w-full overflow-hidden shadow-2xl transform transition-all scale-95 opacity-0" id="manualTurnModalContainer">
            <!-- Modal Header -->
            <div class="bg-blue-600 p-6 flex items-center justify-between text-white">
                <div class="flex items-center gap-4">
                    <div class="p-3 bg-white/20 rounded-xl">
                        <i data-lucide="calendar-plus" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-black uppercase tracking-tight">Nuevo Turno Manual</h3>
                        <p class="text-xs font-bold opacity-80" id="manualTurnDateLabel">Asignar turno al cronograma</p>
                    </div>
                </div>
                <button onclick="closeManualTurnModal()" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="p-8 space-y-6 max-h-[70vh] overflow-y-auto custom-scrollbar">
                <!-- Responsable Info -->
                <div class="space-y-4">
                    <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="user" class="w-3.5 h-3.5 text-blue-500"></i> Datos del Responsable
                    </h4>
                    <div class="grid grid-cols-1 gap-4">
                        <div class="space-y-1.5">
                            <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Nombre Completo</label>
                            <input type="text" id="manualResponsableNombre" placeholder="Ej: Juan P√©rez"
                                class="w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-xl text-sm font-bold text-gray-700 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Correo Electr√≥nico (Opcional)</label>
                            <input type="email" id="manualResponsableEmail" placeholder="juan.perez@empresa.com"
                                class="w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-xl text-sm font-bold text-gray-700 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all">
                        </div>
                    </div>
                </div>

                <!-- Turno Details (Read-only pre-filled) -->
                <div class="grid grid-cols-2 gap-4 pt-2">
                    <div class="space-y-1.5">
                        <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Fecha Programada</label>
                        <input type="date" id="manualTurnFecha" readonly
                            class="w-full px-4 py-3 bg-gray-100 border border-gray-100 rounded-xl text-sm font-black text-gray-400 cursor-not-allowed">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Hora Programada</label>
                        <input type="time" id="manualTurnHora" readonly
                            class="w-full px-4 py-3 bg-gray-100 border border-gray-100 rounded-xl text-sm font-black text-gray-400 cursor-not-allowed">
                    </div>
                </div>

                <!-- Equipos List -->
                <div class="space-y-4 pt-4 border-t border-gray-100">
                    <div class="flex items-center justify-between">
                        <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest flex items-center gap-2">
                            <i data-lucide="cpu" class="w-3.5 h-3.5 text-blue-500"></i> Equipos a Mantener
                        </h4>
                        <button onclick="addManualEquipoRow()" class="text-[10px] font-black text-blue-600 uppercase hover:text-blue-700 flex items-center gap-1">
                            <i data-lucide="plus-circle" class="w-3 h-3"></i> A√±adir Equipo
                        </button>
                    </div>

                    <div id="manualEquiposList" class="space-y-3">
                        <!-- Rows added via JS -->
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-6 bg-gray-50 border-t border-gray-100 flex gap-3">
                <button onclick="closeManualTurnModal()"
                    class="flex-1 py-3 border border-gray-200 bg-white text-gray-500 rounded-xl font-black text-xs uppercase tracking-widest hover:bg-gray-100 transition-all active:scale-95">
                    Cancelar
                </button>
                <button onclick="submitManualTurn()" id="btnSubmitManualTurn"
                    class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-black text-xs uppercase tracking-widest hover:bg-blue-700 transition-all active:scale-95 shadow-lg shadow-blue-500/30 flex items-center justify-center gap-2">
                    <i data-lucide="save" class="w-4 h-4"></i> Crear Turno
                </button>
            </div>
        </div>
    </div>

    <!-- EXCEL FORMAT GUIDELINE MODAL -->
    <div id="excelFormatModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[10010] backdrop-blur-sm transition-all duration-300">
        <div class="bg-white rounded-2xl max-w-2xl w-full overflow-hidden shadow-2xl transform transition-all scale-95 opacity-0" id="excelFormatModalContainer">
            <div class="bg-amber-500 p-6 flex items-center justify-between text-white">
                <div class="flex items-center gap-4">
                    <div class="p-3 bg-white/20 rounded-xl">
                        <i data-lucide="file-spreadsheet" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-black uppercase tracking-tight">Gu√≠a de Formato Excel</h3>
                        <p class="text-xs font-bold opacity-80">Estructura obligatoria para la importaci√≥n</p>
                    </div>
                </div>
                <button onclick="closeExcelFormatModal()" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="p-8 space-y-6">
                <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100 flex items-start gap-3">
                    <i data-lucide="alert-circle" class="w-5 h-5 text-blue-600 mt-0.5"></i>
                    <p class="text-xs text-blue-800 font-medium leading-relaxed">
                        Para que el sistema procese correctamente tus datos, el archivo debe tener exactamente estos encabezados en la primera fila. El orden no importa, pero los nombres deben ser id√©nticos.
                    </p>
                </div>

                <!-- EXCEL SIMULATION -->
                <div class="border border-gray-200 rounded-xl overflow-hidden shadow-inner bg-gray-100">
                    <!-- Column Letters -->
                    <div class="flex bg-gray-200 border-b border-gray-300">
                        <div class="w-10 h-6"></div>
                        <div class="flex-1 flex text-[9px] font-bold text-gray-500 items-center justify-center border-r border-gray-300">A</div>
                        <div class="flex-1 flex text-[9px] font-bold text-gray-500 items-center justify-center border-r border-gray-300">B</div>
                        <div class="flex-1 flex text-[9px] font-bold text-gray-500 items-center justify-center border-r border-gray-300">C</div>
                        <div class="flex-1 flex text-[9px] font-bold text-gray-500 items-center justify-center border-r border-gray-300">D</div>
                        <div class="flex-1 flex text-[9px] font-bold text-gray-500 items-center justify-center">E</div>
                    </div>

                    <!-- Header Row -->
                    <div class="flex bg-white border-b border-gray-200">
                        <div class="w-10 bg-gray-100 border-r border-gray-300 flex items-center justify-center text-[9px] font-bold text-gray-400">1</div>
                        <div class="flex-1 p-2 border-r border-gray-200 text-[10px] font-black text-indigo-700 bg-indigo-50/50">RESPONSABLE</div>
                        <div class="flex-1 p-2 border-r border-gray-200 text-[10px] font-black text-indigo-700 bg-indigo-50/50">EMAIL</div>
                        <div class="flex-1 p-2 border-r border-gray-200 text-[10px] font-black text-indigo-700 bg-indigo-50/50">MARCA</div>
                        <div class="flex-1 p-2 border-r border-gray-200 text-[10px] font-black text-indigo-700 bg-indigo-50/50">MODELO</div>
                        <div class="flex-1 p-2 text-[10px] font-black text-indigo-700 bg-indigo-50/50">DESCRIPCI√ìN</div>
                    </div>

                    <!-- Example Rows -->
                    <div class="flex bg-white border-b border-gray-100">
                        <div class="w-10 bg-gray-100 border-r border-gray-300 flex items-center justify-center text-[9px] font-bold text-gray-400">2</div>
                        <div class="flex-1 p-2 border-r border-gray-100 text-[9px] text-gray-500">Juan P√©rez</div>
                        <div class="flex-1 p-2 border-r border-gray-200 text-[9px] text-gray-500 italic">juan@mail.com</div>
                        <div class="flex-1 p-2 border-r border-gray-200 text-[9px] text-gray-500">Lenovo</div>
                        <div class="flex-1 p-2 border-r border-gray-200 text-[9px] text-gray-500">ThinkPad</div>
                        <div class="flex-1 p-2 text-[9px] text-gray-500 text-xs text-truncate">Port√°til i7...</div>
                    </div>
                </div>

                <div class="space-y-3">
                    <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest">üí° Tips Importantes</h4>
                    <ul class="space-y-2">
                        <li class="flex items-center gap-2 text-[11px] text-gray-600 font-medium">
                            <span class="size-1.5 rounded-full bg-amber-500"></span>
                            Aseg√∫rate de que no haya celdas combinadas en el encabezado.
                        </li>
                        <li class="flex items-center gap-2 text-[11px] text-gray-600 font-medium">
                            <span class="size-1.5 rounded-full bg-amber-500"></span>
                            La columna <strong class="text-gray-900">EMAIL</strong> es crucial para las notificaciones autom√°ticas.
                        </li>
                    </ul>
                </div>
            </div>

            <div class="p-6 bg-gray-50 border-t border-gray-100">
                <button onclick="closeExcelFormatModal()" class="w-full py-3 bg-gray-800 text-white rounded-xl font-black text-xs uppercase tracking-widest hover:bg-black transition-all active:scale-95">
                    Entendido, Corregir√© mi Excel
                </button>
            </div>
        </div>
    </div>
    <div id="confirmationModal"
        class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[50000] backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div id="confirmModalContent"
            class="bg-white rounded-2xl shadow-2xl w-full max-w-sm transform scale-95 transition-all duration-300 p-6">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                    <i data-lucide="help-circle" class="w-6 h-6 text-blue-600"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-900" id="confirmTitle">Confirmar Acci√≥n</h3>
                <p class="text-xs text-gray-500 mt-2" id="confirmMessage">¬øEst√°s seguro de realizar esta acci√≥n?</p>

                <!-- Extra Content Container -->
                <div id="confirmExtraContent" class="mt-4 hidden"></div>
            </div>
            <div class="mt-6 flex gap-3">
                <button id="confirmCancelBtn" onclick="closeConfirmModal()"
                    class="flex-1 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl text-xs font-bold transition-colors">
                    Cancelar
                </button>
                <button id="confirmActionBtn"
                    class="flex-1 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl text-xs font-bold transition-colors shadow-lg shadow-blue-500/30">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- WIZARD MODAL -->
    <div id="wizardModal"
        class="fixed inset-0 z-[100] hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div id="wizardModalContainer"
            class="bg-white rounded-[2rem] shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col transform transition-all duration-300 scale-95 opacity-0">
            <!-- Header -->
            <div class="px-8 py-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                <div class="flex items-center gap-3">
                    <div class="p-2.5 bg-blue-600 text-white rounded-xl shadow-lg shadow-blue-100">
                        <i data-lucide="wand-2" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h3 id="wizardStepTitle" class="text-xl font-black text-gray-900 tracking-tight">Paso 1:
                            Configuraci√≥n</h3>
                        <p class="text-[9px] text-gray-400 font-bold uppercase tracking-widest mt-0.5">Asistente de
                            Notificaci√≥n Masiva</p>
                    </div>
                </div>
                <button onclick="closeWizard()" class="p-2 hover:bg-gray-200 rounded-lg transition text-gray-400">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Progress Bar -->
            <div class="w-full bg-gray-100 h-1.5 overflow-hidden">
                <div id="wizardProgress" class="bg-blue-600 h-full transition-all duration-500" style="width: 33%">
                </div>
            </div>

            <!-- Steps Container -->
            <div class="flex-1 overflow-y-auto p-8 custom-scrollbar bg-white">

                <!-- STEP 1: MESSAGE CONFIG -->
                <div id="wizardStep1" class="wizard-step-node active-step flex-col space-y-6">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest px-1">Asunto del
                            Correo</label>
                        <input type="text" id="wizardAsunto" value="Recordatorio de Mantenimiento Preventivo"
                            class="w-full px-5 py-3.5 bg-gray-50 border border-gray-200 rounded-2xl text-sm font-bold text-gray-900 focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition">
                    </div>

                    <div class="space-y-2">
                        <div class="flex justify-between items-end px-1">
                            <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Contenido del
                                Mensaje</label>
                            <span class="text-[9px] font-bold text-blue-500 cursor-help"
                                title="Puedes usar variables como {funcionario}, {fecha_turno}, {equipos_lista}">Ver
                                Variables</span>
                        </div>
                        <div id="wizardEditor" class="h-64 rounded-2xl"></div>
                        <input type="hidden" id="hidden_cuerpo">
                    </div>
                </div>

                <!-- STEP 2: RECIPIENTS (Accordion) -->
                <div id="wizardStep2" class="wizard-step-node hidden flex-col space-y-6">
                    <div
                        class="flex justify-between items-center bg-blue-50/50 p-4 rounded-2xl border border-blue-100/50">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-blue-100 text-blue-600 rounded-lg">
                                <i data-lucide="users" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <p class="text-[10px] font-black text-blue-900 uppercase tracking-widest">Destinatarios
                                    Seleccionados</p>
                                <p class="text-lg font-black text-blue-600 leading-none mt-1"><span
                                        id="wizardSelectedCount">0</span> Funcionarios</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="toggleAllWizard(true)"
                                class="px-3 py-1.5 bg-white border border-blue-200 text-blue-600 rounded-lg text-[9px] font-black uppercase hover:bg-blue-50 transition">Marcar
                                Todos</button>
                            <button onclick="toggleAllWizard(false)"
                                class="px-3 py-1.5 bg-white border border-gray-200 text-gray-500 rounded-lg text-[9px] font-black uppercase hover:bg-gray-50 transition">Desmarcar</button>
                        </div>
                    </div>

                    <div id="recipientsList" class="space-y-3">
                        <!-- Accordion Items injected via JS -->
                    </div>
                </div>

                <!-- STEP 3: CONFIRMATION -->
                <div id="wizardStep3"
                    class="wizard-step-node hidden flex-col items-center justify-center text-center py-10 space-y-8">
                    <div class="relative">
                        <div class="absolute inset-0 bg-blue-100 rounded-[2.5rem] rotate-6 animate-pulse"></div>
                        <div
                            class="size-24 bg-blue-600 rounded-[2.5rem] shadow-2xl flex items-center justify-center relative -rotate-6">
                            <i data-lucide="send" class="size-10 text-white"></i>
                        </div>
                    </div>

                    <div class="max-w-xs mx-auto space-y-2">
                        <h4 class="text-2xl font-black text-gray-900 tracking-tight">¬øListo para Notificar?</h4>
                        <p class="text-[11px] text-gray-500 font-medium px-4">Se enviar√°n <span id="finalCount"
                                class="text-blue-600 font-black">0</span> mensajes personalizados por correo
                            electr√≥nico.</p>
                    </div>

                    <div class="w-full bg-gray-50 rounded-3xl p-6 border border-gray-100 text-left space-y-4">
                        <div class="flex items-center gap-3">
                            <div
                                class="size-8 bg-white rounded-lg flex items-center justify-center border border-gray-200 shadow-sm text-gray-400">
                                <i data-lucide="eye" class="size-4"></i>
                            </div>
                            <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Vista de lo que
                                recibir√°n</p>
                        </div>
                        <div id="wizardPreviewContent"
                            class="text-[11px] text-gray-600 bg-white p-4 rounded-xl border border-gray-100 prose prose-sm max-h-32 overflow-y-auto custom-scrollbar">
                            <!-- Preview Content -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="px-8 py-6 bg-gray-50/50 border-t border-gray-100 flex justify-between items-center">
                <button type="button" id="wizardPrevBtn" onclick="moveStep(wizardCurrentStep - 1)"
                    class="px-6 py-3 text-gray-400 font-black uppercase text-[10px] tracking-widest hover:text-gray-600 disabled:opacity-0 transition-all flex items-center gap-2">
                    <i data-lucide="arrow-left" class="w-3.5 h-3.5"></i> Atr√°s
                </button>
                <div class="flex gap-3">
                    <button type="button" id="wizardNextBtn" onclick="moveStep(wizardCurrentStep + 1)"
                        class="px-10 py-3 bg-blue-600 text-white rounded-xl font-black uppercase text-[10px] tracking-widest shadow-xl shadow-blue-500/20 hover:bg-blue-700 hover:-translate-y-0.5 transition-all flex items-center gap-2">
                        Siguiente <i data-lucide="arrow-right" class="w-3.5 h-3.5"></i>
                    </button>
                    <button type="button" id="wizardSendBtn" onclick="startSendingProcess()"
                        class="hidden px-10 py-3 bg-green-600 text-white rounded-xl font-black uppercase text-[10px] tracking-widest shadow-xl shadow-green-500/20 hover:bg-green-700 hover:-translate-y-0.5 transition-all flex items-center gap-2">
                        <i data-lucide="send" class="w-3.5 h-3.5"></i> Notificar Ahora
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- STREAMING PROGRESS MODAL -->
    <div id="streamingProgressModal"
        class="fixed inset-0 z-[110] hidden bg-gray-900/40 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-white p-8 rounded-[2rem] shadow-2xl border border-gray-100 max-w-sm w-full text-center space-y-6 animate-in zoom-in-95">
            <div class="relative w-24 h-24 mx-auto">
                <div class="absolute inset-0 border-4 border-blue-50 rounded-full"></div>
                <div id="streamProgressBar"
                    class="absolute inset-0 border-4 border-blue-600 rounded-full border-t-transparent animate-spin">
                </div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <i data-lucide="mail" class="w-10 h-10 text-blue-600"></i>
                </div>
            </div>

            <div class="space-y-2">
                <h3 class="text-xl font-black text-gray-900 uppercase tracking-tight">Enviando Notificaciones</h3>
                <p id="streamStatusText" class="text-xs text-gray-500 font-medium italic">Iniciando proceso...</p>
            </div>

            <div class="w-full bg-gray-100 h-2.5 rounded-full overflow-hidden border border-gray-50">
                <div id="streamProgressBarFill" class="bg-blue-600 h-full w-0 transition-all duration-300"></div>
            </div>

            <div class="flex justify-between items-center px-2">
                <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Progreso</span>
                <span id="streamProgressText" class="text-[10px] font-black text-blue-600 uppercase tracking-widest">0
                    de 0</span>
            </div>

            <button id="streamCloseBtn"
                onclick="document.getElementById('streamingProgressModal').classList.add('hidden')"
                class="hidden w-full py-3 bg-gray-900 text-white rounded-xl font-black uppercase text-[10px] tracking-widest hover:bg-black transition-all">
                Cerrar Ventana
            </button>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
    // Data from Django
    let turnos = [
        {% for t in turnos %}
    {
            id: {{ t.id }},
        responsable: "{{ t.responsable.nombre }}",
            fecha: "{{ t.fecha|date:'Y-m-d'|default:'' }}",
                hora: "{{ t.hora|time:'H:i'|default:'' }}",
                    estado: "{{ t.estado }}",
            notificado: {{ t.notificacion_enviada|yesno:"true,false" }},
            error_notificacion: {{ t.notificacion_error|yesno:"true,false" }},
        equipos: [
            {% for e in t.equipos.all %}
    {
                    id: {{ e.id }},
        marca: "{{ e.marca }}",
            modelo: "{{ e.modelo }}",
                codigo: "{{ e.codigo }}",
                    descripcion: "{{ e.descripcion }}",
                    atendido: {{ e.atendido|yesno:"true,false" }}
                }{% if not forloop.last %},{% endif %}
    {% endfor %}
            ]
        }{% if not forloop.last %},{% endif %}
    {% endfor %}
    ];

    let feriados = [
        {% for f in feriados %}
            "{{ f.fecha|date:'Y-m-d' }}"{% if not forloop.last %},{% endif %}
    {% endfor %}
    ];

    let config = {
        inicio: "{% if config %}{{ config.fecha_inicio|date:'Y-m-d' }}{% endif %}",
        fin: "{% if config %}{{ config.fecha_fin|date:'Y-m-d' }}{% endif %}",
        modo_exclusion: "{{ config.modo_exclusion|default:'weekends' }}",
    };

    let currentMonth = new Date();
    const togglingIds = new Set(); // Multi-click prevention
    if (config.inicio) {
        currentMonth = new Date(config.inicio + 'T00:00:00');
    }

    // --- GLOBAL HELPERS ---
    function getStatusBadgeHTML(estado) {
        let classes = "px-2 py-0.5 rounded-full text-[10px] font-black uppercase ";
        let label = estado;

        if (estado === 'completado') {
            classes += "bg-green-100 text-green-700";
            label = "Completado";
        } else if (estado === 'en_proceso') {
            classes += "bg-yellow-100 text-yellow-700";
            label = "En Proceso";
        } else {
            classes += "bg-blue-100 text-blue-700";
            label = "Pendiente";
        }

        return `<span class="${classes}">${label}</span>`;
    }

    function initCalendar() {
        const container = document.getElementById('calendarContainer');
        container.innerHTML = '';

        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();

        const header = document.createElement('div');
        header.className = 'flex justify-between items-center mb-6';
        header.innerHTML = `
            <h3 class="text-xl font-bold">${currentMonth.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }).toUpperCase()}</h3>
            <div class="flex gap-2">
                <button onclick="changeMonth(-1)" class="p-2 border rounded hover:bg-gray-100 transition">‚Üê</button>
                <button onclick="changeMonth(1)" class="p-2 border rounded hover:bg-gray-100 transition">‚Üí</button>
            </div>
        `;
        container.appendChild(header);

        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-7 gap-4';

        ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'].forEach(day => {
            const h = document.createElement('div');
            h.className = 'text-center text-[10px] font-black text-gray-400 uppercase mb-4';
            h.textContent = day;
            grid.appendChild(h);
        });

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Padding for days before month starts
        for (let i = 0; i < firstDay; i++) {
            const cell = document.createElement('div');
            cell.className = 'calendar-day other-month';
            grid.appendChild(cell);
        }

        // Render each day
        for (let d = 1; d <= daysInMonth; d++) {
            const cellDate = new Date(year, month, d);
            // Fix timezone issue by manually formatting YYYY-MM-DD
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const isWeekend = cellDate.getDay() === 0 || cellDate.getDay() === 6;
            const isHoliday = feriados.includes(dateStr);
            const isToday = new Date().toDateString() === cellDate.toDateString();
            const dayTurnos = turnos.filter(t => t.fecha === dateStr);
            const turnosCount = dayTurnos.length;

            const cell = document.createElement('div');
            cell.className = `calendar-day ${isWeekend ? 'weekend' : ''} ${isHoliday ? 'holiday' : ''} ${isToday ? 'today' : ''}`;
            cell.dataset.date = dateStr;

            // Click handler to open day detail panel
            if (!isWeekend && !isHoliday) {
                cell.onclick = (e) => {
                    e.stopPropagation();
                    console.log('Click on day:', dateStr);
                    openDayDetailPanel(dateStr);
                };
                cell.style.cursor = 'pointer';
            }

            // Determine badge status based on overall day progress
            let badgeClass = 'shift-count-badge';
            if (turnosCount > 0) {
                const allCompleted = dayTurnos.every(t => t.estado === 'completado');
                const anyStarted = dayTurnos.some(t => t.estado !== 'asignado');

                if (allCompleted) {
                    badgeClass += ' has-completed';
                } else if (anyStarted) {
                    badgeClass += ' has-in-progress';
                }
            }

            // Determine day-level notification status counts
            let statusHTML = '';
            if (turnosCount > 0) {
                const errors = dayTurnos.filter(t => t.error_notificacion).length;
                const sent = dayTurnos.filter(t => t.notificado && !t.error_notificacion).length;
                const pending = dayTurnos.filter(t => !t.notificado && !t.error_notificacion).length;

                if (errors > 0) statusHTML += `<span class="ml-1">${errors}‚ö†Ô∏è</span>`;
                if (sent > 0) statusHTML += `<span class="ml-1">${sent}üìß</span>`;
                if (pending > 0) statusHTML += `<span class="ml-1">${pending}‚è≥</span>`;
            }

            cell.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <span class="day-number font-bold text-lg">${d}</span>
                    <div class="flex flex-col items-end gap-1">
                        ${isHoliday ? '<span class="text-[8px] bg-yellow-400 text-yellow-900 px-1.5 py-0.5 rounded-full font-black">üéâ FERIADO</span>' : ''}
                        ${!isHoliday && turnosCount > 0 ? `<span class="${badgeClass} flex items-center gap-0.5">${statusHTML || turnosCount}</span>` : ''}
                    </div>
                </div>
                <div class="flex-1 flex items-center justify-center">
                    ${!isHoliday && turnosCount > 0 ? '<p class="text-xs text-gray-400 font-medium">Click para ver detalles</p>' : ''}
                </div>
            `;

            // Setup drag and drop for day cells
            cell.ondragover = (e) => {
                e.preventDefault();
                cell.classList.add('drag-over');
            };

            cell.ondragleave = () => {
                cell.classList.remove('drag-over');
            };

            cell.ondrop = (e) => {
                e.preventDefault();
                cell.classList.remove('drag-over');
                handleDayDrop(e, dateStr);
            };

            grid.appendChild(cell);
        }

        container.appendChild(grid);
        lucide.createIcons();
    }

    function getDeviceIcon(equipos) {
        if (!equipos || equipos.length === 0) return 'help-circle';
        const marcas = equipos.map(e => (e.marca || '').toLowerCase());
        const descrip = equipos.map(e => (e.descripcion || '').toLowerCase());
        const allStr = marcas.join(' ') + ' ' + descrip.join(' ');

        if (allStr.includes('laptop') || allStr.includes('portatil')) return 'laptop';
        if (allStr.includes('impresora') || allStr.includes('printer')) return 'printer';
        if (allStr.includes('monitor') || allStr.includes('pantalla')) return 'monitor';
        if (allStr.includes('servidor') || allStr.includes('server')) return 'server';
        return 'pc-case';
    }

    function getTurnoCardHTML(t, isCompact = true) {
        const deviceIcon = getDeviceIcon(t.equipos);
        const atendidos = t.equipos.filter(e => e.atendido).length;
        const total = t.equipos.length;
        const progressStr = `${atendidos}/${total}`;

        const notifEmoji = t.error_notificacion ? '‚ö†Ô∏è' : (t.notificado ? 'üìß' : '‚è≥');
        const notifTitle = t.error_notificacion ? 'Error en notificaci√≥n' : (t.notificado ? 'Notificaci√≥n Enviada' : 'Pendiente de Env√≠o');

        const statusIcon = t.estado === 'completado' ? 'check-circle-2' : (t.estado === 'en_proceso' ? 'clock' : 'circle');

        if (isCompact) {
            // For Weekly View or small slots
            return `
                    <div class="flex justify-between text-[10px] font-bold opacity-90 mb-1">
                        <span class="flex items-center gap-1">
                            <i data-lucide="${deviceIcon}" class="w-3 h-3"></i> ${t.hora}
                            <span class="text-xs ml-0.5" title="${notifTitle}">${notifEmoji}</span>
                        </span>
                        <button onclick="showDetails(${t.id}, event)" class="hover:scale-110 transition-transform" 
                                title="Ver detalles para confirmar equipos">
                            <i data-lucide="${statusIcon}" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="font-bold leading-tight mb-1 truncate text-xs uppercase">${t.responsable}</div>
                    <div class="flex justify-between items-baseline text-[9px] opacity-90">
                        <span>${progressStr} EQ.</span>
                        <button onclick="showDetails(${t.id}, event)" class="hover:opacity-70 font-bold flex items-center gap-0.5">
                            <i data-lucide="eye" class="w-2.5 h-2.5"></i> VER
                        </button>
                    </div>
                `;
        } else {
            // For Daily View or Panels
            return `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <i data-lucide="${deviceIcon}" class="w-4 h-4"></i>
                                <span class="font-black text-base uppercase">${t.responsable}</span>
                                <span class="text-xs ml-1" title="${notifTitle}">${notifEmoji}</span>
                            </div>
                            <div class="text-xs opacity-80 font-bold">
                                <i data-lucide="clock" class="w-3 h-3 inline"></i> ${t.hora}
                            </div>
                        </div>
                        <button onclick="showDetails(${t.id}, event)"
                                class="hover:scale-110 transition-transform p-2 rounded-lg hover:bg-black/5"
                                title="Ver detalles para confirmar equipos">
                            <i data-lucide="${statusIcon}" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="bg-black/5 rounded-lg p-3 mb-3">
                        <p class="text-[10px] font-bold text-gray-500 uppercase mb-2">Equipos (${progressStr})</p>
                        <div class="space-y-1">
                            ${t.equipos.map(e => `
                                <div class="flex items-center justify-between text-xs py-1">
                                    <span class="${e.atendido ? 'opacity-60' : 'font-medium'}">${e.marca} ${e.modelo}</span>
                                    <i data-lucide="${e.atendido ? 'check-circle-2' : 'circle'}"
                                       class="w-3 h-3 ${e.atendido ? 'text-green-600' : 'text-gray-400'}"></i>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="showDetails(${t.id}, event)"
                                class="flex-1 py-2 bg-white/70 hover:bg-white rounded-lg text-xs font-bold transition-all border border-gray-100 flex items-center justify-center gap-1.5 shadow-sm">
                            <i data-lucide="eye" class="w-3.5 h-3.5"></i> Ver Detalles
                        </button>
                    </div>
                `;
        }
    }

    function createCard(t) {
        let cardClass = "appointment-card transition-all";
        if (t.estado === 'completado') cardClass += " completed";
        else if (t.estado === 'en_proceso') cardClass += " in-progress";

        const card = document.createElement('div');
        card.className = cardClass;
        card.draggable = true;
        card.dataset.id = t.id;

        const deviceIcon = getDeviceIcon(t.equipos);
        const atendidos = t.equipos.filter(e => e.atendido).length;
        const total = t.equipos.length;
        const progressStr = `${atendidos}/${total}`;

        card.innerHTML = getTurnoCardHTML(t, true);
        card.ondragstart = (e) => {
            e.dataTransfer.setData('text/plain', t.id);
            card.classList.add('dragging');
        };
        card.ondragend = () => card.classList.remove('dragging');

        // Soporte para intercambio (Swap)
        card.ondragover = (e) => {
            e.preventDefault();
            e.stopPropagation();
            card.classList.add('bg-blue-100', 'border-blue-400', 'scale-105');
        };
        card.ondragleave = () => {
            card.classList.remove('bg-blue-100', 'border-blue-400', 'scale-105');
        };
        card.ondrop = (e) => {
            e.preventDefault();
            e.stopPropagation();
            card.classList.remove('bg-blue-100', 'border-blue-400', 'scale-105');
            const draggedId = e.dataTransfer.getData('text/plain');
            if (draggedId != t.id) {
                handleSwap(draggedId, t.id);
            }
        };

        return card;
    }

    function isDayExcluded(dateStr) {
        const date = new Date(dateStr + 'T00:00:00');
        const day = date.getDay(); // 0 Sun, 6 Sat

        if (config.modo_exclusion === 'weekends' && (day === 0 || day === 6)) return true;
        if (config.modo_exclusion === 'sundays' && day === 0) return true;
        return false;
    }

    function handleSwap(idA, idB) {
        const turnoA = turnos.find(t => t.id == idA);
        const turnoB = turnos.find(t => t.id == idB);

        // Validation for excluded days
        if (isDayExcluded(turnoB.fecha)) {
            showToast(`No puedes mover un turno al ${new Date(turnoB.fecha + 'T00:00:00').toLocaleDateString('es-ES', { weekday: 'long' })} (D√≠a excluido)`, 'error');
            return;
        }

        // Allow moving FROM excluded day (to fix mistakes), but check Target.
        // If swapping, both swap positions might matter, but usually dragging A to B means we want A to be on B's slot.

        showConfirmModal(
            'Intercambiar Turnos',
            `¬øEst√°s seguro de intercambiar los turnos de ${turnoA.responsable} y ${turnoB.responsable}?`,
            () => realizarIntercambio(idA, idB)
        );
    }

    async function realizarIntercambio(idA, idB) {
        try {
            const resp = await fetch('/turno/intercambiar/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': CSRF_TOKEN,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ turno_a_id: idA, turno_b_id: idB })
            });

            const data = await resp.json();
            if (resp.ok) {
                showToast(data.message);
                await refreshAllData();
            } else {
                showToast(data.message || 'Error al intercambiar', 'error');
            }
        } catch (err) {
            showToast('Error de conexi√≥n', 'error');
        }
    }

    async function handleDrop(e) {
        e.preventDefault();
        const turnoId = e.dataTransfer.getData('text/plain');
        const newDate = e.currentTarget.closest('.calendar-day').dataset.date;

        if (!newDate) return;

        // AJAX update
        const resp = await fetch(`/turno/${turnoId}/actualizar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': CSRF_TOKEN,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ fecha: newDate })
        });

        if (resp.ok) {
            const t = turnos.find(x => x.id == turnoId);
            t.fecha = newDate;
            initCalendar();
        }
    }

    // --- DAY DETAIL PANEL LOGIC ---
    async function openDayDetailPanel(dateStr) {
        console.trace('openDayDetailPanel called for:', dateStr);
        try {
            const panel = document.getElementById('dayDetailPanel');
            const overlay = document.getElementById('dayDetailOverlay');
            const content = document.getElementById('dayDetailContent');
            const titleEl = document.getElementById('dayDetailDate'); // Corrected ID

            if (!panel || !overlay || !content) return;
            content.dataset.currentDate = dateStr; // Store for refreshes
            const [y, m, d] = dateStr.split('-').map(Number);
            const date = new Date(y, m - 1, d);
            const formattedDate = date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });

            if (titleEl) titleEl.textContent = formattedDate.charAt(0).toUpperCase() + formattedDate.slice(1);

            // Show panel
            overlay.style.display = 'block';
            panel.style.display = 'flex';

            // Prevent instant close if overlay pops up under cursor
            overlay.style.pointerEvents = 'none';
            setTimeout(() => { overlay.style.pointerEvents = 'auto'; }, 300);

            // Render content
            const dayTurnos = turnos.filter(t => t.fecha === dateStr);

            if (dayTurnos.length === 0) {
                content.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-gray-400 p-8 text-center">
                            <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mb-4 border-2 border-dashed border-gray-100">
                                <i data-lucide="calendar-plus" class="w-10 h-10 opacity-20"></i>
                            </div>
                            <h4 class="font-black text-gray-900 uppercase tracking-tight mb-2">D√≠a Disponible</h4>
                            <p class="text-xs font-medium leading-relaxed mb-6 max-w-[200px]">
                                No hay tareas programadas para esta fecha. ¬øDeseas a√±adir un turno?
                            </p>
                            <button onclick="openManualTurnModal('${dateStr}')" 
                                class="px-6 py-2.5 bg-blue-600 text-white rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-blue-700 transition-all active:scale-95 shadow-lg shadow-blue-500/20 flex items-center gap-2">
                                <i data-lucide="plus" class="w-3.5 h-3.5"></i> A√±adir Turno
                            </button>
                        </div>
                    `;
            } else {
                content.innerHTML = '<div class="space-y-3"></div>';
                const list = content.querySelector('div');

                dayTurnos.sort((a, b) => a.hora.localeCompare(b.hora));

                dayTurnos.forEach(t => {
                    const card = createShiftCardForPanel(t);
                    list.appendChild(card);
                });
            }
            lucide.createIcons();

        } catch (err) {
            console.error('Error opening panel:', err);
            showToast('Error al abrir panel', 'error');
        }
    }

    function closeDayDetailPanel() {
        console.trace('closeDayDetailPanel called');
        const panel = document.getElementById('dayDetailPanel');
        const overlay = document.getElementById('dayDetailOverlay');

        if (panel) {
            panel.style.display = 'none';
            console.log('Panel hidden');
        } else {
            console.error('Panel element not found!');
        }
        if (overlay) {
            overlay.style.display = 'none';
            console.log('Overlay hidden');
        } else {
            console.error('Overlay element not found!');
        }
    }

    function createShiftCardForPanel(t) {
        let cardClass = "appointment-card mb-3";
        if (t.estado === 'completado') cardClass += " completed";
        else if (t.estado === 'en_proceso') cardClass += " in-progress";

        const card = document.createElement('div');
        card.className = cardClass;
        card.draggable = true;
        card.dataset.id = t.id;

        const atendidos = t.equipos.filter(e => e.atendido).length;
        const total = t.equipos.length;
        const progressStr = `${atendidos}/${total}`;

        card.innerHTML = getTurnoCardHTML(t, false);

        // Drag handlers
        card.ondragstart = (e) => {
            e.dataTransfer.setData('text/plain', t.id);
            card.classList.add('dragging');
            document.querySelectorAll('.calendar-day').forEach(day => {
                if (!day.classList.contains('other-month') && !day.classList.contains('weekend')) {
                    day.classList.add('drag-source');
                }
            });
        };

        card.ondragend = () => {
            card.classList.remove('dragging');
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('drag-source');
            });
        };

        return card;
    }

    async function handleDayDrop(e, newDate) {
        const turnoId = e.dataTransfer.getData('text/plain');
        if (!turnoId || !newDate) return;

        const turno = turnos.find(t => t.id == turnoId);
        if (turno && turno.fecha === newDate) return; // Same day, do nothing

        // Update via API
        const resp = await fetch(`/turno/${turnoId}/actualizar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': CSRF_TOKEN,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ fecha: newDate })
        });

        if (resp.ok) {
            showToast(`Turno movido a ${newDate}`);
            await refreshAllData();

            // If panel is open, refresh it with the new date's shifts
            const panel = document.getElementById('dayDetailPanel');
            if (panel.style.display !== 'none' && panel.style.display !== '') {
                openDayDetailPanel(newDate);
            }
        } else {
            showToast('Error al mover turno', 'error');
        }
    }

    async function toggleCompletado(id, e) {
        if (e) e.stopPropagation();
        id = Number(id);

        if (togglingIds.has(id)) {
            console.log('Debounce: Ignoring click for ID', id);
            return;
        }

        console.log('toggleCompletado (Optimistic) for ID:', id);

        // Find ALL instances of this ID (to handle potential duplicates from Django)
        const targetTurnos = turnos.filter(x => x.id === id);
        if (targetTurnos.length === 0) return;

        // Save old state for rollback
        const oldEstado = targetTurnos[0].estado;
        const nuevoEstado = (oldEstado === 'completado') ? 'asignado' : 'completado';

        // Optimistic update locally
        targetTurnos.forEach(t => t.estado = nuevoEstado);

        // Immediate UI Refresh
        console.log('Optimistic UI Refresh');
        updateUIOnly();

        try {
            togglingIds.add(id);
            const resp = await fetch(`/turno/${id}/toggle/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': CSRF_TOKEN }
            });

            if (resp.ok) {
                const data = await resp.json();
                // Final sync with backend reality
                targetTurnos.forEach(t => {
                    t.estado = data.nuevo_estado;
                    if (data.equipos) {
                        data.equipos.forEach(eqResp => {
                            const eqLocal = t.equipos.find(e => e.id == eqResp.id);
                            if (eqLocal) eqLocal.atendido = eqResp.atendido;
                        });
                    }
                });
                updateUIOnly();
            } else {
                // Rollback
                targetTurnos.forEach(t => t.estado = oldEstado);
                updateUIOnly();
                showToast('Error en servidor', 'error');
            }
        } catch (err) {
            // Rollback
            targetTurnos.forEach(t => t.estado = oldEstado);
            updateUIOnly();
            showToast('Error de conexi√≥n', 'error');
        } finally {
            setTimeout(() => togglingIds.delete(id), 1000);
        }
    }

    // Helper to refresh all UI components without full data reload
    function updateUIOnly() {
        initCalendar();
        renderPendingAssets();
        updateStats();
        if (currentView === 'week') renderWeekView();
        if (currentView === 'day') renderDayView();

        // Update day detail panel if open for the date of the changed turno
        const content = document.getElementById('dayDetailContent');
        const panel = document.getElementById('dayDetailPanel');
        if (panel && panel.style.display !== 'none' && content.dataset.currentDate) {
            // Refresh content from local data
            const dateStr = content.dataset.currentDate;
            const dayTurnos = turnos.filter(t => t.fecha === dateStr);

            // We reuse the rendering logic from openDayDetailPanel but localized here
            // To keep it simple, we could re-call openDayDetailPanel(dateStr)
            // but let's avoid a recursive loop if openDayDetailPanel ever calls updateUIOnly
            renderDayDetailContentDirect(dateStr);
        }

        lucide.createIcons();
    }

    // Extracted rendering logic to allow refreshes without re-triggering open/close logic
    function renderDayDetailContentDirect(dateStr) {
        const content = document.getElementById('dayDetailContent');
        const dayTurnos = turnos.filter(t => t.fecha === dateStr);

        if (dayTurnos.length === 0) {
            content.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-400 p-8 text-center">
                        <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mb-4 border-2 border-dashed border-gray-100">
                            <i data-lucide="calendar-plus" class="w-10 h-10 opacity-20"></i>
                        </div>
                        <h4 class="font-black text-gray-900 uppercase tracking-tight mb-2">D√≠a Disponible</h4>
                        <p class="text-xs font-medium leading-relaxed mb-6 max-w-[200px]">
                            No hay tareas programadas para esta fecha. ¬øDeseas a√±adir un turno?
                        </p>
                        <button onclick="openManualTurnModal('${dateStr}')" 
                            class="px-6 py-2.5 bg-blue-600 text-white rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-blue-700 transition-all active:scale-95 shadow-lg shadow-blue-500/20 flex items-center gap-2">
                            <i data-lucide="plus" class="w-3.5 h-3.5"></i> A√±adir Turno
                        </button>
                    </div>
                `;
        } else {
            content.innerHTML = '<div class="space-y-3"></div>';
            const list = content.querySelector('div');
            dayTurnos.sort((a, b) => a.hora.localeCompare(b.hora));

            dayTurnos.forEach(t => {
                const card = createShiftCardForPanel(t);
                list.appendChild(card);
            });
        }
        lucide.createIcons();
    }

    function showDetails(id, e) {
        console.log('showDetails called for ID:', id);
        if (e) e.stopPropagation();
        const t = turnos.find(x => x.id == id);
        if (!t) {
            console.error('Turno not found for details:', id);
            return;
        }
        const modal = document.getElementById('detailModal');
        const content = document.getElementById('modalContent');

        if (!modal || !content) {
            console.error('Detail modal elements not found');
            return;
        }

        console.log('Opening modal with content for:', t.responsable);
        content.innerHTML = `
            <h3 class="text-2xl font-bold mb-1">${t.responsable}</h3>
            <p class="text-[10px] font-bold text-gray-400 mb-4 flex items-center gap-2 uppercase tracking-widest">
                Estado Comunicaci√≥n: ${t.error_notificacion ? '<span class="text-rose-600">‚ö†Ô∏è ERROR</span>' : (t.notificado ? '<span class="text-green-600">üìß ENVIADA</span>' : '<span class="text-amber-600">‚è≥ PENDIENTE</span>')}
            </p>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="p-3 bg-gray-50 rounded">
                    <p class="text-[10px] font-bold text-gray-400 uppercase">Fecha</p>
                    <p class="font-bold text-sm">${t.fecha || 'Sin asignar'}</p>
                </div>
                <div class="p-3 bg-gray-50 rounded">
                    <p class="text-[10px] font-bold text-gray-400 uppercase">Hora</p>
                    <p class="font-bold text-sm">${t.hora || 'Sin asignar'}</p>
                </div>
            </div>
            <h4 class="text-xs font-bold text-gray-400 uppercase mb-3 text-blue-600">Equipos y Estado (${t.equipos.length})</h4>
            <div class="space-y-2">
                ${t.equipos.map(eq => `
                    <div class="p-3 border-l-4 ${eq.atendido ? 'border-green-500 bg-green-50/30' : 'border-blue-500 bg-blue-50/30'} flex justify-between items-center transition-all">
                        <div class="flex-1">
                            <p class="font-bold text-sm">${eq.marca} ${eq.modelo}</p>
                            <p class="text-[10px] text-gray-400 font-medium">ID: ${eq.codigo || 'S/N'}</p>
                            <p class="text-[10px] italic text-gray-500 mt-0.5">${eq.descripcion || ''}</p>
                        </div>
                        <button onclick="event.stopPropagation(); event.preventDefault(); toggleEquipo(${eq.id}, ${t.id}, event)" class="p-2 rounded-lg hover:bg-white transition shadow-sm active:scale-95 flex items-center gap-1.5 border border-transparent hover:border-gray-100">
                            <i data-lucide="${eq.atendido ? 'check-circle-2' : 'circle'}" class="w-4 h-4 ${eq.atendido ? 'text-green-600' : 'text-blue-600'}"></i>
                            <span class="text-[10px] font-black uppercase ${eq.atendido ? 'text-green-700' : 'text-blue-700'}">${eq.atendido ? 'LISTO' : 'PENDIENTE'}</span>
                        </button>
                    </div>
                `).join('')}
            </div>
            `;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    async function toggleEquipo(equipoId, turnoId, e) {
        if (e) e.stopPropagation();
        equipoId = Number(equipoId);
        turnoId = Number(turnoId);

        const turno = turnos.find(t => t.id === turnoId);
        if (!turno) return;
        const equipo = turno.equipos.find(e => e.id === equipoId);
        if (!equipo) return;

        // Optimistic update
        const oldAtendido = equipo.atendido;
        equipo.atendido = !oldAtendido;
        updateUIOnly();

        // Update the modal content immediately with optimistic state
        showDetails(turnoId);

        try {
            const resp = await fetch(`/equipo/${equipoId}/toggle-atendido/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': CSRF_TOKEN }
            });

            if (resp.ok) {
                const data = await resp.json();
                equipo.atendido = data.atendido;
                if (data.turno_estado) {
                    turno.estado = data.turno_estado;
                }
                updateUIOnly();
                // Refresh modal with server-confirmed state
                showDetails(turnoId);
            } else {
                equipo.atendido = oldAtendido;
                updateUIOnly();
                showDetails(turnoId);
                showToast('Error en servidor', 'error');
            }
        } catch (err) {
            equipo.atendido = oldAtendido;
            updateUIOnly();
            showDetails(turnoId);
            showToast('Error de conexi√≥n', 'error');
        }
    }

    // --- MANUAL TURN LOGIC ---
    function openManualTurnModal(dateStr, timeStr = "08:00") {
        const modal = document.getElementById('manualTurnModal');
        const container = document.getElementById('manualTurnModalContainer');
        const fechaInput = document.getElementById('manualTurnFecha');
        const horaInput = document.getElementById('manualTurnHora');
        const dateLabel = document.getElementById('manualTurnDateLabel');
        const equipList = document.getElementById('manualEquiposList');

        if (!modal || !container || !fechaInput || !horaInput) return;

        // Reset Form
        document.getElementById('manualResponsableNombre').value = '';
        document.getElementById('manualResponsableEmail').value = '';
        equipList.innerHTML = '';
        addManualEquipoRow(); // Add one initial row

        // Pre-fill
        fechaInput.value = dateStr;
        horaInput.value = timeStr;

        const [y, m, d] = dateStr.split('-').map(Number);
        const dateObj = new Date(y, m - 1, d);
        dateLabel.textContent = dateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

        modal.classList.remove('hidden');
        modal.classList.add('flex');
        setTimeout(() => {
            container.classList.remove('scale-95', 'opacity-0');
            container.classList.add('scale-100', 'opacity-100');
        }, 10);

        // Close other panels if open
        closeDayDetailPanel();
        lucide.createIcons();
    }

    function closeManualTurnModal() {
        const modal = document.getElementById('manualTurnModal');
        const container = document.getElementById('manualTurnModalContainer');
        if (!modal || !container) return;

        container.classList.add('scale-95', 'opacity-0');
        container.classList.remove('scale-100', 'opacity-100');
        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }, 300);
    }

    function addManualEquipoRow() {
        const list = document.getElementById('manualEquiposList');
        const id = Date.now();
        const div = document.createElement('div');
        div.className = "bg-gray-50/50 border border-gray-100 p-4 rounded-xl space-y-3 relative group animate-in slide-in-from-top-1 fade-in duration-300";
        div.dataset.rowId = id;
        div.innerHTML = `
                <button onclick="this.parentElement.remove()" class="absolute top-2 right-2 p-1 text-gray-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100">
                    <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                </button>
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1">
                        <label class="text-[9px] font-bold text-gray-400 uppercase">Marca</label>
                        <input type="text" placeholder="Ej: Dell" class="manual-eq-marca w-full px-3 py-2 bg-white border border-gray-200 rounded-lg text-xs font-bold focus:border-blue-500 outline-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-bold text-gray-400 uppercase">Modelo</label>
                        <input type="text" placeholder="Ej: Latitude 5420" class="manual-eq-modelo w-full px-3 py-2 bg-white border border-gray-200 rounded-lg text-xs font-bold focus:border-blue-500 outline-none">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1">
                        <label class="text-[9px] font-bold text-gray-400 uppercase">C√≥digo Interno</label>
                        <input type="text" placeholder="Ej: CPN-001" class="manual-eq-codigo w-full px-3 py-2 bg-white border border-gray-200 rounded-lg text-xs font-bold focus:border-blue-500 outline-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-bold text-gray-400 uppercase">Descripci√≥n</label>
                        <input type="text" placeholder="Ej: Descripci√≥n del dispositivo" class="manual-eq-desc w-full px-3 py-2 bg-white border border-gray-200 rounded-lg text-xs font-bold focus:border-blue-500 outline-none">
                    </div>
                </div>
            `;
        list.appendChild(div);
        lucide.createIcons();
    }

    async function submitManualTurn(forceCreate = false) {
        const btn = document.getElementById('btnSubmitManualTurn');
        const nombre = document.getElementById('manualResponsableNombre').value.trim();
        const email = document.getElementById('manualResponsableEmail').value.trim();
        const fecha = document.getElementById('manualTurnFecha').value;
        const hora = document.getElementById('manualTurnHora').value;

        if (!nombre) {
            showAlertModal('Dato Obligatorio', 'El nombre del responsable es necesario para agendar el turno.');
            return;
        }

        const equipos = [];
        document.querySelectorAll('#manualEquiposList > div').forEach(row => {
            const marca = row.querySelector('.manual-eq-marca').value.trim();
            const modelo = row.querySelector('.manual-eq-modelo').value.trim();
            const codigo = row.querySelector('.manual-eq-codigo').value.trim();
            const descripcion = row.querySelector('.manual-eq-desc').value.trim();

            if (marca || modelo || codigo) {
                equipos.push({ marca, modelo, codigo, descripcion });
            }
        });

        if (equipos.length === 0) {
            showAlertModal('Equipos Requeridos', 'Debes a√±adir al menos un equipo con su marca o c√≥digo para crear el turno.');
            return;
        }

        try {
            btn.disabled = true;
            btn.innerHTML = '<i class="w-4 h-4 animate-spin border-2 border-white/30 border-t-white rounded-full"></i> Cargando...';

            const payload = { nombre, email, fecha, hora, equipos };
            if (forceCreate) {
                payload.force_create = true;
            }

            const resp = await fetch('/api/turnos/crear-manual/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': CSRF_TOKEN,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const data = await resp.json();

            // Handle duplicate status
            if (data.status === 'duplicate') {
                showConfirmModal(
                    '‚ö†Ô∏è Responsable Existente',
                    data.message,
                    async (showSuccess) => {
                        const success = await submitManualTurn(true);
                        if (success) {
                            showSuccess('Nuevo turno independiente creado con √©xito.');
                        } else {
                            closeConfirmModal();
                        }
                    },
                    {
                        type: 'warning',
                        noCloseOnConfirm: true,
                        extraHTML: `
                                <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 text-left mt-4">
                                    <div class="flex items-center gap-3 mb-2">
                                        <div class="p-2 bg-blue-100 text-blue-600 rounded-lg">
                                            <i data-lucide="user" class="w-4 h-4"></i>
                                        </div>
                                        <div>
                                            <p class="text-[10px] font-black uppercase text-gray-400">Datos Guardados</p>
                                            <p class="text-sm font-black text-gray-900">${data.existing_responsable.nombre}</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="p-2 bg-green-100 text-green-600 rounded-lg">
                                            <i data-lucide="mail" class="w-4 h-4"></i>
                                        </div>
                                        <div>
                                            <p class="text-[10px] font-black uppercase text-gray-400">Correo Asociado</p>
                                            <p class="text-[11px] font-bold text-gray-700">${data.existing_responsable.email}</p>
                                        </div>
                                    </div>
                                </div>
                            `
                    }
                );
                return;
            }

            if (resp.ok && data.status === 'ok') {
                if (!forceCreate) {
                    showToast('Turno creado con √©xito');
                }
                closeManualTurnModal();
                await refreshAllData();
                return true;
            } else {
                showToast(data.message || 'Error al crear turno', 'error');
                return false;
            }
        } catch (err) {
            console.error('Error in submitManualTurn:', err);
            showToast('Error de conexi√≥n: ' + (err.message || 'Error desconocido'), 'error');
            return false;
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> Crear Turno';
            lucide.createIcons();
        }
    }

    function renderPendingAssets() {
        const panel = document.getElementById('pendingAssetsPanel');
        if (!panel) return;

        const pendingItems = [];
        turnos.forEach(t => {
            if (t.estado !== 'completado') {
                const total = t.equipos.length;
                const atendidos = t.equipos.filter(e => e.atendido).length;

                t.equipos.forEach(e => {
                    if (!e.atendido) {
                        pendingItems.push({
                            ...e,
                            responsable: t.responsable,
                            turnoId: t.id,
                            fecha: t.fecha,
                            hora: t.hora,
                            progreso: `${atendidos + 1}/${total}`,
                            enProceso: t.estado === 'en_proceso'
                        });
                    }
                });
            }
        });

        // Sort by Date THEN Time sequence
        pendingItems.sort((a, b) => {
            if (a.fecha !== b.fecha) return a.fecha.localeCompare(b.fecha);
            return a.hora.localeCompare(b.hora);
        });

        if (pendingItems.length === 0) {
            panel.innerHTML = '<p class="text-[10px] text-gray-400 italic text-center py-4">Sin equipos pendientes</p>';
            return;
        }

        panel.innerHTML = pendingItems.map(p => {
            // Format date for better readability (e.g., "Lun 26")
            const d = new Date(p.fecha + 'T00:00:00');
            const dateStr = d.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' }).toUpperCase();

            return `
            <div class="p-3 border border-gray-200 bg-white rounded-xl shadow-sm hover:shadow-md transition-all duration-300">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex gap-1">
                        <span class="text-[9px] font-black bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full uppercase tracking-tighter border border-gray-200 flex items-center gap-1">
                            <i data-lucide="calendar" class="w-2.5 h-2.5"></i> ${dateStr}
                        </span>
                        <span class="text-[9px] font-black px-2 py-0.5 rounded-full uppercase tracking-tighter border flex items-center gap-1"
                              style="background: var(--blue-pastel); color: var(--blue-text); border-color: rgba(30, 64, 175, 0.1);">
                            <i data-lucide="clock" class="w-2.5 h-2.5"></i> ${p.hora}
                        </span>
                    </div>
                    <span class="text-[9px] font-black px-2 py-0.5 rounded-full uppercase tracking-tighter border flex items-center gap-1"
                          style="${p.enProceso ? 'background: var(--yellow-pastel); color: var(--yellow-text); border-color: rgba(146, 64, 14, 0.1);' : 'background: var(--bg-primary); color: var(--text-secondary); border-color: var(--border);'}">
                        <i data-lucide="${p.enProceso ? 'clock' : 'layers'}" class="w-2.5 h-2.5"></i> ${p.enProceso ? 'EN PROCESO' : `EQ. ${p.progreso}`}
                    </span>
                </div>
                <div class="flex gap-3 mb-2">
                    <div class="size-10 bg-gray-50 flex items-center justify-center rounded-lg flex-shrink-0 border border-gray-100">
                        <i data-lucide="${getDeviceIcon([p])}" class="w-5 h-5 text-gray-400"></i>
                    </div>
                    <div class="min-w-0 flex-1">
                        <p class="font-black text-gray-900 text-xs truncate uppercase">${p.responsable}</p>
                        <p class="text-[11px] font-bold text-gray-700 truncate">${p.marca} ${p.modelo}</p>
                        <p class="text-[9px] text-gray-400">ID: ${p.codigo || 'S/N'}</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 mt-3">
                    <button onclick="showDetails(${p.turnoId})" 
                            class="flex items-center justify-center gap-1.5 py-1.5 rounded-lg text-[9px] font-black uppercase tracking-wider transition-all active:scale-95 shadow-sm border"
                            style="background: var(--blue-pastel); color: var(--blue-text); border-color: rgba(30, 64, 175, 0.1);">
                        <i data-lucide="eye" class="w-3 h-3"></i> VER
                    </button>
                    <button onclick="toggleEquipo(${p.id}, ${p.turnoId})" 
                            class="flex items-center justify-center gap-1.5 py-1.5 rounded-lg text-[9px] font-black uppercase tracking-wider transition-all active:scale-95 shadow-sm border"
                            style="background: var(--green-pastel); color: var(--green-text); border-color: rgba(6, 95, 70, 0.1);">
                        <i data-lucide="check-circle-2" class="w-3 h-3"></i> LISTO
                    </button>
                </div>
            </div>
            `;
        }).join('');
        lucide.createIcons();
    }

    function handleUploadDragOver(e) {
        e.preventDefault();
        e.currentTarget.classList.add('bg-blue-50', 'border-blue-500');
    }

    function handleUploadDragLeave(e) {
        e.preventDefault();
        e.currentTarget.classList.remove('bg-blue-50', 'border-blue-500');
    }

    function handleUploadDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove('bg-blue-50', 'border-blue-500');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            document.getElementById('fileInput').files = files;
            submitUpload();
        }
    }

    async function submitUpload() {
        const input = document.getElementById('fileInput');
        if (input.files.length > 0) {
            const fileName = input.files[0].name;
            const fileNameDisplay = document.getElementById('fileName');
            const uploadText = document.getElementById('uploadText');

            fileNameDisplay.textContent = fileName;
            fileNameDisplay.classList.remove('hidden');
            uploadText.textContent = "Cargando archivo...";

            const formData = new FormData(document.getElementById('uploadForm'));
            formData.append('ajax', '1');

            try {
                const resp = await fetch('{% url "upload_excel" %}', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': CSRF_TOKEN }
                });
                const data = await resp.json();
                if (resp.ok) {
                    showToast(data.message || 'Archivo cargado con √©xito');
                    await refreshAllData();
                } else {
                    showToast(data.message || 'Error al cargar archivo', 'error');
                    // AUTOMATIC MODAL ON FORMAT ERROR
                    if (data.message && data.message.includes('formato')) {
                        setTimeout(openExcelFormatModal, 1500);
                    }
                }
            } catch (err) {
                console.error('Upload error:', err);
                showToast('Ocurri√≥ un error inesperado al procesar el archivo.', 'error');
            } finally {
                uploadText.textContent = "Subir Excel de Mantenimientos";
                input.value = '';
                updateStepStatus();
            }
        }
    }

    function updateStepStatus() {
        const hasData = turnos && turnos.length > 0;
        const step2 = document.getElementById('step2Container');
        const step3 = document.getElementById('step3Container');
        const step2Indicator = document.getElementById('step2Indicator');
        const step3Indicator = document.getElementById('step3Indicator');
        const btnGenerarTodo = document.getElementById('btnGenerarTodo');

        if (!step2 || !step3) return;

        if (hasData) {
            // ENABLED STATE
            step2.classList.remove('opacity-40', 'pointer-events-none', 'grayscale');
            step3.classList.remove('opacity-40', 'pointer-events-none', 'grayscale');
            step2Indicator.classList.replace('bg-gray-200', 'bg-indigo-600');
            step2Indicator.classList.replace('text-gray-500', 'text-white');
            step3Indicator.classList.replace('bg-gray-200', 'bg-indigo-600');
            step3Indicator.classList.replace('text-gray-500', 'text-white');
            if (btnGenerarTodo) btnGenerarTodo.disabled = false;
        } else {
            // DISABLED STATE
            step2.classList.add('opacity-40', 'pointer-events-none', 'grayscale');
            step3.classList.add('opacity-40', 'pointer-events-none', 'grayscale');
            step2Indicator.classList.replace('bg-indigo-600', 'bg-gray-200');
            step2Indicator.classList.replace('text-white', 'text-gray-500');
            step3Indicator.classList.replace('bg-indigo-600', 'bg-gray-200');
            step3Indicator.classList.replace('text-white', 'text-gray-500');
            if (btnGenerarTodo) btnGenerarTodo.disabled = true;
        }
    }

    function openExcelFormatModal() {
        const modal = document.getElementById('excelFormatModal');
        const container = document.getElementById('excelFormatModalContainer');
        if (modal && container) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                container.classList.remove('scale-95', 'opacity-0');
                container.classList.add('scale-100', 'opacity-100');
            }, 10);
        }
    }

    function closeExcelFormatModal() {
        const modal = document.getElementById('excelFormatModal');
        const container = document.getElementById('excelFormatModalContainer');
        if (modal && container) {
            container.classList.remove('scale-100', 'opacity-100');
            container.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
            }, 300);
        }
    }

    async function refreshAllData() {
        try {
            const resp = await fetch('{% url "api_get_datos" %}');
            if (!resp.ok) throw new Error('Network response was not ok');
            const data = await resp.json();

            // Actualizar variables globales con seguridad
            turnos = data.turnos || [];
            feriados = data.feriados || [];
            config = data.config || {};

            if (config && config.inicio) {
                currentMonth = new Date(config.inicio + 'T00:00:00');
            }

            // Refrescar UI
            updateCalendarView();
            updateStats();
            renderPendingAssets();
            updateStepStatus();

            // Activar indicadores de progreso y bot√≥n de generar
            const btn = document.getElementById('btnGenerarTodo');
            const step2 = document.getElementById('step2Indicator');
            const step3 = document.getElementById('step3Indicator');

            if (step2) {
                step2.classList.remove('bg-gray-200', 'text-gray-500');
                step2.classList.add('bg-indigo-600', 'text-white');
            }

            if (turnos && turnos.length > 0) {
                if (btn) {
                    btn.classList.remove('bg-slate-200', 'text-gray-400', 'cursor-not-allowed');
                    btn.classList.add('bg-gradient-to-r', 'from-indigo-600', 'to-indigo-700', 'text-white', 'shadow-indigo-200', 'hover:shadow-indigo-400', 'hover:-translate-y-0.5');
                    const icon = btn.querySelector('i, svg');
                    if (icon) icon.classList.remove('opacity-40');
                }
                if (step3) {
                    step3.classList.remove('bg-gray-200', 'text-gray-500');
                    step3.classList.add('bg-indigo-600', 'text-white');
                }
            }
        } catch (err) {
            console.error('Error refreshing data:', err);
        }
    }
    function toggleAccordion(id) {
        const content = document.getElementById(id);
        const arrow = document.getElementById(id.replace('Content', 'Arrow'));
        const isHidden = content.classList.contains('hidden');

        // Cerrar otros acordeones (opcional, pero mejora UX)
        // document.querySelectorAll('[id$="Content"]').forEach(c => c.classList.add('hidden'));
        // document.querySelectorAll('[id$="Arrow"]').forEach(a => a.classList.remove('rotate-180'));

        if (isHidden) {
            content.classList.remove('hidden');
            if (arrow) arrow.classList.add('rotate-180');
        } else {
            content.classList.add('hidden');
            if (arrow) arrow.classList.remove('rotate-180');
        }
    }

    // --- UI HELPERS ---
    function showToast(message, type = 'success') {
        const container = document.getElementById('toastContainer');
        if (!container) return;

        const toast = document.createElement('div');
        const config = {
            success: { icon: 'check-circle-2', style: 'background: var(--green-pastel); color: var(--green-text); border: 1px solid rgba(6, 95, 70, 0.2);' },
            error: { icon: 'alert-circle', style: 'background: var(--red-pastel); color: var(--red-text); border: 1px solid rgba(153, 27, 27, 0.2);' },
            info: { icon: 'info', style: 'background: var(--blue-pastel); color: var(--blue-text); border: 1px solid rgba(30, 64, 175, 0.2);' }
        };

        const cfg = config[type];
        toast.className = `px-6 py-3 rounded-xl shadow-xl font-black text-[10px] uppercase tracking-widest transform transition-all duration-300 translate-x-full opacity-0 pointer-events-auto flex items-center gap-3`;
        toast.style = cfg.style;
        toast.innerHTML = `<i data-lucide="${cfg.icon}" class="w-4 h-4"></i> <span>${message}</span>`;

        container.appendChild(toast);
        lucide.createIcons(); // Re-init for new toast

        // Trigger animation
        requestAnimationFrame(() => {
            toast.classList.remove('translate-x-full', 'opacity-0');
            toast.classList.add('translate-x-0', 'opacity-100');
        });

        // Auto-remove
        setTimeout(() => {
            toast.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => toast.remove(), 400);
        }, 3000);
    }

    async function guardarConfig(silent = false) {
        const f_inicio = document.getElementById('fechaInicio').value;
        const f_fin = document.getElementById('fechaFin').value;
        const h_inicio = document.getElementById('horaInicio').value;
        const h_fin = document.getElementById('horaFin').value;

        // Validar campos obligatorios
        if (!f_inicio || !f_fin) {
            await showAlertModal('Datos Faltantes', 'Tanto la fecha de inicio como la de fin son obligatorias para el cronograma.');
            return false;
        }

        // Validar rango de fechas
        if (f_inicio > f_fin) {
            await showAlertModal('Rango de Fechas Inv√°lido', 'La fecha de inicio no puede ser posterior a la fecha de fin.');
            return false;
        }

        // Validar rango de horas
        if (h_inicio && h_fin && h_inicio >= h_fin) {
            await showAlertModal('Rango Horario Inv√°lido', 'La hora de inicio de la jornada debe ser anterior a la hora de finalizaci√≥n.');
            return false;
        }

        const formData = new FormData(document.getElementById('configForm'));
        try {
            const resp = await fetch('{% url "guardar_configuracion" %}', {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': CSRF_TOKEN }
            });
            const data = await resp.json();
            if (resp.ok) {
                if (!silent) {
                    await showAlertModal('¬°√âxito!', data.message || 'La configuraci√≥n se ha guardado correctamente.', 'success');
                }
                return true;
            } else {
                showToast(data.message || 'Error al guardar la configuraci√≥n', 'error');
                return false;
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Error de conexi√≥n', 'error');
            return false;
        }
    }

    async function showAlertModal(title, message, type = 'error') {
        return new Promise((resolve) => {
            showConfirmModal(title, message, () => {
                resolve();
            }, {
                type: type === 'error' ? 'warning' : (type === 'success' ? 'info' : 'info'),
                hideCancel: true,
                confirmText: 'Entendido',
                btnClass: type === 'error' ? 'bg-red-600 hover:bg-red-700 shadow-red-500/30' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-500/30'
            });
        });
    }

    function showConfirmModal(title, message, onConfirm, options = {}) {
        const modal = document.getElementById('confirmationModal');
        const container = document.getElementById('confirmModalContent');
        const titleEl = document.getElementById('confirmTitle');
        const msgEl = document.getElementById('confirmMessage');
        const extraEl = document.getElementById('confirmExtraContent');
        const confirmBtn = document.getElementById('confirmActionBtn');
        const cancelBtn = document.getElementById('confirmCancelBtn') || (container ? container.querySelector('button[onclick="closeConfirmModal()"]') : null);
        const iconContainer = container ? container.querySelector('.rounded-full') : null;

        if (!modal || !confirmBtn || !container) return;

        // Reset state
        titleEl.textContent = title;
        msgEl.textContent = message;
        msgEl.classList.remove('text-green-600', 'font-bold');
        extraEl.innerHTML = '';
        extraEl.classList.add('hidden');
        confirmBtn.style.display = 'block';
        confirmBtn.disabled = false;
        if (cancelBtn) cancelBtn.style.display = options.hideCancel ? 'none' : 'block';

        // Icon handling
        const icon = iconContainer ? iconContainer.querySelector('i, svg') : null;
        const type = options.type || 'info';
        if (iconContainer) {
            iconContainer.className = `mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4 ${type === 'warning' ? 'bg-red-100' : 'bg-blue-100'}`;
        }

        if (icon) {
            icon.setAttribute('data-lucide', type === 'warning' ? 'alert-triangle' : (type === 'info' ? 'check-circle-2' : 'help-circle'));
            icon.className = `w-6 h-6 ${type === 'warning' ? 'text-red-600' : 'text-blue-600'}`;
        }

        confirmBtn.innerHTML = options.confirmText || 'Confirmar';
        confirmBtn.className = "flex-1 py-2 text-white rounded-xl text-xs font-bold transition-colors shadow-lg " +
            (options.btnClass || (type === 'warning' ? 'bg-red-600 hover:bg-red-700 shadow-red-500/30' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-500/30'));

        if (options.extraHTML) {
            extraEl.innerHTML = options.extraHTML;
            extraEl.classList.remove('hidden');
        }

        // Assign handler directly
        confirmBtn.onclick = async () => {
            if (options.noCloseOnConfirm) {
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<i class="w-3 h-3 animate-spin border-2 border-white/30 border-t-white rounded-full"></i>';
                await onConfirm(async (successMsg) => {
                    if (iconContainer) {
                        iconContainer.className = "mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4 animate-bounce";
                        const finalIcon = iconContainer.querySelector('i, svg');
                        if (finalIcon) {
                            finalIcon.setAttribute('data-lucide', 'check-circle-2');
                            finalIcon.className = "w-6 h-6 text-green-600";
                        }
                    }
                    titleEl.textContent = '¬°√âxito!';
                    msgEl.textContent = successMsg || 'Acci√≥n completada con √©xito.';
                    msgEl.classList.add('text-green-600', 'font-bold');
                    extraEl.classList.add('hidden');
                    confirmBtn.style.display = 'none';
                    if (cancelBtn) cancelBtn.style.display = 'none';
                    lucide.createIcons();
                    setTimeout(() => closeConfirmModal(), 2000);
                });
            } else {
                closeConfirmModal();
                if (typeof onConfirm === 'function') onConfirm();
            }
        };

        lucide.createIcons();
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            container.classList.remove('scale-95');
            container.classList.add('scale-100');
        }, 10);
    }

    function closeConfirmModal() {
        const modal = document.getElementById('confirmationModal');
        const container = document.getElementById('confirmModalContent');
        if (!modal || !container) return;

        modal.classList.add('opacity-0');
        container.classList.remove('scale-100');
        container.classList.add('scale-95');

        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }, 300);
    }

    async function generarCronograma() {
        showConfirmModal(
            'Confirmar Generaci√≥n',
            'Esto guardar√° la configuraci√≥n actual y redistribuir√° todos los turnos. ¬øDeseas continuar?',
            async (showSuccess) => {
                try {
                    // 1. Save Config First
                    const saved = await guardarConfig(true); // silent save
                    if (!saved) return;

                    // 2. Generate
                    const resp = await fetch('{% url "generar_cronograma" %}', {
                        method: 'POST',
                        headers: { 'X-CSRFToken': CSRF_TOKEN }
                    });
                    const result = await resp.json();

                    if (resp.ok) {
                        showSuccess(result.message || 'Cronograma generado correctamente');
                        await refreshAllData();
                    } else {
                        // If we failed, we close the "loading" modal to show the error modal or toast
                        closeConfirmModal();
                        if (result.data && result.data.error_type === 'insufficient_slots') {
                            showErrorModal(result.data);
                        } else if (result.data && result.data.error_type === 'no_pending_turns') {
                            // Redirect to help modal if no data
                            openExcelFormatModal();
                            showToast('Aseg√∫rate de importar un archivo Excel v√°lido primero.', 'info');
                        } else {
                            showToast(result.data ? result.data.message : 'Error al procesar datos', 'error');
                        }
                    }
                } catch (error) {
                    console.error('Error:', error);
                    closeConfirmModal();
                    showToast('Error de comunicaci√≥n con el servidor. Verifica tu conexi√≥n.', 'error');
                }
            },
            {
                noCloseOnConfirm: true,
                confirmText: 'S√≠, Generar Ahora'
            }
        );
    }

    async function resetEverything() {
        showConfirmModal(
            '¬øReiniciar Sistema?',
            'Esta acci√≥n eliminar√° TODOS los turnos, responsables y configuraciones actuales. No se puede deshacer.',
            async () => {
                try {
                    const resp = await fetch('{% url "reset_database" %}', {
                        method: 'POST',
                        headers: { 'X-CSRFToken': CSRF_TOKEN }
                    });
                    const data = await resp.json();
                    if (resp.ok) {
                        showToast(data.message, 'success');
                        // Actualizar UI
                        await refreshAllData();
                    } else {
                        showToast(data.message, 'error');
                    }
                } catch (err) {
                    console.error('Error resetting database:', err);
                    showToast('Error al conectar con el servidor', 'error');
                }
            },
            {
                type: 'warning',
                confirmText: 'S√≠, Reiniciar Todo',
                btnClass: 'bg-rose-600 hover:bg-rose-700 shadow-rose-500/30'
            }
        );
    }

    function showErrorModal(data) {
        const modal = document.getElementById('errorModal');
        const container = document.getElementById('errorModalContainer');

        document.getElementById('errorSlotsGen').textContent = data.slots_generados;
        document.getElementById('errorDaysLab').textContent = `${data.dias_laborables} d√≠as laborales`;
        document.getElementById('errorSlotsMiss').textContent = data.faltantes;

        const percent = Math.round((data.slots_generados / data.usuarios_pendientes) * 100);
        document.getElementById('errorPercentText').textContent = `${percent}%`;

        const suggestionsList = document.getElementById('errorSuggestions');
        suggestionsList.innerHTML = data.sugerencias.map(s => `
            <li class="flex items-start gap-2 text-xs text-gray-600 font-medium">
                <span class="text-blue-500 mt-0.5">‚Ä¢</span>
                ${s}
            </li>
        `).join('');

        modal.classList.remove('hidden');
        modal.classList.add('flex');

        // Animations
        setTimeout(() => {
            container.classList.remove('scale-95', 'opacity-0');
            container.classList.add('scale-100', 'opacity-100');
            document.getElementById('errorProgressBar').style.width = `${percent}%`;
        }, 10);
    }

    function closeErrorModal() {
        const modal = document.getElementById('errorModal');
        const container = document.getElementById('errorModalContainer');

        container.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }, 200);
    }

    function showNoPendingModal() {
        // Simplified: Just show the format guide as it's the most likely solution
        openExcelFormatModal();
        showToast('No se encontraron datos pendientes para procesar.', 'warning');
    }

    function closeNoPendingModal() {
        const modal = document.getElementById('noPendingModal');
        const container = document.getElementById('noPendingModalContainer');
        container.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }, 200);
    }

    function renderHolidays(dates) {
        const list = document.getElementById('holidaysList');
        if (!list) return;
        list.innerHTML = dates.map(date => {
            const [y, m, d] = date.split('-');
            return `
                <span class="bg-yellow-100 text-yellow-800 text-[9px] px-1.5 py-0.5 rounded-full font-bold flex items-center gap-1">
                    ${d}/${m}
                    <button onclick="removeFeriado('${date}')" class="hover:text-red-600">√ó</button>
                </span>
            `;
        }).join('');
    }

    async function addFeriado() {
        const input = document.getElementById('newHolidayDate');
        const date = input.value;
        if (!date) return;

        const resp = await fetch('{% url "add_feriado" %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': CSRF_TOKEN, 'Content-Type': 'application/json' },
            body: JSON.stringify({ fecha: date })
        });
        const data = await resp.json();
        if (resp.ok) {
            renderHolidays(data.feriados);
            input.value = '';
            showToast('Feriado a√±adido');
        } else {
            showToast(data.message || 'Error', 'error');
        }
    }

    async function removeFeriado(date) {
        const resp = await fetch('{% url "remove_feriado" %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': CSRF_TOKEN, 'Content-Type': 'application/json' },
            body: JSON.stringify({ fecha: date })
        });
        const data = await resp.json();
        if (resp.ok) {
            renderHolidays(data.feriados);
            showToast('Feriado eliminado', 'info');
        }
    }

    async function resetSystem() {
        showConfirmModal(
            '‚ö†Ô∏è Reiniciar Sistema',
            'ATENCI√ìN: Esto borrar√° permanentemente todo el historial, configuraciones y usuarios. Esta acci√≥n no se puede deshacer.',
            async () => {
                try {
                    const resp = await fetch('{% url "reset_database" %}', {
                        method: 'POST',
                        headers: { 'X-CSRFToken': CSRF_TOKEN }
                    });
                    if (resp.ok) {
                        showToast('Sistema reiniciado. Recargando...', 'success');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showToast('Error al reiniciar', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showToast('Error de conexi√≥n', 'error');
                }
            }
        );
    }

    function changeMonth(dir) {
        currentMonth.setMonth(currentMonth.getMonth() + dir);
        initCalendar();
    }

    function updateStats() {
        const done = turnos.filter(t => t.estado === 'completado').length;
        const pendingTotal = turnos.filter(t => t.estado !== 'completado').length;

        // Update all possible stat elements
        const elements = {
            'statDone': done,
            'statDoneCount': done,
            'statPendingCount': pendingTotal
        };

        for (const [id, val] of Object.entries(elements)) {
            const el = document.getElementById(id);
            if (el) el.textContent = val;
        }
    }

    // --- LAYOUT & VIEWS LOGIC ---
    function toggleSidebar() {
        const sidebar = document.getElementById('leftSidebar');
        if (sidebar.classList.contains('-translate-x-full')) {
            sidebar.classList.remove('-translate-x-full', 'absolute', 'h-full', 'shadow-2xl');
            sidebar.classList.add('relative');
        } else {
            sidebar.classList.add('-translate-x-full', 'absolute', 'h-full', 'shadow-2xl');
            sidebar.classList.remove('relative');
        }
    }

    let currentView = 'month'; // 'month', 'week', 'day'

    function switchView(view) {
        currentView = view;

        // View Buttons
        const btnMonth = document.getElementById('btnViewMonth');
        const btnWeek = document.getElementById('btnViewWeek');
        const btnDay = document.getElementById('btnViewDay');

        [btnMonth, btnWeek, btnDay].forEach(btn => {
            if (btn) {
                btn.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
                btn.classList.add('text-gray-500');
            }
        });

        const activeBtn = { 'month': btnMonth, 'week': btnWeek, 'day': btnDay }[view];
        if (activeBtn) {
            activeBtn.classList.remove('text-gray-500');
            activeBtn.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
        }

        // View Containers
        const monthV = document.getElementById('monthView');
        const weekV = document.getElementById('weekView');
        const dayV = document.getElementById('dayView');

        if (monthV) monthV.classList.add('hidden');
        if (weekV) weekV.classList.add('hidden');
        if (dayV) dayV.classList.add('hidden');

        const activeView = { 'month': monthV, 'week': weekV, 'day': dayV }[view];
        if (activeView) activeView.classList.remove('hidden');

        const label = document.getElementById('currentViewLabel');
        if (label) {
            label.textContent = `Vista ${view === 'month' ? 'Mensual' : (view === 'week' ? 'Semanal' : 'Diaria')}`;
        }

        updateCalendarView();
    }

    function updateCalendarView() {
        // Update Date Display
        const dateDisplay = document.getElementById('calendarDateDisplay');

        if (currentView === 'month') {
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            if (dateDisplay) dateDisplay.textContent = `${months[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;
            initCalendar(); // Existing render logic
        } else if (currentView === 'week') {
            renderWeekView();
        } else if (currentView === 'day') {
            renderDayView();
        }
    }

    function navigateCalendar(dir) {
        const dateDisplay = document.getElementById('calendarDateDisplay');
        if (currentView === 'month') {
            currentMonth.setMonth(currentMonth.getMonth() + dir);
        } else if (currentView === 'week') {
            currentMonth.setDate(currentMonth.getDate() + (dir * 7));
        } else if (currentView === 'day') {
            currentMonth.setDate(currentMonth.getDate() + dir);
        }
        updateCalendarView();
    }

    // --- WEEK VIEW IMPLEMENTATION ---
    function renderWeekView() {
        const container = document.getElementById('weekGrid');
        const header = document.getElementById('weekHeader');
        const dateDisplay = document.getElementById('calendarDateDisplay');

        // Find start of week (Sunday)
        const startOfWeek = new Date(currentMonth);
        startOfWeek.setDate(currentMonth.getDate() - currentMonth.getDay());

        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);

        dateDisplay.textContent = `${startOfWeek.getDate()} ${startOfWeek.toLocaleString('es-ES', { month: 'short' })} - ${endOfWeek.getDate()} ${endOfWeek.toLocaleString('es-ES', { month: 'short' })}`;

        // Render Header
        let headerHTML = '<div class="p-3 border-r border-gray-100 text-[10px] text-gray-400 font-bold text-center">HORA</div>';
        const weekDays = [];
        for (let i = 0; i < 7; i++) {
            const d = new Date(startOfWeek);
            d.setDate(startOfWeek.getDate() + i);
            weekDays.push(d);
            const isToday = new Date().toDateString() === d.toDateString();
            headerHTML += `
                    <div class="p-2 text-center border-r border-gray-100 cursor-pointer hover:bg-gray-100 transition ${isToday ? 'bg-blue-50' : ''}"
                         onclick="event.stopPropagation(); openDayDetailPanel('${d.toISOString().split('T')[0]}')">
                        <div class="text-[10px] font-bold text-gray-400 uppercase">${d.toLocaleString('es-ES', { weekday: 'short' })}</div>
                        <div class="text-lg font-black ${isToday ? 'text-blue-600' : 'text-gray-900'}">${d.getDate()}</div>
                    </div>
                `;
        }
        header.innerHTML = headerHTML;

        // Render Grid (Time slots 8am - 6pm)
        let gridHTML = '';
        for (let hour = 8; hour <= 18; hour++) {
            const timeStr = `${hour.toString().padStart(2, '0')}:00`;
            gridHTML += `<div class="grid grid-cols-8 border-b border-gray-100 min-h-[80px]">`;
            gridHTML += `<div class="p-2 text-center text-xs text-gray-400 font-bold border-r border-gray-100 sticky left-0 bg-white">${timeStr}</div>`;

            for (let i = 0; i < 7; i++) {
                const d = weekDays[i];
                const dStr = d.toISOString().split('T')[0];
                const slotTurnos = turnos.filter(t => t.fecha === dStr && t.hora.startsWith(hour.toString().padStart(2, '0')));

                const isExcluded = isDayExcluded(dStr);
                const cellClass = isExcluded ? "bg-gray-100/50" : "hover:bg-gray-50 cursor-pointer";
                // Remove handleDayDrop to enforce Swap-Only in Weekly View
                // Only keep onclick for opening day panel if user clicks the cell background
                const interactionHandlers = isExcluded ? "" : `onclick="if(event.target === this) openManualTurnModal('${dStr}', '${timeStr}')"`;

                gridHTML += `<div class="p-1 border-r border-gray-100 relative group transition-colors ${cellClass}"
                                     ${interactionHandlers} title="${isExcluded ? 'D√≠a no laborable' : 'Haga clic para a√±adir turno en esta hora'}">`;

                slotTurnos.forEach(t => {
                    const card = createCard(t);
                    card.classList.add('mb-1');
                    gridHTML += card.outerHTML;
                });

                gridHTML += `</div>`;
            }
            gridHTML += `</div>`;
        }
        container.innerHTML = gridHTML;
        lucide.createIcons();
    }

    // --- DAY VIEW IMPLEMENTATION ---
    function renderDayView() {
        const container = document.getElementById('dayListContainer');
        const title = document.getElementById('dayViewTitle');
        const countBadge = document.getElementById('dayViewCount');
        const dateDisplay = document.getElementById('calendarDateDisplay');

        const dStr = currentMonth.toISOString().split('T')[0];
        dateDisplay.textContent = currentMonth.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

        title.textContent = dateDisplay.textContent.toUpperCase();

        const dayTurnos = turnos.filter(t => t.fecha === dStr);
        dayTurnos.sort((a, b) => a.hora.localeCompare(b.hora)); // Sort by time

        countBadge.textContent = `${dayTurnos.length} Turnos`;

        if (dayTurnos.length === 0) {
            container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-gray-400 p-8 text-center border-2 border-dashed border-gray-100 rounded-2xl bg-gray-50/30">
                        <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mb-4 shadow-sm">
                            <i data-lucide="calendar-plus" class="w-10 h-10 text-blue-500 opacity-40"></i>
                        </div>
                        <h4 class="font-black text-gray-900 uppercase tracking-tight mb-2">D√≠a Disponible</h4>
                        <p class="text-sm font-medium leading-relaxed mb-6 max-w-sm">
                            No hay tareas programadas para esta fecha. ¬øDeseas a√±adir un turno manual?
                        </p>
                        <button onclick="openManualTurnModal('${dStr}')" 
                                class="px-8 py-3 bg-blue-600 text-white rounded-xl font-black text-xs uppercase tracking-widest hover:bg-blue-700 transition-all active:scale-95 shadow-lg shadow-blue-500/20 flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i> A√±adir Turno Ahora
                        </button>
                    </div>
                `;
        } else {
            container.innerHTML = '';
            dayTurnos.forEach(t => {
                const card = createShiftCardForPanel(t);
                card.removeAttribute('draggable');
                container.appendChild(card);
            });
        }
        lucide.createIcons();
    }

    window.onload = () => {
        initCalendar();
        updateStats();
        renderPendingAssets();
        updateStepStatus();
    };


    // --- WIZARD LOGIC ---
    let wizardQuill = null;
    let wizardCurrentStep = 1;
    let selectedRecipients = new Set();
    let groupedRecipients = {}; // { "YYYY-MM-DD": [turnos] }

    function openWizard() {
        // 1. Reset State
        wizardCurrentStep = 1;
        selectedRecipients.clear();
        groupedRecipients = {};
        document.getElementById('wizardStep1').classList.remove('hidden');
        document.getElementById('wizardStep1').classList.add('active-step');
        document.getElementById('wizardStep2').classList.remove('active-step');
        document.getElementById('wizardStep2').classList.add('hidden');
        document.getElementById('wizardStep3').classList.remove('active-step');
        document.getElementById('wizardStep3').classList.add('hidden');
        document.getElementById('wizardAsunto').value = 'Recordatorio de Mantenimiento Preventivo';

        // 2. Initialize Quill
        initWizardQuill();

        // 3. Load default message if empty
        if (wizardQuill && wizardQuill.getText().trim().length < 2) {
            insertPlaceholderWizard();
        }

        // 4. Show Modal
        const modal = document.getElementById('wizardModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        setTimeout(() => {
            document.getElementById('wizardModalContainer').classList.remove('scale-95', 'opacity-0');
            document.getElementById('wizardModalContainer').classList.add('scale-100', 'opacity-100');
        }, 10);

        updateWizardUI();
    }

    function closeWizard() {
        const modal = document.getElementById('wizardModal');
        const container = document.getElementById('wizardModalContainer');
        container.classList.remove('scale-100', 'opacity-100');
        container.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        }, 300);
    }

    function initWizardQuill() {
        if (wizardQuill) return;
        const editor = document.getElementById('wizardEditor');
        if (!editor) return;

        wizardQuill = new Quill('#wizardEditor', {
            theme: 'snow',
            placeholder: 'Escribe tu mensaje aqu√≠...',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline'],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    ['link', 'clean']
                ]
            }
        });

        // Sync to hidden input
        wizardQuill.on('text-change', () => {
            const txt = wizardQuill.root.innerHTML;
            document.getElementById('hidden_cuerpo').value = txt;
            updateWizardPreview();
        });
    }

    function insertPlaceholderWizard() {
        if (wizardQuill) {
            wizardQuill.clipboard.dangerouslyPasteHTML(`
                 <p>Estimado/a colega,</p>
                 <p><br></p>
                 <p>Se le informa que tiene un mantenimiento programado.<br>Por favor, confirme la disponibilidad del equipo.</p>
                 <p><br></p>
                 <p>Saludos cordiales,</p>
                 <p><strong>Dpto. de Mantenimiento</strong></p>
             `);
        }
    }

    function updateWizardUI() {
        // Progress Bar
        const progress = document.getElementById('wizardProgress');
        const percentage = (wizardCurrentStep / 3) * 100;
        progress.style.width = `${percentage}%`;

        // Step Title
        const items = ["Configuraci√≥n", "Destinatarios", "Confirmaci√≥n"];
        document.getElementById('wizardStepTitle').textContent = `Paso ${wizardCurrentStep}: ${items[wizardCurrentStep - 1]}`;

        // Buttons
        const prevBtn = document.getElementById('wizardPrevBtn');
        const nextBtn = document.getElementById('wizardNextBtn');
        const sendBtn = document.getElementById('wizardSendBtn');

        prevBtn.disabled = wizardCurrentStep === 1;

        if (wizardCurrentStep === 3) {
            nextBtn.classList.add('hidden');
            sendBtn.classList.remove('hidden');
            // Update counts in Step 3
            document.getElementById('finalCount').textContent = selectedRecipients.size;
        } else {
            nextBtn.classList.remove('hidden');
            sendBtn.classList.add('hidden');
        }

        // Visibility of Steps handled in moveStep usually, but ensure classes
        for (let i = 1; i <= 3; i++) {
            const stepDiv = document.getElementById(`wizardStep${i}`);
            if (i === wizardCurrentStep) {
                stepDiv.classList.add('active-step');
                stepDiv.classList.remove('hidden');
                stepDiv.style.display = 'flex'; // Enforce flex
            } else {
                stepDiv.classList.remove('active-step');
                stepDiv.classList.add('hidden');
                stepDiv.style.display = 'none';
            }
        }
        lucide.createIcons();
    }

    function moveStep(step) {
        if (step > wizardCurrentStep) {
            // Validate Step 1
            if (wizardCurrentStep === 1) {
                if (!wizardQuill || wizardQuill.getText().trim().length < 5) {
                    showToast('Escribe un mensaje v√°lida (m√≠nimo 5 caracteres)', 'error');
                    return;
                }
                const asunto = document.getElementById('wizardAsunto').value;
                if (!asunto) {
                    showToast('El asunto es obligatorio', 'error');
                    return;
                }
                loadRecipients(); // Trigger load when moving to 2
            }
            // Validate Step 2
            if (wizardCurrentStep === 2) {
                if (selectedRecipients.size === 0) {
                    showToast('Selecciona al menos un destinatario', 'error');
                    return;
                }
                updateWizardPreview(); // Update preview for step 3
            }
        }

        wizardCurrentStep = step;
        updateWizardUI();
    }

    function loadRecipients() {
        const listContainer = document.getElementById('recipientsList');
        listContainer.innerHTML = '<div class="text-center py-8"><i class="animate-spin" data-lucide="loader-2"></i> Cargando...</div>';
        lucide.createIcons();

        // FILTER TURNOS FOR VISIBLE WEEK or MONTH
        let startOfWeek, endOfWeek;

        if (currentView === 'week') {
            startOfWeek = new Date(currentMonth);
            startOfWeek.setDate(currentMonth.getDate() - currentMonth.getDay());
            startOfWeek.setHours(0, 0, 0, 0);

            endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);
        } else {
            // If in Month view, take current week relative to today
            const today = new Date();
            const dayOfWeek = today.getDay() || 7;
            startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - dayOfWeek + 1);
            startOfWeek.setHours(0, 0, 0, 0);

            endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);
        }

        // Filter
        const weekTurnos = turnos.filter(t => {
            const tDate = new Date(t.fecha + 'T00:00:00');
            return tDate >= startOfWeek && tDate <= endOfWeek && t.estado !== 'completado';
        });

        // Group by Date for Accordion
        groupedRecipients = {};
        weekTurnos.forEach(t => {
            if (!groupedRecipients[t.fecha]) groupedRecipients[t.fecha] = [];
            groupedRecipients[t.fecha].push(t);
        });

        // Render Accordion
        if (Object.keys(groupedRecipients).length === 0) {
            listContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center py-12 text-gray-400">
                    <i data-lucide="calendar-off" class="w-12 h-12 mb-3 opacity-20"></i>
                    <p class="text-xs font-medium">No hay mantenimientos pendientes para esta semana.</p>
                </div>`;
            lucide.createIcons();
            return;
        }

        let html = '';
        // Sort dates
        const sortedDates = Object.keys(groupedRecipients).sort();

        sortedDates.forEach(dateStr => {
            const dayTurnos = groupedRecipients[dateStr];
            const allSelectedForDay = dayTurnos.every(t => selectedRecipients.has(t.id));

            // Accordion Item
            html += `
                <div class="border border-gray-200 rounded-xl overflow-hidden mb-2">
                    <div class="w-full bg-gray-50/50 p-4 flex justify-between items-center hover:bg-gray-100 transition group cursor-pointer" onclick="toggleWizardAccordion('${dateStr}', event)">
                           <div class="flex items-center gap-3">
                                <input type="checkbox" onchange="toggleDayWizardSelection('${dateStr}', this.checked, event)" 
                                    class="size-4 rounded text-blue-600 focus:ring-blue-500 border-gray-300" 
                                    ${allSelectedForDay ? 'checked' : ''} onclick="event.stopPropagation()">
                                <span class="size-2 rounded-full bg-blue-500"></span>
                                <span class="font-bold text-xs uppercase text-gray-700">${formatDateFriendly(dateStr)}</span>
                                <span class="px-2 py-0.5 rounded-full bg-blue-100 text-blue-700 text-[9px] font-black">${dayTurnos.length}</span>
                           </div>
                           <i id="wiz-arrow-${dateStr}" data-lucide="chevron-down" class="w-4 h-4 text-gray-400 group-hover:text-blue-500 transition-colors"></i>
                    </div>
                    <div id="wiz-content-${dateStr}" class="hidden p-2 bg-white space-y-1 border-t border-gray-100">
            `;

            // Turnos Items
            dayTurnos.forEach(t => {
                const isSelected = selectedRecipients.has(t.id);
                html += `
                    <label class="flex items-center gap-3 p-3 hover:bg-blue-50 rounded-lg cursor-pointer transition border border-transparent hover:border-blue-100">
                        <input type="checkbox" value="${t.id}" ${isSelected ? 'checked' : ''} onchange="toggleWizardSelection(${t.id})" 
                            class="size-4 rounded text-blue-600 focus:ring-blue-500 border-gray-300">
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-baseline mb-1">
                                 <span class="font-black text-xs text-gray-800 uppercase truncate pr-2">${t.responsable}</span>
                                 <span class="text-[10px] font-bold text-gray-400 bg-gray-50 px-1.5 py-0.5 rounded">${t.hora}</span>
                            </div>
                            <div class="text-[10px] text-gray-500 truncate flex items-center gap-1.5">
                                <i data-lucide="monitor" class="w-3 h-3 opacity-50"></i>
                                ${t.equipos.map(e => e.marca + ' ' + e.modelo).join(', ')}
                            </div>
                        </div>
                    </label>
                `;
            });

            html += `</div></div>`;
        });

        listContainer.innerHTML = html;
        lucide.createIcons();
    }

    function formatDateFriendly(dateStr) {
        const [y, m, d] = dateStr.split('-');
        const date = new Date(y, m - 1, d);
        return date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
    }

    function toggleWizardAccordion(dateStr, e) {
        if (e) e.preventDefault();
        const content = document.getElementById(`wiz-content-${dateStr}`);
        const arrow = document.getElementById(`wiz-arrow-${dateStr}`);
        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            arrow.classList.add('rotate-180');
        } else {
            content.classList.add('hidden');
            arrow.classList.remove('rotate-180');
        }
    }

    function toggleWizardSelection(id) {
        id = Number(id);
        if (selectedRecipients.has(id)) {
            selectedRecipients.delete(id);
        } else {
            selectedRecipients.add(id);
        }
        document.getElementById('wizardSelectedCount').textContent = selectedRecipients.size;
    }

    function toggleDayWizardSelection(dateStr, select, e) {
        if (e) e.stopPropagation();
        const dayTurnos = groupedRecipients[dateStr] || [];
        dayTurnos.forEach(t => {
            if (select) selectedRecipients.add(t.id);
            else selectedRecipients.delete(t.id);
        });

        // Update checkboxes UI
        const content = document.getElementById(`wiz-content-${dateStr}`);
        if (content) {
            const checks = content.querySelectorAll('input[type="checkbox"]');
            checks.forEach(c => c.checked = select);
        }

        document.getElementById('wizardSelectedCount').textContent = selectedRecipients.size;
    }

    function toggleAllWizard(select) {
        const checkboxes = document.querySelectorAll('#recipientsList input[type="checkbox"]');
        checkboxes.forEach(cb => {
            cb.checked = select;
            const id = Number(cb.value);
            if (select) selectedRecipients.add(id);
            else selectedRecipients.delete(id);
        });
        document.getElementById('wizardSelectedCount').textContent = selectedRecipients.size;
    }

    function updateWizardPreview() {
        if (!wizardQuill) return;
        const html = wizardQuill.root.innerHTML;
        // Basic variable replacement simulation (optional)
        // For now just show the raw body as it will appear
        document.getElementById('wizardPreviewContent').innerHTML = html;
    }

    // --- STREAMING SENDING PROCESS ---
    async function startSendingProcess() {
        if (selectedRecipients.size === 0) {
            showToast('Selecciona al menos un destinatario', 'error');
            return;
        }

        const modal = document.getElementById('streamingProgressModal');
        const progressBar = document.getElementById('streamProgressBarFill');
        const progressText = document.getElementById('streamProgressText');
        const statusText = document.getElementById('streamStatusText');
        const closeBtn = document.getElementById('streamCloseBtn');

        // 1. Save current Wizard Text/Asunto as Global Config via AJAX
        statusText.textContent = 'Guardando configuraci√≥n...';
        modal.classList.remove('hidden');
        closeBtn.classList.add('hidden');

        const asunto = document.getElementById('wizardAsunto').value;
        const cuerpo = wizardQuill.root.innerHTML;

        const formData = new FormData();
        formData.append('asunto_template', asunto);
        formData.append('cuerpo_template', cuerpo);
        formData.append('activar_anticipado', 'on'); // Wizard logic usually implies active

        try {
            const saveResp = await fetch('/notifications/config/guardar-global/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': CSRF_TOKEN,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            });

            if (!saveResp.ok) throw new Error('No se pudo guardar la configuraci√≥n');

        } catch (err) {
            showToast('Error al preparar env√≠o: ' + err.message, 'error');
            modal.classList.add('hidden');
            return;
        }

        // 2. Start Streaming
        const ids = Array.from(selectedRecipients).join(',');
        statusText.textContent = 'Iniciando conexi√≥n...';

        try {
            const response = await fetch(`/notifications/stream-envio-masivo/?ids=${ids}`);
            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (!line.trim()) continue;
                    try {
                        const data = JSON.parse(line);

                        if (data.progress !== undefined) {
                            progressBar.style.width = `${data.progress}%`;
                        }
                        if (data.status) {
                            statusText.textContent = data.status;
                        }
                        if (data.sent !== undefined && data.total !== undefined) {
                            progressText.textContent = `${data.sent} de ${data.total}`;
                        }
                        if (data.completed) {
                            statusText.textContent = '¬°Proceso completado!';
                            statusText.classList.remove('text-gray-500');
                            statusText.classList.add('text-green-600');
                            closeBtn.classList.remove('hidden');

                            showToast(`Env√≠o finalizado: ${data.sent} √©xitos, ${data.errors} fallos.`);
                            refreshAllData();
                        }
                        if (data.error) {
                            statusText.textContent = data.status;
                            statusText.classList.add('text-red-600');
                            closeBtn.classList.remove('hidden');
                            showToast(data.status, 'error');
                        }
                    } catch (e) {
                        console.error("Error parsing NDJSON:", e, line);
                    }
                }
            }
        } catch (err) {
            console.error("Streaming error:", err);
            statusText.textContent = 'Error en la conexi√≥n de streaming';
            statusText.classList.add('text-red-600');
            closeBtn.classList.remove('hidden');
        }
    }
</script>
{% endblock %}