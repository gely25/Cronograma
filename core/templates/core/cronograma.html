{% extends 'core/base.html' %}

{% block title %}Sistema de Cronograma de Mantenimiento{% endblock %}

{% block extra_head %}
<style>
    .calendar-day {
        background: white;
        border: 2px solid var(--border);
        border-radius: 12px;
        min-height: 120px;
        padding: 0.75rem;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        cursor: pointer;
        position: relative;
    }

    .calendar-day:hover {
        border-color: var(--blue);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        transform: translateY(-2px);
    }

    .calendar-day.weekend {
        background: #f8f9fa;
        opacity: 0.6;
    }

    .calendar-day.holiday {
        background: #fef3c7;
        border-color: #f59e0b;
    }

    .calendar-day.other-month {
        opacity: 0.3;
        pointer-events: none;
    }

    .calendar-day.today .day-number {
        background: var(--blue);
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
    }

    /* Shift count badge */
    .shift-count-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 24px;
        height: 24px;
        padding: 0 8px;
        background: var(--blue-pastel);
        color: var(--blue-text);
        border-radius: 12px;
        font-size: 11px;
        font-weight: 800;
        letter-spacing: -0.02em;
    }

    .shift-count-badge.has-completed {
        background: var(--green-pastel);
        color: var(--green-text);
    }

    .shift-count-badge.has-in-progress {
        background: var(--yellow-pastel);
        color: var(--yellow-text);
    }



    /* Drag & Drop states */
    .calendar-day.drag-over {
        border-color: var(--blue);
        background: var(--blue-pastel);
        border-width: 3px;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .calendar-day.drag-source {
        opacity: 0.5;
    }

    /* Shift cards in detail panel */
    .appointment-card {
        background: var(--blue-pastel);
        color: var(--blue-text);
        padding: 0.75rem;
        border-radius: 12px;
        cursor: move;
        font-size: 0.875rem;
        border: 2px solid rgba(30, 64, 175, 0.15);
        transition: all 0.2s ease;
    }

    .appointment-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(30, 64, 175, 0.25);
    }

    .appointment-card.completed {
        background: var(--green-pastel);
        color: var(--green-text);
        border-color: rgba(6, 95, 70, 0.15);
    }

    .appointment-card.in-progress {
        background: var(--yellow-pastel);
        color: var(--yellow-text);
        border-color: rgba(146, 64, 14, 0.15);
    }

    .appointment-card.dragging {
        opacity: 0.5;
        transform: rotate(2deg);
    }
</style>
{% endblock %}

{% block content %}
<!-- TOAST NOTIFICATIONS -->
<div id="toastContainer" class="fixed top-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none"></div>

<!-- MAIN LAYOUT CONTAINER -->
<div class="flex h-screen overflow-hidden bg-gray-50/50">

    <!-- 1. LEFT SIDEBAR (Config & Tools) -->
    <aside id="leftSidebar" class="w-80 bg-white border-r border-gray-200 flex flex-col transition-all duration-300 z-30 relative">
        <!-- Sidebar Header -->
        <div class="p-6 border-b border-gray-100 flex justify-between items-start">
            <div>
                <h2 class="text-xl font-black tracking-tight text-gray-900">TechScheduler</h2>
                <p class="text-xs text-gray-400 font-bold uppercase tracking-wider mt-1">Gesti√≥n de Cronogramas</p>
            </div>
            <button onclick="toggleSidebar()" class="lg:hidden text-gray-400 hover:text-gray-600">
                <i data-lucide="chevrons-left" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto custom-scrollbar">
            
            <!-- Upload Section -->
            <div class="p-4 border-b border-gray-100">
                <form action="{% url 'upload_excel' %}" method="POST" enctype="multipart/form-data" id="uploadForm"
                    class="relative border-2 border-dashed border-blue-100 rounded-xl p-6 transition-all hover:bg-blue-50/50 hover:border-blue-400 group text-center"
                    ondragover="handleUploadDragOver(event)" ondragleave="handleUploadDragLeave(event)"
                    ondrop="handleUploadDrop(event)">
                    {% csrf_token %}
                    <input type="file" name="archivo" id="fileInput" class="hidden" onchange="submitUpload()">
                    <div class="cursor-pointer" onclick="document.getElementById('fileInput').click()">
                        <div class="mb-3 group-hover:scale-110 transition-transform inline-block p-3 rounded-full bg-blue-50 text-blue-500">
                            <i data-lucide="upload-cloud" class="w-6 h-6"></i>
                        </div>
                        <p id="uploadText" class="text-xs font-bold text-gray-600">Subir archivo Excel</p>
                        <p class="text-[10px] text-gray-400 mt-1">Arrastre o haga clic</p>
                        <p id="fileName" class="text-[10px] text-blue-600 font-black mt-2 truncate hidden"></p>
                    </div>
                </form>
                <div class="mt-3 flex justify-end">
                    <button onclick="resetSystem()"
                        class="text-[10px] font-black uppercase tracking-widest text-red-400 hover:text-red-600 flex items-center gap-1.5 py-2 px-3 hover:bg-red-50 rounded-lg transition-colors">
                        <i data-lucide="trash-2" class="w-3 h-3"></i> Reiniciar
                    </button>
                </div>
            </div>

            <!-- Configuration Section -->
            <div class="p-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xs font-black text-gray-900 uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="settings-2" class="w-3 h-3 text-gray-400"></i> Configuraci√≥n
                    </h3>
                </div>
                
                <form id="configForm" class="space-y-4">
                    <!-- Periodo -->
                    <div class="bg-gray-50 rounded-xl p-3 border border-gray-100">
                        <span class="text-[10px] font-bold text-gray-500 uppercase block mb-2">Per√≠odo del Cronograma</span>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label for="fechaInicio" class="sr-only">Inicio</label>
                                <input type="date" name="fecha_inicio" id="fechaInicio"
                                    value="{% if config %}{{ config.fecha_inicio|date:'Y-m-d' }}{% endif %}"
                                    class="w-full text-xs font-medium text-gray-700 bg-white border-gray-200 rounded-lg focus:border-blue-500 focus:ring-0">
                            </div>
                            <div>
                                <label for="fechaFin" class="sr-only">Fin</label>
                                <input type="date" name="fecha_fin" id="fechaFin"
                                    value="{% if config %}{{ config.fecha_fin|date:'Y-m-d' }}{% endif %}"
                                    class="w-full text-xs font-medium text-gray-700 bg-white border-gray-200 rounded-lg focus:border-blue-500 focus:ring-0">
                            </div>
                        </div>
                    </div>

                    <!-- Horario -->
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase block mb-1">Inicio Jornada</label>
                                <input type="time" name="hora_inicio" id="horaInicio"
                                    value="{% if config %}{{ config.hora_inicio|time:'H:i' }}{% else %}08:00{% endif %}"
                                    class="w-full text-xs font-bold text-gray-700 bg-white border-gray-200 rounded-lg">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase block mb-1">Fin Jornada</label>
                                <input type="time" name="hora_fin" id="horaFin"
                                    value="{% if config %}{{ config.hora_fin|time:'H:i' }}{% else %}17:00{% endif %}"
                                    class="w-full text-xs font-bold text-gray-700 bg-white border-gray-200 rounded-lg">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase block mb-1">Duraci√≥n Turno</label>
                                <div class="relative">
                                    <input type="number" name="duracion_turno" id="duracionTurno"
                                        value="{% if config %}{{ config.duracion_turno }}{% else %}30{% endif %}"
                                        class="w-full text-xs font-bold text-gray-700 bg-white border-gray-200 rounded-lg pr-8">
                                    <span class="absolute right-2 top-1.5 text-[10px] text-gray-400 font-bold">min</span>
                                </div>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase block mb-1">Almuerzo</label>
                                <div class="relative">
                                    <input type="number" name="duracion_almuerzo" id="duracionAlmuerzo"
                                        value="{% if config %}{{ config.duracion_almuerzo }}{% else %}60{% endif %}"
                                        class="w-full text-xs font-bold text-gray-700 bg-white border-gray-200 rounded-lg pr-8">
                                    <span class="absolute right-2 top-1.5 text-[10px] text-gray-400 font-bold">min</span>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase block mb-1">Inicio Almuerzo</label>
                            <input type="time" name="hora_almuerzo" id="horaAlmuerzo"
                                value="{% if config %}{{ config.hora_almuerzo|time:'H:i' }}{% else %}12:00{% endif %}"
                                class="w-full text-xs font-bold text-gray-700 bg-white border-gray-200 rounded-lg">
                        </div>
                    </div>

                    <!-- Exclusion -->
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase block mb-1">D√≠as Laborables</label>
                        <select name="modo_exclusion" id="modoExclusion" class="w-full text-xs font-bold text-gray-700 bg-white border-gray-200 rounded-lg">
                            <option value="none" {% if config and config.modo_exclusion == 'none' %}selected{% endif %}>Todos los d√≠as</option>
                            <option value="sundays" {% if config and config.modo_exclusion == 'sundays' %}selected{% endif %}>Lun a S√°b (Excluir Dom)</option>
                            <option value="weekends" {% if not config or config.modo_exclusion == 'weekends' %}selected{% endif %}>Lun a Vie (Excluir Fines)</option>
                        </select>
                    </div>

                    <!-- Holidays -->
                    <div class="bg-yellow-50/50 rounded-xl p-3 border border-yellow-100">
                        <label class="text-[10px] font-bold text-yellow-600 uppercase block mb-2">Feriados</label>
                        <div class="flex gap-2 mb-2">
                            <input type="date" id="newHolidayDate" class="flex-1 text-xs rounded-lg border-gray-200" aria-label="Fecha feriado">
                            <button type="button" onclick="addFeriado()" class="bg-yellow-400 text-yellow-900 rounded-lg px-3 font-bold hover:bg-yellow-500 transition">+</button>
                        </div>
                        <div class="flex flex-wrap gap-1.5" id="holidaysList">
                            {% for f in feriados %}
                            <span class="bg-white border border-yellow-200 text-yellow-700 text-[10px] px-2 py-1 rounded-md font-bold flex items-center gap-1.5 shadow-sm">
                                {{ f.fecha|date:"d/m" }}
                                <button onclick="removeFeriado('{{ f.fecha|date:'Y-m-d' }}')" class="hover:text-red-500 transition">√ó</button>
                            </span>
                            {% endfor %}
                        </div>
                    </div>

                    <button type="button" onclick="guardarConfig()"
                        class="w-full py-2 bg-gray-900 text-white rounded-lg font-bold text-xs hover:bg-black transition flex items-center justify-center gap-2 shadow-lg shadow-gray-200">
                        <i data-lucide="save" class="w-3 h-3"></i> Guardar Configuraci√≥n
                    </button>
                </form>
            </div>



            <!-- Notifications Link -->
            <div class="p-4 border-t border-gray-100">
                 <a href="{% url 'notifications_dashboard' %}" class="flex items-center justify-between group p-2 hover:bg-gray-50 rounded-lg transition-all">
                    <h3 class="text-xs font-black text-gray-900 uppercase tracking-widest flex items-center gap-2 group-hover:text-indigo-600">
                        <i data-lucide="brain-circuit" class="w-4 h-4 text-gray-400 group-hover:text-indigo-500"></i> Smart Notificaciones 
                    </h3>
                    <i data-lucide="arrow-right" class="w-3 h-3 text-gray-400 group-hover:text-indigo-500"></i>
                </a>
            </div>

            <!-- Pending Teams (Compact) -->
            <div class="p-4 border-t border-gray-100">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-xs font-black text-gray-900 uppercase tracking-widest">Pendientes</h3>
                    <span class="bg-blue-100 text-blue-700 text-[10px] font-black px-2 py-0.5 rounded-full" id="statPendingCountSidebar">0</span>
                </div>
                <div id="pendingAssetsPanelSidebar" class="space-y-2 max-h-60 overflow-y-auto pr-1">
                    <!-- JS Rendered -->
                </div>
            </div>
        </div>

        <!-- Regenerate Button (Stick to bottom) -->
        <div class="p-4 border-t border-gray-100 bg-white">
            <button onclick="generarCronograma()"
                class="w-full py-3 bg-gradient-to-r from-amber-400 to-amber-500 text-white rounded-xl font-black text-xs shadow-lg shadow-amber-200 hover:shadow-xl hover:from-amber-500 hover:to-amber-600 transition-all transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
                <i data-lucide="zap" class="w-4 h-4 fill-current"></i> REGENERAR TODO
            </button>
        </div>
    </aside>

    <!-- 2. MAIN CALENDAR AREA -->
    <main class="flex-1 flex flex-col min-w-0 bg-gray-50/50 relative">
        <!-- Main Header -->
        <header class="bg-white border-b border-gray-200 px-8 py-4 flex items-center justify-between shadow-sm z-20">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 rounded-lg text-gray-500 transition" title="Toggle Sidebar">
                    <i data-lucide="menu" class="w-5 h-5"></i>
                </button>
                <div>
                    <h1 class="text-2xl font-black text-gray-900 tracking-tight">Calendario de Mantenimiento</h1>
                    <div class="flex items-center gap-2 text-xs text-gray-500 font-medium">
                        <span>Planificaci√≥n Din√°mica</span>
                        <span class="w-1 h-1 bg-gray-300 rounded-full"></span>
                        <span id="currentViewLabel">Vista Mensual</span>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <!-- View Selector -->
                <div class="bg-gray-100 p-1 rounded-xl flex items-center">
                    <button onclick="switchView('month')" id="btnViewMonth" class="px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all bg-white text-gray-900 shadow-sm">
                        Mensual
                    </button>
                    <button onclick="switchView('week')" id="btnViewWeek" class="px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-widest text-gray-500 hover:text-gray-900 transition-all">
                        Semanal
                    </button>
                    <button onclick="switchView('day')" id="btnViewDay" class="px-3 py-2.5 rounded-lg text-[10px] font-black uppercase tracking-widest text-gray-500 hover:text-gray-900 transition-all">
                        Diaria
                    </button>
                </div>

                <!-- Navigation -->
                <div class="flex items-center bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
                    <button onclick="navigateCalendar(-1)" class="p-2.5 hover:bg-gray-50 text-gray-600 border-r border-gray-100 transition">
                        <i data-lucide="chevron-left" class="w-4 h-4"></i>
                    </button>
                    <span id="calendarDateDisplay" class="px-6 py-2 text-xs font-black text-gray-900 min-w-[150px] text-center uppercase tracking-widest">
                        -
                    </span>
                    <button onclick="navigateCalendar(1)" class="p-2.5 hover:bg-gray-50 text-gray-600 border-l border-gray-100 transition">
                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    </button>
                </div>

                <a href="{% url 'notifications_dashboard' %}"
                    class="px-5 py-2.5 bg-white border border-gray-200 text-gray-700 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-sm hover:bg-gray-50 hover:text-blue-600 transition-all flex items-center gap-2 whitespace-nowrap">
                    <i data-lucide="bell" class="w-4 h-4"></i> Gestor Notif.
                </a>
                <a href="{% url 'exportar_excel' %}"
                    class="px-5 py-2.5 bg-blue-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-blue-100 hover:bg-blue-700 hover:shadow-xl transition-all flex items-center gap-2 whitespace-nowrap">
                    <i data-lucide="download" class="w-4 h-4"></i> Exportar
                </a>
            </div>
        </header>

        <!-- Views Container -->
        <div class="flex-1 overflow-auto p-6 relative" id="mainViewsContainer">
            <!-- Monthly View -->
            <div id="monthView" class="h-full flex flex-col">
                <div class="grid grid-cols-7 gap-4 mb-4">
                    <div class="text-center text-[10px] font-black text-gray-400 uppercase">Dom</div>
                    <div class="text-center text-[10px] font-black text-gray-400 uppercase">Lun</div>
                    <div class="text-center text-[10px] font-black text-gray-400 uppercase">Mar</div>
                    <div class="text-center text-[10px] font-black text-gray-400 uppercase">Mi√©</div>
                    <div class="text-center text-[10px] font-black text-gray-400 uppercase">Jue</div>
                    <div class="text-center text-[10px] font-black text-gray-400 uppercase">Vie</div>
                    <div class="text-center text-[10px] font-black text-gray-400 uppercase">S√°b</div>
                </div>
                <div id="calendarContainer" class="flex-1">
                    <!-- JS Rendered Month Grid -->
                </div>
            </div>

            <!-- Weekly View (Hidden by default) -->
            <div id="weekView" class="hidden h-full">
                <div class="flex h-full flex-col">
                    <!-- Week Header -->
                    <div class="grid grid-cols-8 gap-0 border-b border-gray-200 bg-white sticky top-0 z-10" id="weekHeader">
                        <!-- Time Column Header -->
                        <div class="p-3 border-r border-gray-100"></div>
                        <!-- Days Headers JS Rendered -->
                    </div>
                    <!-- Week Grid -->
                    <div class="flex-1 overflow-y-auto relative bg-white" id="weekGrid">
                        <!-- JS Rendered -->
                    </div>
                </div>
            </div>

            <!-- Daily View (Hidden by default) -->
            <div id="dayView" class="hidden h-full max-w-4xl mx-auto">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 flex flex-col h-full overflow-hidden">
                    <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                        <div>
                            <h3 class="text-lg font-black text-gray-900" id="dayViewTitle">-</h3>
                            <p class="text-xs text-gray-500 font-bold">Detalle de turnos</p>
                        </div>
                        <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-black" id="dayViewCount">0 Turnos</span>
                    </div>
                    <div class="flex-1 overflow-y-auto p-6 space-y-3" id="dayListContainer">
                        <!-- JS Rendered -->
                    </div>
                </div>
            </div>
        </div>
    </main>




<!-- CONFIRMATION MODAL -->
<div id="confirmationModal"
    class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[10010] backdrop-blur-sm transition-opacity duration-300 opacity-0">
    <div id="confirmModalContent"
        class="bg-white rounded-2xl shadow-2xl w-full max-w-sm transform scale-95 transition-all duration-300 p-6">
        <div class="text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                <i data-lucide="help-circle" class="w-6 h-6 text-blue-600"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-900" id="confirmTitle">Confirmar Acci√≥n</h3>
            <p class="text-xs text-gray-500 mt-2" id="confirmMessage">¬øEst√°s seguro de realizar esta acci√≥n?</p>
        </div>
        <div class="mt-6 flex gap-3">
            <button onclick="closeConfirmModal()"
                class="flex-1 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl text-xs font-bold transition-colors">
                Cancelar
            </button>
            <button id="confirmActionBtn"
                class="flex-1 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl text-xs font-bold transition-colors shadow-lg shadow-blue-500/30">
                Confirmar
            </button>
        </div>
        </div>
    </div>

    <!-- DETAIL MODAL -->
    <div id="detailModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[10000]">
        <div class="bg-white rounded-xl max-w-lg w-full p-8 relative max-h-[80vh] overflow-y-auto">
            <button onclick="document.getElementById('detailModal').classList.add('hidden')"
                class="absolute top-4 right-4 text-2xl text-gray-400">√ó</button>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- DAY DETAIL MODAL -->
    <div id="dayDetailOverlay" 
         style="display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 9998; backdrop-filter: blur(2px);"
         onclick="closeDayDetailPanel()"></div>
    
    <div id="dayDetailPanel"
         style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 800px; max-width: 95vw; max-height: 90vh; background-color: white; z-index: 9999; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border-radius: 16px; flex-direction: column; overflow: hidden;">
        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-blue-600 to-blue-500 text-white p-6 flex justify-between items-center">
            <div>
                <h3 class="text-2xl font-black" id="dayDetailDate">-</h3>
                <p class="text-sm opacity-90 font-medium" id="dayDetailSubtitle">Turnos del d√≠a</p>
            </div>
            <button onclick="event.stopPropagation(); closeDayDetailPanel()" class="hover:bg-white/20 rounded-lg p-2 transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- Modal Content -->
        <div class="flex-1 overflow-y-auto p-6 bg-gray-50" id="dayDetailContent">
            <p class="text-center text-gray-400 italic text-sm py-8">Cargando...</p>
        </div>
    </div>

    <!-- ERROR MODAL (Insufficient Slots) -->
    <div id="errorModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[10020] backdrop-blur-sm">
        <div class="bg-white rounded-2xl max-w-lg w-full p-0 overflow-hidden shadow-2xl transform transition-all scale-95 opacity-0"
            id="errorModalContainer">
            <div class="bg-red-50 p-6 flex items-center gap-4 border-b border-red-100">
                <div
                    class="size-12 bg-red-100 rounded-full flex items-center justify-center text-2xl text-red-600 animate-pulse">
                    ‚ö†Ô∏è
                </div>
                <div>
                    <h3 class="text-xl font-black text-red-900 uppercase tracking-tight">Capacidad Insuficiente</h3>
                    <p class="text-xs text-red-600 font-bold">No hay suficientes espacios para todos los turnos</p>
                </div>
            </div>

            <div class="p-8 space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                        <p class="text-[10px] font-black text-gray-400 uppercase mb-1">Slots Disponibles</p>
                        <p class="text-2xl font-black text-gray-800" id="errorSlotsGen">0</p>
                        <p class="text-[10px] text-gray-500 font-bold" id="errorDaysLab">0 d√≠as laborales</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                        <p class="text-[10px] font-black text-red-400 uppercase mb-1">Slots Faltantes</p>
                        <p class="text-2xl font-black text-red-600" id="errorSlotsMiss">0</p>
                        <p class="text-[10px] text-red-500 font-bold">Acci√≥n requerida</p>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between text-[10px] font-black uppercase mb-2">
                        <span class="text-gray-400">Cobertura del Plan</span>
                        <span class="text-blue-600" id="errorPercentText">0%</span>
                    </div>
                    <div class="w-full bg-gray-100 h-3 rounded-full overflow-hidden">
                        <div id="errorProgressBar"
                            class="h-full bg-gradient-to-r from-red-500 to-orange-500 transition-all duration-1000"
                            style="width: 0%"></div>
                    </div>
                </div>

                <div class="space-y-3">
                    <h4 class="text-[10px] font-black text-gray-500 uppercase tracking-widest">üí° Recomendaciones</h4>
                    <ul id="errorSuggestions" class="space-y-2">
                        <!-- Dynamic suggestions -->
                    </ul>
                </div>
            </div>

            <div class="p-6 bg-gray-50 border-t border-gray-100 flex gap-3">
                <button onclick="closeErrorModal()"
                    class="flex-1 py-3 bg-gray-800 text-white rounded-xl font-black text-xs uppercase tracking-widest hover:bg-black transition-all active:scale-95">
                    Entendido
                </button>
                <button onclick="closeErrorModal(); toggleConfig();"
                    class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-black text-xs uppercase tracking-widest hover:bg-blue-700 transition-all active:scale-95 shadow-lg shadow-blue-500/30">
                    ‚öôÔ∏è Ajustar Configuraci√≥n
                </button>
            </div>
        </div>
    </div>

    <!-- MANUAL TURN MODAL -->
    <div id="manualTurnModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[10020] backdrop-blur-sm transition-all duration-300">
        <div class="bg-white rounded-2xl max-w-lg w-full overflow-hidden shadow-2xl transform transition-all scale-95 opacity-0" id="manualTurnModalContainer">
            <!-- Modal Header -->
            <div class="bg-blue-600 p-6 flex items-center justify-between text-white">
                <div class="flex items-center gap-4">
                    <div class="p-3 bg-white/20 rounded-xl">
                        <i data-lucide="calendar-plus" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-black uppercase tracking-tight">Nuevo Turno Manual</h3>
                        <p class="text-xs font-bold opacity-80" id="manualTurnDateLabel">Asignar turno al cronograma</p>
                    </div>
                </div>
                <button onclick="closeManualTurnModal()" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="p-8 space-y-6 max-h-[70vh] overflow-y-auto custom-scrollbar">
                <!-- Responsable Info -->
                <div class="space-y-4">
                    <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="user" class="w-3.5 h-3.5 text-blue-500"></i> Datos del Responsable
                    </h4>
                    <div class="grid grid-cols-1 gap-4">
                        <div class="space-y-1.5">
                            <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Nombre Completo</label>
                            <input type="text" id="manualResponsableNombre" placeholder="Ej: Juan P√©rez" 
                                class="w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-xl text-sm font-bold text-gray-700 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Correo Electr√≥nico (Opcional)</label>
                            <input type="email" id="manualResponsableEmail" placeholder="juan.perez@empresa.com" 
                                class="w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-xl text-sm font-bold text-gray-700 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all">
                        </div>
                    </div>
                </div>

                <!-- Turno Details (Read-only pre-filled) -->
                <div class="grid grid-cols-2 gap-4 pt-2">
                    <div class="space-y-1.5">
                        <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Fecha Programada</label>
                        <input type="date" id="manualTurnFecha" readonly 
                            class="w-full px-4 py-3 bg-gray-100 border border-gray-100 rounded-xl text-sm font-black text-gray-400 cursor-not-allowed">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Hora Programada</label>
                        <input type="time" id="manualTurnHora" readonly 
                            class="w-full px-4 py-3 bg-gray-100 border border-gray-100 rounded-xl text-sm font-black text-gray-400 cursor-not-allowed">
                    </div>
                </div>

                <!-- Equipos List -->
                <div class="space-y-4 pt-4 border-t border-gray-100">
                    <div class="flex items-center justify-between">
                        <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest flex items-center gap-2">
                            <i data-lucide="cpu" class="w-3.5 h-3.5 text-blue-500"></i> Equipos a Mantener
                        </h4>
                        <button onclick="addManualEquipoRow()" class="text-[10px] font-black text-blue-600 uppercase hover:text-blue-700 flex items-center gap-1">
                            <i data-lucide="plus-circle" class="w-3 h-3"></i> A√±adir Equipo
                        </button>
                    </div>
                    
                    <div id="manualEquiposList" class="space-y-3">
                        <!-- Rows added via JS -->
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-6 bg-gray-50 border-t border-gray-100 flex gap-3">
                <button onclick="closeManualTurnModal()" 
                    class="flex-1 py-3 border border-gray-200 bg-white text-gray-500 rounded-xl font-black text-xs uppercase tracking-widest hover:bg-gray-100 transition-all active:scale-95">
                    Cancelar
                </button>
                <button onclick="submitManualTurn()" id="btnSubmitManualTurn"
                    class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-black text-xs uppercase tracking-widest hover:bg-blue-700 transition-all active:scale-95 shadow-lg shadow-blue-500/30 flex items-center justify-center gap-2">
                    <i data-lucide="save" class="w-4 h-4"></i> Crear Turno
                </button>
            </div>
        </div>
    </div>

    </div>
    {% endblock %}

    {% block extra_js %}
    <script>
        // Data from Django
            let turnos = [
        {% for t in turnos %}
        {
            id: {{ t.id }},
            responsable: "{{ t.responsable.nombre }}",
            fecha: "{{ t.fecha|date:'Y-m-d'|default:'' }}",
            hora: "{{ t.hora|time:'H:i'|default:'' }}",
            estado: "{{ t.estado }}",
            equipos: [
                {% for e in t.responsable.equipos.all %}
                {
                    id: {{ e.id }},
                    marca: "{{ e.marca }}",
                    modelo: "{{ e.modelo }}",
                    codigo: "{{ e.codigo }}",
                    descripcion: "{{ e.descripcion }}",
                    atendido: {{ e.atendido|yesno:"true,false" }}
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ]
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    let feriados = [
        {% for f in feriados %}
            "{{ f.fecha|date:'Y-m-d' }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    let config = {
        inicio: "{% if config %}{{ config.fecha_inicio|date:'Y-m-d' }}{% endif %}",
        fin: "{% if config %}{{ config.fecha_fin|date:'Y-m-d' }}{% endif %}",
        modo_exclusion: "{{ config.modo_exclusion|default:'weekends' }}",
    };

        let currentMonth = new Date();
        const togglingIds = new Set(); // Multi-click prevention
        if (config.inicio) {
            currentMonth = new Date(config.inicio + 'T00:00:00');
        }

        // --- GLOBAL HELPERS ---
        function getStatusBadgeHTML(estado) {
            let classes = "px-2 py-0.5 rounded-full text-[10px] font-black uppercase ";
            let label = estado;

            if (estado === 'completado') {
                classes += "bg-green-100 text-green-700";
                label = "Completado";
            } else if (estado === 'en_proceso') {
                classes += "bg-yellow-100 text-yellow-700";
                label = "En Proceso";
            } else {
                classes += "bg-blue-100 text-blue-700";
                label = "Pendiente";
            }

            return `<span class="${classes}">${label}</span>`;
        }

        function initCalendar() {
            const container = document.getElementById('calendarContainer');
            container.innerHTML = '';

            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            const header = document.createElement('div');
            header.className = 'flex justify-between items-center mb-6';
            header.innerHTML = `
            <h3 class="text-xl font-bold">${currentMonth.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }).toUpperCase()}</h3>
            <div class="flex gap-2">
                <button onclick="changeMonth(-1)" class="p-2 border rounded hover:bg-gray-100 transition">‚Üê</button>
                <button onclick="changeMonth(1)" class="p-2 border rounded hover:bg-gray-100 transition">‚Üí</button>
            </div>
        `;
            container.appendChild(header);

            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-7 gap-4';

            ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'].forEach(day => {
                const h = document.createElement('div');
                h.className = 'text-center font-bold text-gray-400 text-xs uppercase mb-2';
                h.textContent = day;
                grid.appendChild(h);
            });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Padding for days before month starts
            for (let i = 0; i < firstDay; i++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day other-month';
                grid.appendChild(cell);
            }

            // Render each day
            for (let d = 1; d <= daysInMonth; d++) {
                const cellDate = new Date(year, month, d);
                // Fix timezone issue by manually formatting YYYY-MM-DD
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const isWeekend = cellDate.getDay() === 0 || cellDate.getDay() === 6;
                const isHoliday = feriados.includes(dateStr);
                const isToday = new Date().toDateString() === cellDate.toDateString();
                const dayTurnos = turnos.filter(t => t.fecha === dateStr);
                const turnosCount = dayTurnos.length;

                const cell = document.createElement('div');
                cell.className = `calendar-day ${isWeekend ? 'weekend' : ''} ${isHoliday ? 'holiday' : ''} ${isToday ? 'today' : ''}`;
                cell.dataset.date = dateStr;

                // Click handler to open day detail panel
                if (!isWeekend && !isHoliday) {
                    cell.onclick = (e) => {
                        e.stopPropagation();
                        console.log('Click on day:', dateStr);
                        openDayDetailPanel(dateStr);
                    };
                    cell.style.cursor = 'pointer';
                }

                // Determine badge status based on overall day progress
                let badgeClass = 'shift-count-badge';
                if (turnosCount > 0) {
                    const allCompleted = dayTurnos.every(t => t.estado === 'completado');
                    const anyStarted = dayTurnos.some(t => t.estado !== 'asignado');

                    if (allCompleted) {
                        badgeClass += ' has-completed';
                    } else if (anyStarted) {
                        badgeClass += ' has-in-progress';
                    }
                }

                cell.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <span class="day-number font-bold text-lg">${d}</span>
                    <div class="flex flex-col items-end gap-1">
                        ${isHoliday ? '<span class="text-[8px] bg-yellow-400 text-yellow-900 px-1.5 py-0.5 rounded-full font-black">üéâ FERIADO</span>' : ''}
                        ${!isHoliday && turnosCount > 0 ? `<span class="${badgeClass}">${turnosCount}</span>` : ''}
                    </div>
                </div>
                <div class="flex-1 flex items-center justify-center">
                    ${!isHoliday && turnosCount > 0 ? '<p class="text-xs text-gray-400 font-medium">Click para ver detalles</p>' : ''}
                </div>
            `;

                // Setup drag and drop for day cells
                cell.ondragover = (e) => {
                    e.preventDefault();
                    cell.classList.add('drag-over');
                };

                cell.ondragleave = () => {
                    cell.classList.remove('drag-over');
                };

                cell.ondrop = (e) => {
                    e.preventDefault();
                    cell.classList.remove('drag-over');
                    handleDayDrop(e, dateStr);
                };

                grid.appendChild(cell);
            }

            container.appendChild(grid);
            lucide.createIcons();
        }

        function getDeviceIcon(equipos) {
            if (!equipos || equipos.length === 0) return 'help-circle';
            const marcas = equipos.map(e => (e.marca || '').toLowerCase());
            const descrip = equipos.map(e => (e.descripcion || '').toLowerCase());
            const allStr = marcas.join(' ') + ' ' + descrip.join(' ');

            if (allStr.includes('laptop') || allStr.includes('portatil')) return 'laptop';
            if (allStr.includes('impresora') || allStr.includes('printer')) return 'printer';
            if (allStr.includes('monitor') || allStr.includes('pantalla')) return 'monitor';
            if (allStr.includes('servidor') || allStr.includes('server')) return 'server';
            return 'pc-case';
        }

        function createCard(t) {
            let cardClass = "appointment-card transition-all";
            if (t.estado === 'completado') cardClass += " completed";
            else if (t.estado === 'en_proceso') cardClass += " in-progress";

            const card = document.createElement('div');
            card.className = cardClass;
            card.draggable = true;
            card.dataset.id = t.id;

            const deviceIcon = getDeviceIcon(t.equipos);
            const atendidos = t.equipos.filter(e => e.atendido).length;
            const total = t.equipos.length;
            const progressStr = `${atendidos}/${total}`;

            card.innerHTML = `
            <div class="flex justify-between text-[10px] font-bold opacity-90 mb-1">
                <span class="flex items-center gap-1"><i data-lucide="${getDeviceIcon(t.equipos)}" class="w-3 h-3"></i> ${t.hora}</span>
                <button onclick="toggleCompletado(${t.id}, event)" class="hover:scale-110 transition-transform" 
                        title="${t.estado === 'completado' ? 'Marcar pendiente' : 'Marcar listo'}">
                    <i data-lucide="${t.estado === 'completado' ? 'check-circle-2' : (t.estado === 'en_proceso' ? 'clock' : 'circle')}" class="w-4 h-4"></i>
                </button>
            </div>
            <div class="font-bold leading-tight mb-1 truncate text-xs uppercase">${t.responsable}</div>
            <div class="flex justify-between items-baseline text-[9px] opacity-90">
                <span>${progressStr} EQUIPOS</span>
                <button onclick="showDetails(${t.id}, event)" class="hover:underline font-bold flex items-center gap-0.5">
                    <i data-lucide="eye" class="w-2.5 h-2.5"></i> VER
                </button>
            </div>
        `;
            card.ondragstart = (e) => {
                e.dataTransfer.setData('text/plain', t.id);
                card.classList.add('dragging');
            };
            card.ondragend = () => card.classList.remove('dragging');

            // Soporte para intercambio (Swap)
            card.ondragover = (e) => {
                e.preventDefault();
                e.stopPropagation();
                card.classList.add('bg-blue-100', 'border-blue-400', 'scale-105');
            };
            card.ondragleave = () => {
                card.classList.remove('bg-blue-100', 'border-blue-400', 'scale-105');
            };
            card.ondrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                card.classList.remove('bg-blue-100', 'border-blue-400', 'scale-105');
                const draggedId = e.dataTransfer.getData('text/plain');
                if (draggedId != t.id) {
                    handleSwap(draggedId, t.id);
                }
            };

            return card;
        }

        function isDayExcluded(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const day = date.getDay(); // 0 Sun, 6 Sat
            
            if (config.modo_exclusion === 'weekends' && (day === 0 || day === 6)) return true;
            if (config.modo_exclusion === 'sundays' && day === 0) return true;
            return false;
        }

        function handleSwap(idA, idB) {
            const turnoA = turnos.find(t => t.id == idA);
            const turnoB = turnos.find(t => t.id == idB);

            // Validation for excluded days
            if (isDayExcluded(turnoB.fecha)) {
                showToast(`No puedes mover un turno al ${new Date(turnoB.fecha + 'T00:00:00').toLocaleDateString('es-ES', {weekday: 'long'})} (D√≠a excluido)`, 'error');
                return;
            }

            // Allow moving FROM excluded day (to fix mistakes), but check Target.
            // If swapping, both swap positions might matter, but usually dragging A to B means we want A to be on B's slot.

            showConfirmModal(
                'Intercambiar Turnos',
                `¬øEst√°s seguro de intercambiar los turnos de ${turnoA.responsable} y ${turnoB.responsable}?`,
                () => realizarIntercambio(idA, idB)
            );
        }

        async function realizarIntercambio(idA, idB) {
            try {
                const resp = await fetch('/turno/intercambiar/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': CSRF_TOKEN,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ turno_a_id: idA, turno_b_id: idB })
                });

                const data = await resp.json();
                if (resp.ok) {
                    showToast(data.message);
                    await refreshAllData();
                } else {
                    showToast(data.message || 'Error al intercambiar', 'error');
                }
            } catch (err) {
                showToast('Error de conexi√≥n', 'error');
            }
        }

        async function handleDrop(e) {
            e.preventDefault();
            const turnoId = e.dataTransfer.getData('text/plain');
            const newDate = e.currentTarget.closest('.calendar-day').dataset.date;

            if (!newDate) return;

            // AJAX update
            const resp = await fetch(`/turno/${turnoId}/actualizar/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': CSRF_TOKEN,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ fecha: newDate })
            });

            if (resp.ok) {
                const t = turnos.find(x => x.id == turnoId);
                t.fecha = newDate;
                initCalendar();
            }
        }

        // --- DAY DETAIL PANEL LOGIC ---
        async function openDayDetailPanel(dateStr) {
            console.trace('openDayDetailPanel called for:', dateStr);
            try {
                const panel = document.getElementById('dayDetailPanel');
                const overlay = document.getElementById('dayDetailOverlay');
                const content = document.getElementById('dayDetailContent');
                const titleEl = document.getElementById('dayDetailDate'); // Corrected ID

                if (!panel || !overlay || !content) return;
                content.dataset.currentDate = dateStr; // Store for refreshes
                const [y, m, d] = dateStr.split('-').map(Number);
                const date = new Date(y, m - 1, d);
                const formattedDate = date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                
                if (titleEl) titleEl.textContent = formattedDate.charAt(0).toUpperCase() + formattedDate.slice(1);

                // Show panel
                overlay.style.display = 'block';
                panel.style.display = 'flex';

                // Prevent instant close if overlay pops up under cursor
                overlay.style.pointerEvents = 'none';
                setTimeout(() => { overlay.style.pointerEvents = 'auto'; }, 300);
                
                // Render content
                const dayTurnos = turnos.filter(t => t.fecha === dateStr);
                
                if (dayTurnos.length === 0) {
                    content.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-gray-400 p-8 text-center">
                            <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mb-4 border-2 border-dashed border-gray-100">
                                <i data-lucide="calendar-plus" class="w-10 h-10 opacity-20"></i>
                            </div>
                            <h4 class="font-black text-gray-900 uppercase tracking-tight mb-2">D√≠a Disponible</h4>
                            <p class="text-xs font-medium leading-relaxed mb-6 max-w-[200px]">
                                No hay tareas programadas para esta fecha. ¬øDeseas a√±adir un turno?
                            </p>
                            <button onclick="openManualTurnModal('${dateStr}')" 
                                class="px-6 py-2.5 bg-blue-600 text-white rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-blue-700 transition-all active:scale-95 shadow-lg shadow-blue-500/20 flex items-center gap-2">
                                <i data-lucide="plus" class="w-3.5 h-3.5"></i> A√±adir Turno
                            </button>
                        </div>
                    `;
                } else {
                    content.innerHTML = '<div class="space-y-3"></div>';
                    const list = content.querySelector('div');
                    
                    dayTurnos.sort((a, b) => a.hora.localeCompare(b.hora));

                    dayTurnos.forEach(t => {
                        const card = document.createElement('div');
                        card.className = "bg-white border border-gray-200 p-4 rounded-xl shadow-sm hover:shadow-md transition-all";
                        card.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <span class="font-black text-gray-900">${t.hora}</span>
                                ${getStatusBadgeHTML(t.estado)}
                            </div>
                            <h4 class="font-bold text-gray-800 mb-1">${t.responsable}</h4>
                            <div class="text-xs text-gray-500 mb-3 flex items-center gap-2">
                                <i data-lucide="monitor" class="w-3 h-3"></i> ${t.equipos.length} Equipos
                            </div>
                            <div class="flex gap-2">
                                ${t.equipos.length > 1 ? `
                                <button onclick="event.stopPropagation(); event.preventDefault(); showDetails(${t.id}, event)" class="flex-1 py-1.5 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-100 transition">
                                    <i data-lucide="list-checks" class="w-3 h-3 inline"></i> Ver Equipos
                                </button>
                                ` : `
                                <button onclick="event.stopPropagation(); event.preventDefault(); toggleCompletado(${t.id}, event)" class="flex-1 py-1.5 bg-gray-50 hover:bg-gray-100 text-gray-600 rounded-lg text-xs font-bold transition">
                                    ${t.estado === 'completado' ? 'Reabrir' : 'Completar'}
                                </button>
                                <button onclick="event.stopPropagation(); event.preventDefault(); showDetails(${t.id}, event)" class="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-100 transition" title="Ver detalles">
                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                </button>
                                `}
                            </div>
                        `;
                        list.appendChild(card);
                    });
                }
                lucide.createIcons();

            } catch (err) {
                console.error('Error opening panel:', err);
                showToast('Error al abrir panel', 'error');
            }
        }

        function closeDayDetailPanel() {
            console.trace('closeDayDetailPanel called');
            const panel = document.getElementById('dayDetailPanel');
            const overlay = document.getElementById('dayDetailOverlay');

            if (panel) {
                panel.style.display = 'none';
                console.log('Panel hidden');
            } else {
                console.error('Panel element not found!');
            }
            if (overlay) {
                overlay.style.display = 'none';
                console.log('Overlay hidden');
            } else {
                console.error('Overlay element not found!');
            }
        }

        function createShiftCardForPanel(t) {
            let cardClass = "appointment-card mb-3";
            if (t.estado === 'completado') cardClass += " completed";
            else if (t.estado === 'en_proceso') cardClass += " in-progress";

            const card = document.createElement('div');
            card.className = cardClass;
            card.draggable = true;
            card.dataset.id = t.id;

            const atendidos = t.equipos.filter(e => e.atendido).length;
            const total = t.equipos.length;
            const progressStr = `${atendidos}/${total}`;

            card.innerHTML = `
            <div class="flex justify-between items-start mb-3">
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <i data-lucide="${getDeviceIcon(t.equipos)}" class="w-4 h-4"></i>
                        <span class="font-black text-base uppercase">${t.responsable}</span>
                    </div>
                    <div class="text-xs opacity-80">
                        <i data-lucide="clock" class="w-3 h-3 inline"></i> ${t.hora}
                    </div>
                </div>
                <button onclick="toggleCompletado(${t.id}, event)"
                        class="hover:scale-110 transition-transform p-2 rounded-lg hover:bg-white/50"
                        title="${t.estado === 'completado' ? 'Marcar pendiente' : 'Marcar listo'}">
                    <i data-lucide="${t.estado === 'completado' ? 'check-circle-2' : (t.estado === 'en_proceso' ? 'clock' : 'circle')}"
                       class="w-5 h-5"></i>
                </button>
            </div>

            <div class="bg-white/50 rounded-lg p-3 mb-3">
                <p class="text-[10px] font-bold text-gray-500 uppercase mb-2">Equipos (${progressStr})</p>
                <div class="space-y-1">
                    ${t.equipos.map(e => `
                        <div class="flex items-center justify-between text-xs py-1">
                            <span class="${e.atendido ? 'line-through opacity-60' : 'font-medium'}">${e.marca} ${e.modelo}</span>
                            <i data-lucide="${e.atendido ? 'check-circle-2' : 'circle'}"
                               class="w-3 h-3 ${e.atendido ? 'text-green-600' : 'text-gray-400'}"></i>
                        </div>
                    `).join('')}
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="showDetails(${t.id}, event)"
                        class="flex-1 py-2 bg-white/70 hover:bg-white rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-1.5">
                    <i data-lucide="eye" class="w-3 h-3"></i> Ver Detalles
                </button>
            </div>
        `;

            // Drag handlers
            card.ondragstart = (e) => {
                e.dataTransfer.setData('text/plain', t.id);
                card.classList.add('dragging');
                document.querySelectorAll('.calendar-day').forEach(day => {
                    if (!day.classList.contains('other-month') && !day.classList.contains('weekend')) {
                        day.classList.add('drag-source');
                    }
                });
            };

            card.ondragend = () => {
                card.classList.remove('dragging');
                document.querySelectorAll('.calendar-day').forEach(day => {
                    day.classList.remove('drag-source');
                });
            };

            return card;
        }

        async function handleDayDrop(e, newDate) {
            const turnoId = e.dataTransfer.getData('text/plain');
            if (!turnoId || !newDate) return;

            const turno = turnos.find(t => t.id == turnoId);
            if (turno && turno.fecha === newDate) return; // Same day, do nothing

            // Update via API
            const resp = await fetch(`/turno/${turnoId}/actualizar/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': CSRF_TOKEN,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ fecha: newDate })
            });

            if (resp.ok) {
                showToast(`Turno movido a ${newDate}`);
                await refreshAllData();

                // If panel is open, refresh it with the new date's shifts
                const panel = document.getElementById('dayDetailPanel');
                if (panel.style.display !== 'none' && panel.style.display !== '') {
                    openDayDetailPanel(newDate);
                }
            } else {
                showToast('Error al mover turno', 'error');
            }
        }

        async function toggleCompletado(id, e) {
            if (e) e.stopPropagation();
            id = Number(id);
            
            if (togglingIds.has(id)) {
                console.log('Debounce: Ignoring click for ID', id);
                return;
            }

            console.log('toggleCompletado (Optimistic) for ID:', id);
            
            // Find ALL instances of this ID (to handle potential duplicates from Django)
            const targetTurnos = turnos.filter(x => x.id === id);
            if (targetTurnos.length === 0) return;

            // Save old state for rollback
            const oldEstado = targetTurnos[0].estado;
            const nuevoEstado = (oldEstado === 'completado') ? 'asignado' : 'completado';

            // Optimistic update locally
            targetTurnos.forEach(t => t.estado = nuevoEstado);
            
            // Immediate UI Refresh
            console.log('Optimistic UI Refresh');
            updateUIOnly(); 

            try {
                togglingIds.add(id);
                const resp = await fetch(`/turno/${id}/toggle/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': CSRF_TOKEN }
                });

                if (resp.ok) {
                    const data = await resp.json();
                    // Final sync with backend reality
                    targetTurnos.forEach(t => {
                        t.estado = data.nuevo_estado;
                        if (data.equipos) {
                            data.equipos.forEach(eqResp => {
                                const eqLocal = t.equipos.find(e => e.id == eqResp.id);
                                if (eqLocal) eqLocal.atendido = eqResp.atendido;
                            });
                        }
                    });
                    updateUIOnly();
                } else {
                    // Rollback
                    targetTurnos.forEach(t => t.estado = oldEstado);
                    updateUIOnly();
                    showToast('Error en servidor', 'error');
                }
            } catch (err) {
                // Rollback
                targetTurnos.forEach(t => t.estado = oldEstado);
                updateUIOnly();
                showToast('Error de conexi√≥n', 'error');
            } finally {
                setTimeout(() => togglingIds.delete(id), 1000);
            }
        }

        // Helper to refresh all UI components without full data reload
        function updateUIOnly() {
            initCalendar();
            renderPendingAssets();
            updateStats();
            if (currentView === 'week') renderWeekView();
            if (currentView === 'day') renderDayView();
            
            // Update day detail panel if open for the date of the changed turno
            const content = document.getElementById('dayDetailContent');
            const panel = document.getElementById('dayDetailPanel');
            if (panel && panel.style.display !== 'none' && content.dataset.currentDate) {
                // Refresh content from local data
                const dateStr = content.dataset.currentDate;
                const dayTurnos = turnos.filter(t => t.fecha === dateStr);
                
                // We reuse the rendering logic from openDayDetailPanel but localized here
                // To keep it simple, we could re-call openDayDetailPanel(dateStr)
                // but let's avoid a recursive loop if openDayDetailPanel ever calls updateUIOnly
                renderDayDetailContentDirect(dateStr);
            }
            
            lucide.createIcons();
        }

        // Extracted rendering logic to allow refreshes without re-triggering open/close logic
        function renderDayDetailContentDirect(dateStr) {
            const content = document.getElementById('dayDetailContent');
            const dayTurnos = turnos.filter(t => t.fecha === dateStr);
            
            if (dayTurnos.length === 0) {
                content.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-400 p-8 text-center">
                        <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mb-4 border-2 border-dashed border-gray-100">
                            <i data-lucide="calendar-plus" class="w-10 h-10 opacity-20"></i>
                        </div>
                        <h4 class="font-black text-gray-900 uppercase tracking-tight mb-2">D√≠a Disponible</h4>
                        <p class="text-xs font-medium leading-relaxed mb-6 max-w-[200px]">
                            No hay tareas programadas para esta fecha. ¬øDeseas a√±adir un turno?
                        </p>
                        <button onclick="openManualTurnModal('${dateStr}')" 
                            class="px-6 py-2.5 bg-blue-600 text-white rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-blue-700 transition-all active:scale-95 shadow-lg shadow-blue-500/20 flex items-center gap-2">
                            <i data-lucide="plus" class="w-3.5 h-3.5"></i> A√±adir Turno
                        </button>
                    </div>
                `;
            } else {
                content.innerHTML = '<div class="space-y-3"></div>';
                const list = content.querySelector('div');
                dayTurnos.sort((a, b) => a.hora.localeCompare(b.hora));

                dayTurnos.forEach(t => {
                    const card = document.createElement('div');
                    card.className = "bg-white border border-gray-200 p-4 rounded-xl shadow-sm hover:shadow-md transition-all";
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <span class="font-black text-gray-900">${t.hora}</span>
                            ${getStatusBadgeHTML(t.estado)}
                        </div>
                        <h4 class="font-bold text-gray-800 mb-1">${t.responsable}</h4>
                        <div class="text-xs text-gray-500 mb-3 flex items-center gap-2">
                            <i data-lucide="monitor" class="w-3 h-3"></i> ${t.equipos.length} Equipos
                        </div>
                        <div class="flex gap-2">
                            ${t.equipos.length > 1 ? `
                            <button onclick="event.stopPropagation(); event.preventDefault(); showDetails(${t.id}, event)" class="flex-1 py-1.5 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-100 transition">
                                <i data-lucide="list-checks" class="w-3 h-3 inline"></i> Ver Equipos
                            </button>
                            ` : `
                            <button onclick="event.stopPropagation(); event.preventDefault(); toggleCompletado(${t.id}, event)" class="flex-1 py-1.5 bg-gray-50 hover:bg-gray-100 text-gray-600 rounded-lg text-xs font-bold transition">
                                ${t.estado === 'completado' ? 'Reabrir' : 'Completar'}
                            </button>
                            <button onclick="event.stopPropagation(); event.preventDefault(); showDetails(${t.id}, event)" class="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-100 transition" title="Ver detalles">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                            </button>
                            `}
                        </div>
                    `;
                    list.appendChild(card);
                });
            }
            lucide.createIcons();
        }

        function showDetails(id, e) {
            console.log('showDetails called for ID:', id);
            if (e) e.stopPropagation();
            const t = turnos.find(x => x.id == id);
            if (!t) {
                console.error('Turno not found for details:', id);
                return;
            }
            const modal = document.getElementById('detailModal');
            const content = document.getElementById('modalContent');

            if (!modal || !content) {
                console.error('Detail modal elements not found');
                return;
            }

            console.log('Opening modal with content for:', t.responsable);
            content.innerHTML = `
            <h3 class="text-2xl font-bold mb-4">${t.responsable}</h3>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="p-3 bg-gray-50 rounded">
                    <p class="text-[10px] font-bold text-gray-400 uppercase">Fecha</p>
                    <p class="font-bold text-sm">${t.fecha || 'Sin asignar'}</p>
                </div>
                <div class="p-3 bg-gray-50 rounded">
                    <p class="text-[10px] font-bold text-gray-400 uppercase">Hora</p>
                    <p class="font-bold text-sm">${t.hora || 'Sin asignar'}</p>
                </div>
            </div>
            <h4 class="text-xs font-bold text-gray-400 uppercase mb-3 text-blue-600">Equipos y Estado (${t.equipos.length})</h4>
            <div class="space-y-2">
                ${t.equipos.map(eq => `
                    <div class="p-3 border-l-4 ${eq.atendido ? 'border-green-500 bg-green-50/30' : 'border-blue-500 bg-blue-50/30'} flex justify-between items-center transition-all">
                        <div class="flex-1">
                            <p class="font-bold text-sm">${eq.marca} ${eq.modelo}</p>
                            <p class="text-[10px] text-gray-400 font-medium">ID: ${eq.codigo || 'S/N'}</p>
                            <p class="text-[10px] italic text-gray-500 mt-0.5">${eq.descripcion || ''}</p>
                        </div>
                        <button onclick="event.stopPropagation(); event.preventDefault(); toggleEquipo(${eq.id}, ${t.id}, event)" class="p-2 rounded-lg hover:bg-white transition shadow-sm active:scale-95 flex items-center gap-1.5 border border-transparent hover:border-gray-100">
                            <i data-lucide="${eq.atendido ? 'check-circle-2' : 'circle'}" class="w-4 h-4 ${eq.atendido ? 'text-green-600' : 'text-blue-600'}"></i>
                            <span class="text-[10px] font-black uppercase ${eq.atendido ? 'text-green-700' : 'text-blue-700'}">${eq.atendido ? 'LISTO' : 'PENDIENTE'}</span>
                        </button>
                    </div>
                `).join('')}
            </div>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        async function toggleEquipo(equipoId, turnoId, e) {
            if (e) e.stopPropagation();
            equipoId = Number(equipoId);
            turnoId = Number(turnoId);

            const turno = turnos.find(t => t.id === turnoId);
            if (!turno) return;
            const equipo = turno.equipos.find(e => e.id === equipoId);
            if (!equipo) return;

            // Optimistic update
            const oldAtendido = equipo.atendido;
            equipo.atendido = !oldAtendido;
            updateUIOnly();
            
            // Update the modal content immediately with optimistic state
            showDetails(turnoId);

            try {
                const resp = await fetch(`/equipo/${equipoId}/toggle-atendido/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': CSRF_TOKEN }
                });

                if (resp.ok) {
                    const data = await resp.json();
                    equipo.atendido = data.atendido;
                    if (data.turno_estado) {
                        turno.estado = data.turno_estado;
                    }
                    updateUIOnly();
                    // Refresh modal with server-confirmed state
                    showDetails(turnoId);
                } else {
                    equipo.atendido = oldAtendido;
                    updateUIOnly();
                    showDetails(turnoId);
                    showToast('Error en servidor', 'error');
                }
            } catch (err) {
                equipo.atendido = oldAtendido;
                updateUIOnly();
                showDetails(turnoId);
                showToast('Error de conexi√≥n', 'error');
            }
        }

        // --- MANUAL TURN LOGIC ---
        function openManualTurnModal(dateStr, timeStr = "08:00") {
            const modal = document.getElementById('manualTurnModal');
            const container = document.getElementById('manualTurnModalContainer');
            const fechaInput = document.getElementById('manualTurnFecha');
            const horaInput = document.getElementById('manualTurnHora');
            const dateLabel = document.getElementById('manualTurnDateLabel');
            const equipList = document.getElementById('manualEquiposList');

            if (!modal || !container || !fechaInput || !horaInput) return;

            // Reset Form
            document.getElementById('manualResponsableNombre').value = '';
            document.getElementById('manualResponsableEmail').value = '';
            equipList.innerHTML = '';
            addManualEquipoRow(); // Add one initial row

            // Pre-fill
            fechaInput.value = dateStr;
            horaInput.value = timeStr;
            
            const [y, m, d] = dateStr.split('-').map(Number);
            const dateObj = new Date(y, m - 1, d);
            dateLabel.textContent = dateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                container.classList.remove('scale-95', 'opacity-0');
                container.classList.add('scale-100', 'opacity-100');
            }, 10);
            
            // Close other panels if open
            closeDayDetailPanel();
            lucide.createIcons();
        }

        function closeManualTurnModal() {
            const modal = document.getElementById('manualTurnModal');
            const container = document.getElementById('manualTurnModalContainer');
            if (!modal || !container) return;

            container.classList.add('scale-95', 'opacity-0');
            container.classList.remove('scale-100', 'opacity-100');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 300);
        }

        function addManualEquipoRow() {
            const list = document.getElementById('manualEquiposList');
            const id = Date.now();
            const div = document.createElement('div');
            div.className = "bg-gray-50/50 border border-gray-100 p-4 rounded-xl space-y-3 relative group animate-in slide-in-from-top-1 fade-in duration-300";
            div.dataset.rowId = id;
            div.innerHTML = `
                <button onclick="this.parentElement.remove()" class="absolute top-2 right-2 p-1 text-gray-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100">
                    <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                </button>
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1">
                        <label class="text-[9px] font-bold text-gray-400 uppercase">Marca</label>
                        <input type="text" placeholder="Ej: Dell" class="manual-eq-marca w-full px-3 py-2 bg-white border border-gray-200 rounded-lg text-xs font-bold focus:border-blue-500 outline-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-bold text-gray-400 uppercase">Modelo</label>
                        <input type="text" placeholder="Ej: Latitude 5420" class="manual-eq-modelo w-full px-3 py-2 bg-white border border-gray-200 rounded-lg text-xs font-bold focus:border-blue-500 outline-none">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1">
                        <label class="text-[9px] font-bold text-gray-400 uppercase">C√≥digo Interno</label>
                        <input type="text" placeholder="Ej: CPN-001" class="manual-eq-codigo w-full px-3 py-2 bg-white border border-gray-200 rounded-lg text-xs font-bold focus:border-blue-500 outline-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-bold text-gray-400 uppercase">Descripci√≥n</label>
                        <input type="text" placeholder="Ej: Descripci√≥n del dispositivo" class="manual-eq-desc w-full px-3 py-2 bg-white border border-gray-200 rounded-lg text-xs font-bold focus:border-blue-500 outline-none">
                    </div>
                </div>
            `;
            list.appendChild(div);
            lucide.createIcons();
        }

        async function submitManualTurn(forceCreate = false) {
            const btn = document.getElementById('btnSubmitManualTurn');
            const nombre = document.getElementById('manualResponsableNombre').value.trim();
            const email = document.getElementById('manualResponsableEmail').value.trim();
            const fecha = document.getElementById('manualTurnFecha').value;
            const hora = document.getElementById('manualTurnHora').value;

            if (!nombre) {
                showToast('El nombre del responsable es obligatorio', 'error');
                return;
            }

            const equipos = [];
            document.querySelectorAll('#manualEquiposList > div').forEach(row => {
                const marca = row.querySelector('.manual-eq-marca').value.trim();
                const modelo = row.querySelector('.manual-eq-modelo').value.trim();
                const codigo = row.querySelector('.manual-eq-codigo').value.trim();
                const descripcion = row.querySelector('.manual-eq-desc').value.trim();
                
                if (marca || modelo || codigo) {
                    equipos.push({ marca, modelo, codigo, descripcion });
                }
            });

            if (equipos.length === 0) {
                showToast('Debes a√±adir al menos un equipo', 'error');
                return;
            }

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="w-4 h-4 animate-spin border-2 border-white/30 border-t-white rounded-full"></i> Cargando...';

                const payload = { nombre, email, fecha, hora, equipos };
                if (forceCreate) {
                    payload.force_create = true;
                }

                const resp = await fetch('/api/turnos/crear-manual/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': CSRF_TOKEN,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await resp.json();
                
                // Handle duplicate status
                if (data.status === 'duplicate') {
                    showConfirmModal(
                        '‚ö†Ô∏è Nombre Duplicado',
                        `${data.message}\n\nResponsable existente: ${data.existing_responsable.nombre}\nCorreo: ${data.existing_responsable.email}`,
                        () => submitManualTurn(true) // Retry with force_create=true
                    );
                    return;
                }
                
                if (resp.ok && data.status === 'ok') {
                    showToast('Turno creado con √©xito');
                    closeManualTurnModal();
                    await refreshAllData();
                } else {
                    showToast(data.message || 'Error al crear turn', 'error');
                }
            } catch (err) {
                showToast('Error de conexi√≥n', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> Crear Turno';
                lucide.createIcons();
            }
        }

        function renderPendingAssets() {
            const panel = document.getElementById('pendingAssetsPanel');
            if (!panel) return;

            const pendingItems = [];
            turnos.forEach(t => {
                if (t.estado !== 'completado') {
                    const total = t.equipos.length;
                    const atendidos = t.equipos.filter(e => e.atendido).length;

                    t.equipos.forEach(e => {
                        if (!e.atendido) {
                            pendingItems.push({
                                ...e,
                                responsable: t.responsable,
                                turnoId: t.id,
                                fecha: t.fecha,
                                hora: t.hora,
                                progreso: `${atendidos + 1}/${total}`,
                                enProceso: t.estado === 'en_proceso'
                            });
                        }
                    });
                }
            });

            // Sort by Date THEN Time sequence
            pendingItems.sort((a, b) => {
                if (a.fecha !== b.fecha) return a.fecha.localeCompare(b.fecha);
                return a.hora.localeCompare(b.hora);
            });

            if (pendingItems.length === 0) {
                panel.innerHTML = '<p class="text-[10px] text-gray-400 italic text-center py-4">Sin equipos pendientes</p>';
                return;
            }

            panel.innerHTML = pendingItems.map(p => {
                // Format date for better readability (e.g., "Lun 26")
                const d = new Date(p.fecha + 'T00:00:00');
                const dateStr = d.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' }).toUpperCase();

                return `
            <div class="p-3 border border-gray-200 bg-white rounded-xl shadow-sm hover:shadow-md transition-all duration-300">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex gap-1">
                        <span class="text-[9px] font-black bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full uppercase tracking-tighter border border-gray-200 flex items-center gap-1">
                            <i data-lucide="calendar" class="w-2.5 h-2.5"></i> ${dateStr}
                        </span>
                        <span class="text-[9px] font-black px-2 py-0.5 rounded-full uppercase tracking-tighter border flex items-center gap-1"
                              style="background: var(--blue-pastel); color: var(--blue-text); border-color: rgba(30, 64, 175, 0.1);">
                            <i data-lucide="clock" class="w-2.5 h-2.5"></i> ${p.hora}
                        </span>
                    </div>
                    <span class="text-[9px] font-black px-2 py-0.5 rounded-full uppercase tracking-tighter border flex items-center gap-1"
                          style="${p.enProceso ? 'background: var(--yellow-pastel); color: var(--yellow-text); border-color: rgba(146, 64, 14, 0.1);' : 'background: var(--bg-primary); color: var(--text-secondary); border-color: var(--border);'}">
                        <i data-lucide="${p.enProceso ? 'clock' : 'layers'}" class="w-2.5 h-2.5"></i> ${p.enProceso ? 'EN PROCESO' : `EQ. ${p.progreso}`}
                    </span>
                </div>
                <div class="flex gap-3 mb-2">
                    <div class="size-10 bg-gray-50 flex items-center justify-center rounded-lg flex-shrink-0 border border-gray-100">
                        <i data-lucide="${getDeviceIcon([p])}" class="w-5 h-5 text-gray-400"></i>
                    </div>
                    <div class="min-w-0 flex-1">
                        <p class="font-black text-gray-900 text-xs truncate uppercase">${p.responsable}</p>
                        <p class="text-[11px] font-bold text-gray-700 truncate">${p.marca} ${p.modelo}</p>
                        <p class="text-[9px] text-gray-400">ID: ${p.codigo || 'S/N'}</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 mt-3">
                    <button onclick="showDetails(${p.turnoId})" 
                            class="flex items-center justify-center gap-1.5 py-1.5 rounded-lg text-[9px] font-black uppercase tracking-wider transition-all active:scale-95 shadow-sm border"
                            style="background: var(--blue-pastel); color: var(--blue-text); border-color: rgba(30, 64, 175, 0.1);">
                        <i data-lucide="eye" class="w-3 h-3"></i> VER
                    </button>
                    <button onclick="toggleEquipo(${p.id}, ${p.turnoId})" 
                            class="flex items-center justify-center gap-1.5 py-1.5 rounded-lg text-[9px] font-black uppercase tracking-wider transition-all active:scale-95 shadow-sm border"
                            style="background: var(--green-pastel); color: var(--green-text); border-color: rgba(6, 95, 70, 0.1);">
                        <i data-lucide="check-circle-2" class="w-3 h-3"></i> LISTO
                    </button>
                </div>
            </div>
            `;
            }).join('');
            lucide.createIcons();
        }

        function handleUploadDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('bg-blue-50', 'border-blue-500');
        }

        function handleUploadDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('bg-blue-50', 'border-blue-500');
        }

        function handleUploadDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('bg-blue-50', 'border-blue-500');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('fileInput').files = files;
                submitUpload();
            }
        }

        async function submitUpload() {
            const input = document.getElementById('fileInput');
            if (input.files.length > 0) {
                const fileName = input.files[0].name;
                const fileNameDisplay = document.getElementById('fileName');
                const uploadText = document.getElementById('uploadText');

                fileNameDisplay.textContent = fileName;
                fileNameDisplay.classList.remove('hidden');
                uploadText.textContent = "Cargando archivo...";

                const formData = new FormData(document.getElementById('uploadForm'));
                formData.append('ajax', '1');

                try {
                    const resp = await fetch('{% url "upload_excel" %}', {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-CSRFToken': CSRF_TOKEN }
                    });
                    const data = await resp.json();
                    if (resp.ok) {
                        showToast(data.message || 'Archivo cargado con √©xito');
                        await refreshAllData();
                        // Sidebar is always visible now, no need to toggle
                        if (data.message) {
                           console.log('Upload success');
                        }
                    } else {
                        showToast(data.message || 'Error al cargar archivo', 'error');
                    }
                } catch (err) {
                    showToast('Error de conexi√≥n', 'error');
                } finally {
                    uploadText.textContent = "Arraste su Excel aqu√≠ o haga clic";
                    input.value = '';
                }
            }
        }

        async function refreshAllData() {
            try {
                const resp = await fetch('{% url "api_get_datos" %}');
                const data = await resp.json();

                // Actualizar variables globales
                turnos = data.turnos;
                feriados = data.feriados;
                config = data.config;

                if (config.inicio) {
                    currentMonth = new Date(config.inicio + 'T00:00:00');
                }

                // Refrescar UI
                updateCalendarView();
                updateStats();
                renderPendingAssets();
            } catch (err) {
                console.error('Error refreshing data:', err);
            }
        }
        function toggleConfig() {
            const container = document.getElementById('configContainer');
            const btnText = document.getElementById('toggleText');

            const isHidden = container.classList.contains('hidden');
            if (isHidden) {
                container.classList.remove('hidden');
                btnText.textContent = 'Cerrar';
            } else {
                container.classList.add('hidden');
                btnText.textContent = 'Reconfigurar';
            }
        }

        // --- UI HELPERS ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            if (!container) return;

            const toast = document.createElement('div');
            const config = {
                success: { icon: 'check-circle-2', style: 'background: var(--green-pastel); color: var(--green-text); border: 1px solid rgba(6, 95, 70, 0.2);' },
                error: { icon: 'alert-circle', style: 'background: var(--red-pastel); color: var(--red-text); border: 1px solid rgba(153, 27, 27, 0.2);' },
                info: { icon: 'info', style: 'background: var(--blue-pastel); color: var(--blue-text); border: 1px solid rgba(30, 64, 175, 0.2);' }
            };

            const cfg = config[type];
            toast.className = `px-6 py-3 rounded-xl shadow-xl font-black text-[10px] uppercase tracking-widest transform transition-all duration-300 translate-x-full opacity-0 pointer-events-auto flex items-center gap-3`;
            toast.style = cfg.style;
            toast.innerHTML = `<i data-lucide="${cfg.icon}" class="w-4 h-4"></i> <span>${message}</span>`;

            container.appendChild(toast);
            lucide.createIcons(); // Re-init for new toast

            // Trigger animation
            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
                toast.classList.add('translate-x-0', 'opacity-100');
            });

            // Auto-remove
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }

        async function guardarConfig(silent = false) {
            const formData = new FormData(document.getElementById('configForm'));
            try {
                const resp = await fetch('{% url "guardar_configuracion" %}', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': CSRF_TOKEN }
                });
                const data = await resp.json();
                if (resp.ok) {
                    if (!silent) showToast(data.message || 'Configuraci√≥n guardada');
                    return true;
                } else {
                    showToast(data.message || 'Error al guardar la configuraci√≥n', 'error');
                    return false;
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error de conexi√≥n', 'error');
                return false;
            }
        }

        function showConfirmModal(title, message, onConfirm) {
            const modal = document.getElementById('confirmationModal');
            const container = document.getElementById('confirmModalContent');
            const titleEl = document.getElementById('confirmTitle');
            const msgEl = document.getElementById('confirmMessage');
            const confirmBtn = document.getElementById('confirmActionBtn');

            titleEl.textContent = title;
            msgEl.textContent = message;

            // Remove old listeners to prevent multiple firings by cloning
            const newBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);

            newBtn.onclick = () => {
                closeConfirmModal();
                onConfirm();
            };

            modal.classList.remove('hidden');
            modal.classList.add('flex');

            setTimeout(() => {
                modal.classList.remove('opacity-0');
                container.classList.remove('scale-95');
                container.classList.add('scale-100');
            }, 10);
        }

        function closeConfirmModal() {
            const modal = document.getElementById('confirmationModal');
            const container = document.getElementById('confirmModalContent');

            modal.classList.add('opacity-0');
            container.classList.remove('scale-100');
            container.classList.add('scale-95');

            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 300);
        }

        async function generarCronograma() {
            showConfirmModal(
                'Confirmar Generaci√≥n',
                'Esto guardar√° la configuraci√≥n actual y redistribuir√° todos los turnos. ¬øDeseas continuar?',
                async () => {
                    try {
                        // 1. Save Config First
                        const saved = await guardarConfig(true); // silent save
                        if (!saved) return;

                        // 2. Generate
                        const resp = await fetch('{% url "generar_cronograma" %}', {
                            method: 'POST',
                            headers: { 'X-CSRFToken': CSRF_TOKEN }
                        });
                        const result = await resp.json();

                        if (resp.ok) {
                            showToast(result.message || 'Cronograma generado correctamente');
                            await refreshAllData();
                        } else {
                            if (result.data && result.data.error_type === 'insufficient_slots') {
                                showErrorModal(result.data);
                            } else if (result.data && result.data.error_type === 'no_pending_turns') {
                                showNoPendingModal();
                            } else {
                                showToast(result.data ? result.data.message : 'Error desconocido', 'error');
                            }
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        showToast('Error de conexi√≥n', 'error');
                    }
                }
            );
        }

        function showErrorModal(data) {
            const modal = document.getElementById('errorModal');
            const container = document.getElementById('errorModalContainer');

            document.getElementById('errorSlotsGen').textContent = data.slots_generados;
            document.getElementById('errorDaysLab').textContent = `${data.dias_laborables} d√≠as laborales`;
            document.getElementById('errorSlotsMiss').textContent = data.faltantes;

            const percent = Math.round((data.slots_generados / data.usuarios_pendientes) * 100);
            document.getElementById('errorPercentText').textContent = `${percent}%`;

            const suggestionsList = document.getElementById('errorSuggestions');
            suggestionsList.innerHTML = data.sugerencias.map(s => `
            <li class="flex items-start gap-2 text-xs text-gray-600 font-medium">
                <span class="text-blue-500 mt-0.5">‚Ä¢</span>
                ${s}
            </li>
        `).join('');

            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Animations
            setTimeout(() => {
                container.classList.remove('scale-95', 'opacity-0');
                container.classList.add('scale-100', 'opacity-100');
                document.getElementById('errorProgressBar').style.width = `${percent}%`;
            }, 10);
        }

        function closeErrorModal() {
            const modal = document.getElementById('errorModal');
            const container = document.getElementById('errorModalContainer');

            container.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 200);
        }

        function showNoPendingModal() {
            const modal = document.getElementById('noPendingModal');
            const container = document.getElementById('noPendingModalContainer');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                container.classList.remove('scale-95', 'opacity-0');
                container.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeNoPendingModal() {
            const modal = document.getElementById('noPendingModal');
            const container = document.getElementById('noPendingModalContainer');
            container.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 200);
        }

        function renderHolidays(dates) {
            const list = document.getElementById('holidaysList');
            if (!list) return;
            list.innerHTML = dates.map(date => {
                const [y, m, d] = date.split('-');
                return `
                <span class="bg-yellow-100 text-yellow-800 text-[9px] px-1.5 py-0.5 rounded-full font-bold flex items-center gap-1">
                    ${d}/${m}
                    <button onclick="removeFeriado('${date}')" class="hover:text-red-600">√ó</button>
                </span>
            `;
            }).join('');
        }

        async function addFeriado() {
            const input = document.getElementById('newHolidayDate');
            const date = input.value;
            if (!date) return;

            const resp = await fetch('{% url "add_feriado" %}', {
                method: 'POST',
                headers: { 'X-CSRFToken': CSRF_TOKEN, 'Content-Type': 'application/json' },
                body: JSON.stringify({ fecha: date })
            });
            const data = await resp.json();
            if (resp.ok) {
                renderHolidays(data.feriados);
                input.value = '';
                showToast('Feriado a√±adido');
            } else {
                showToast(data.message || 'Error', 'error');
            }
        }

        async function removeFeriado(date) {
            const resp = await fetch('{% url "remove_feriado" %}', {
                method: 'POST',
                headers: { 'X-CSRFToken': CSRF_TOKEN, 'Content-Type': 'application/json' },
                body: JSON.stringify({ fecha: date })
            });
            const data = await resp.json();
            if (resp.ok) {
                renderHolidays(data.feriados);
                showToast('Feriado eliminado', 'info');
            }
        }

        async function resetSystem() {
            showConfirmModal(
                '‚ö†Ô∏è Reiniciar Sistema',
                'ATENCI√ìN: Esto borrar√° permanentemente todo el historial, configuraciones y usuarios. Esta acci√≥n no se puede deshacer.',
                async () => {
                    try {
                        const resp = await fetch('{% url "reset_database" %}', {
                            method: 'POST',
                            headers: { 'X-CSRFToken': CSRF_TOKEN }
                        });
                        if (resp.ok) {
                            showToast('Sistema reiniciado. Recargando...', 'success');
                            setTimeout(() => location.reload(), 1500);
                        } else {
                            showToast('Error al reiniciar', 'error');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        showToast('Error de conexi√≥n', 'error');
                    }
                }
            );
        }

        function changeMonth(dir) {
            currentMonth.setMonth(currentMonth.getMonth() + dir);
            initCalendar();
        }

        function updateStats() {
            const done = turnos.filter(t => t.estado === 'completado').length;
            const pendingTotal = turnos.filter(t => t.estado !== 'completado').length;

            // Update all possible stat elements
            const elements = {
                'statDone': done,
                'statDoneCount': done,
                'statPendingCount': pendingTotal
            };

            for (const [id, val] of Object.entries(elements)) {
                const el = document.getElementById(id);
                if (el) el.textContent = val;
            }
        }

        // --- LAYOUT & VIEWS LOGIC ---
        function toggleSidebar() {
            const sidebar = document.getElementById('leftSidebar');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full', 'absolute', 'h-full', 'shadow-2xl');
                sidebar.classList.add('relative');
            } else {
                sidebar.classList.add('-translate-x-full', 'absolute', 'h-full', 'shadow-2xl');
                sidebar.classList.remove('relative');
            }
        }

        let currentView = 'month'; // 'month', 'week', 'day'

        function switchView(view) {
            currentView = view;
            
            // Buttons state
            ['month', 'week', 'day'].forEach(v => {
                const btn = document.getElementById(`btnView${v.charAt(0).toUpperCase() + v.slice(1)}`);
                if (v === view) {
                    btn.classList.remove('text-gray-500', 'bg-transparent');
                    btn.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
                } else {
                    btn.classList.add('text-gray-500', 'bg-transparent');
                    btn.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
                }
            });

            // Containers visibility
            document.getElementById('monthView').classList.add('hidden');
            document.getElementById('weekView').classList.add('hidden');
            document.getElementById('dayView').classList.add('hidden');
            
            document.getElementById(`${view}View`).classList.remove('hidden');

            // Header text
            const labels = { 'month': 'Vista Mensual', 'week': 'Vista Semanal', 'day': 'Vista Diaria' };
            document.getElementById('currentViewLabel').textContent = labels[view];

            // Render
            updateCalendarView();
        }

        function updateCalendarView() {
            // Update Date Display
            const dateDisplay = document.getElementById('calendarDateDisplay');
            
            if (currentView === 'month') {
                const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                dateDisplay.textContent = `${months[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;
                initCalendar(); // Existing render logic
            } else if (currentView === 'week') {
                renderWeekView();
            } else if (currentView === 'day') {
                renderDayView();
            }
        }

        function navigateCalendar(dir) {
            if (currentView === 'month') {
                currentMonth.setMonth(currentMonth.getMonth() + dir);
            } else if (currentView === 'week') {
                currentMonth.setDate(currentMonth.getDate() + (dir * 7));
            } else if (currentView === 'day') {
                currentMonth.setDate(currentMonth.getDate() + dir);
            }
            updateCalendarView();
        }

        // --- WEEK VIEW IMPLEMENTATION ---
        function renderWeekView() {
            const container = document.getElementById('weekGrid');
            const header = document.getElementById('weekHeader');
            const dateDisplay = document.getElementById('calendarDateDisplay');

            // Find start of week (Sunday)
            const startOfWeek = new Date(currentMonth);
            startOfWeek.setDate(currentMonth.getDate() - currentMonth.getDay());
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            dateDisplay.textContent = `${startOfWeek.getDate()} ${startOfWeek.toLocaleString('es-ES', { month: 'short' })} - ${endOfWeek.getDate()} ${endOfWeek.toLocaleString('es-ES', { month: 'short' })}`;

            // Render Header
            let headerHTML = '<div class="p-3 border-r border-gray-100 text-[10px] text-gray-400 font-bold text-center">HORA</div>';
            const weekDays = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(startOfWeek);
                d.setDate(startOfWeek.getDate() + i);
                weekDays.push(d);
                const isToday = new Date().toDateString() === d.toDateString();
                headerHTML += `
                    <div class="p-2 text-center border-r border-gray-100 cursor-pointer hover:bg-gray-100 transition ${isToday ? 'bg-blue-50' : ''}"
                         onclick="event.stopPropagation(); openDayDetailPanel('${d.toISOString().split('T')[0]}')">
                        <div class="text-[10px] font-bold text-gray-400 uppercase">${d.toLocaleString('es-ES', { weekday: 'short' })}</div>
                        <div class="text-lg font-black ${isToday ? 'text-blue-600' : 'text-gray-900'}">${d.getDate()}</div>
                    </div>
                `;
            }
            header.innerHTML = headerHTML;

            // Render Grid (Time slots 8am - 6pm)
            let gridHTML = '';
            for (let hour = 8; hour <= 18; hour++) {
                const timeStr = `${hour.toString().padStart(2, '0')}:00`;
                gridHTML += `<div class="grid grid-cols-8 border-b border-gray-100 min-h-[80px]">`;
                gridHTML += `<div class="p-2 text-center text-xs text-gray-400 font-bold border-r border-gray-100 sticky left-0 bg-white">${timeStr}</div>`;
                
                for (let i = 0; i < 7; i++) {
                    const d = weekDays[i];
                    const dStr = d.toISOString().split('T')[0];
                    const slotTurnos = turnos.filter(t => t.fecha === dStr && t.hora.startsWith(hour.toString().padStart(2, '0')));
                    
                    const isExcluded = isDayExcluded(dStr);
                    const cellClass = isExcluded ? "bg-gray-100/50" : "hover:bg-gray-50 cursor-pointer";
                    // Remove handleDayDrop to enforce Swap-Only in Weekly View
                    // Only keep onclick for opening day panel if user clicks the cell background
                    const interactionHandlers = isExcluded ? "" : `onclick="if(event.target === this) openManualTurnModal('${dStr}', '${timeStr}')"`;

                    gridHTML += `<div class="p-1 border-r border-gray-100 relative group transition-colors ${cellClass}"
                                     ${interactionHandlers} title="${isExcluded ? 'D√≠a no laborable' : 'Haga clic para a√±adir turno en esta hora'}">`;
                    
                    slotTurnos.forEach(t => {
                        const icon = getDeviceIcon(t.equipos);
                        
                        // Calculate status dynamically for immediate feedback
                        const total = t.equipos.length;
                        const atendidos = t.equipos.filter(e => e.atendido).length;
                        let statusColor = 'blue';
                        let isDone = false;

                        if (total > 0 && atendidos === total) {
                            statusColor = 'green';
                            isDone = true;
                        } else if (atendidos > 0) {
                            statusColor = 'yellow';
                        }

                        const bgClass = {
                            'green': 'bg-green-100 border-green-200 hover:border-green-400',
                            'yellow': 'bg-yellow-100 border-yellow-200 hover:border-yellow-400',
                            'blue': 'bg-blue-100 border-blue-200 hover:border-blue-400'
                        }[statusColor];

                        const textClass = {
                            'green': 'text-green-800',
                            'yellow': 'text-yellow-800',
                            'blue': 'text-blue-800'
                        }[statusColor];

                        const iconClass = {
                            'green': 'text-green-600',
                            'yellow': 'text-yellow-600',
                            'blue': 'text-blue-600'
                        }[statusColor];

                        gridHTML += `
                            <div class="${bgClass} border p-1.5 rounded-lg mb-1 cursor-grab active:cursor-grabbing shadow-sm text-[10px] hover:shadow-md transition-all group relative pr-6" 
                                 draggable="true" 
                                 ondragstart="event.dataTransfer.setData('text/plain', '${t.id}')"
                                 ondragover="event.preventDefault()"
                                 ondrop="event.stopPropagation(); event.preventDefault(); handleSwap(event.dataTransfer.getData('text/plain'), ${t.id})"
                                 onclick="event.stopPropagation(); showDetails(${t.id}, event)">
                                <div class="font-bold ${textClass} truncate">${t.responsable}</div>
                                <div class="flex items-center gap-1 ${iconClass} mt-0.5">
                                    <i data-lucide="${icon}" class="w-3 h-3"></i> ${t.hora}
                                    <span class="font-bold opacity-80 text-[9px] ml-1">¬∑ ${t.equipos.length} eq.</span>
                                </div>
                                <button onclick="event.stopPropagation(); ${t.equipos.length > 1 ? `showDetails(${t.id}, event)` : `toggleCompletado(${t.id}, event)`}" 
                                        class="absolute top-1.5 right-1.5 p-0.5 rounded-full hover:bg-white/50 transition-colors ${isDone ? 'text-green-600' : 'text-gray-400 hover:text-blue-600'}">
                                    <i data-lucide="${isDone ? 'check-circle-2' : (t.equipos.length > 1 ? 'list-checks' : 'circle')}" class="w-3.5 h-3.5"></i>
                                </button>
                            </div>
                        `;
                    });
                    
                    gridHTML += `</div>`;
                }
                gridHTML += `</div>`;
            }
            container.innerHTML = gridHTML;
            lucide.createIcons();
        }

        // --- DAY VIEW IMPLEMENTATION ---
        function renderDayView() {
            const container = document.getElementById('dayListContainer');
            const title = document.getElementById('dayViewTitle');
            const countBadge = document.getElementById('dayViewCount');
            const dateDisplay = document.getElementById('calendarDateDisplay');

            const dStr = currentMonth.toISOString().split('T')[0];
            dateDisplay.textContent = currentMonth.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            
            title.textContent = dateDisplay.textContent.toUpperCase();

            const dayTurnos = turnos.filter(t => t.fecha === dStr);
            dayTurnos.sort((a, b) => a.hora.localeCompare(b.hora)); // Sort by time

            countBadge.textContent = `${dayTurnos.length} Turnos`;

            if (dayTurnos.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-gray-400 p-8 text-center border-2 border-dashed border-gray-100 rounded-2xl bg-gray-50/30">
                        <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mb-4 shadow-sm">
                            <i data-lucide="calendar-plus" class="w-10 h-10 text-blue-500 opacity-40"></i>
                        </div>
                        <h4 class="font-black text-gray-900 uppercase tracking-tight mb-2">D√≠a Disponible</h4>
                        <p class="text-sm font-medium leading-relaxed mb-6 max-w-sm">
                            No hay tareas programadas para esta fecha. ¬øDeseas a√±adir un turno manual?
                        </p>
                        <button onclick="openManualTurnModal('${dStr}')" 
                                class="px-8 py-3 bg-blue-600 text-white rounded-xl font-black text-xs uppercase tracking-widest hover:bg-blue-700 transition-all active:scale-95 shadow-lg shadow-blue-500/20 flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i> A√±adir Turno Ahora
                        </button>
                    </div>
                `;
            } else {
                container.innerHTML = dayTurnos.map(t => `
                    <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-xl border border-gray-100 hover:border-blue-300 transition-all group">
                        <div class="text-center min-w-[60px]">
                            <span class="block text-lg font-black text-gray-900">${t.hora}</span>
                            <span class="text-[10px] uppercase font-bold text-gray-400">Hora</span>
                        </div>
                        <div class="w-px h-12 bg-gray-200"></div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold text-gray-900 text-lg">${t.responsable}</h4>
                                ${getStatusBadgeHTML(t.estado)}
                            </div>
                            <div class="flex items-center gap-4 mt-2 text-sm text-gray-600">
                                <span class="flex items-center gap-1.5 font-medium"><i data-lucide="${getDeviceIcon(t.equipos)}" class="w-4 h-4"></i> ${t.equipos.length} Equipos</span>
                            </div>
                            <div class="mt-3 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="showDetails(${t.id}, event)" class="px-3 py-1.5 bg-white border border-gray-200 rounded-lg text-xs font-bold hover:bg-gray-50 text-gray-700">Ver Detalles</button>
                                ${t.equipos.length > 1 ? `
                                <button onclick="showDetails(${t.id}, event)" class="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-bold hover:bg-blue-700 flex items-center gap-1.5">
                                    <i data-lucide="list-checks" class="w-3 h-3"></i> Ver Equipos
                                </button>
                                ` : `
                                <button onclick="toggleCompletado(${t.id}, event)" class="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-bold hover:bg-blue-700">
                                    ${t.estado === 'completado' ? 'Reabrir' : 'Marcar Listo'}
                                </button>
                                `}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        window.onload = () => {
            initCalendar();
            updateStats();
            renderPendingAssets();
        };
    </script>
    {% endblock %}